<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Modal Architect ‚Äî Contumance</title>
  <meta name="description" content="Design harmonic structures from scale geometry. Choose a mode, a root, write degrees, and craft playable guitar inversions." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚ô™</text></svg>">
  <link rel="stylesheet" href="assets/kindle.css">

  <style>
    .controls{ display:grid; gap:8px; align-items:center; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); margin-bottom:8px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; opacity:.9; display:block; }
    input[type="text"], select, button{
      appearance:none; border:1px solid var(--accent); background:transparent; color:var(--ink);
      padding:10px 12px; border-radius:.5rem; font-family:inherit; font-size:14px; line-height:1; min-width:0; outline:none;
    }
    button.primary{ background:var(--ink); color:var(--paper); border-color:var(--ink); }
    button:focus-visible, input[type="text"]:focus-visible, select:focus-visible{ outline:2px dashed var(--accent); outline-offset:2px; }

    .cards{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); margin-top:12px; }
    .card{ border:1px solid var(--accent); border-radius:.6rem; padding:.85rem; background:transparent; }
    .titleline{ display:flex; align-items:baseline; justify-content:space-between; gap:.5rem; }
    .deg{ font-weight:700; letter-spacing:.03em; }
    .name{ font-variant:small-caps; font-weight:600; }
    .card .meta{ color:var(--muted); font-size:.85rem; display:flex; gap:.6rem; flex-wrap:wrap; margin:.35rem 0 .55rem; }

    .controls-row{ display:flex; gap:.4rem; flex-wrap:wrap; align-items:center; margin:.25rem 0 .55rem; }
    .chip{ border:1px solid var(--accent); border-radius:999px; padding:.2rem .6rem; font-size:.8rem; color:var(--muted); }
    .iconbtn{ border:1px solid var(--accent); background:transparent; color:inherit; width:2.1rem; height:2.1rem; border-radius:.5rem; cursor:pointer; }

    .hint{
      font-size: .8rem;
      color: var(--muted);
      font-style: italic;
      opacity: .85;
      margin-top: .25rem;
      padding-left: .7rem;
      border-left: 1px dashed var(--accent-soft);
      line-height: 1.4;
    }

    .fb svg{ max-width:100%; height:auto; display:block; }
    .fb-grid line{ stroke:var(--rule); stroke-width:1; }
    .fb-grid .nut{ stroke:var(--ink); stroke-width:3; }
    .fb-note circle{ fill:var(--ink); }
    .fb-note text{ font-size:10px; font-weight:700; fill:var(--paper); }
    .fb-grid text{ fill:var(--muted); }
    html.theme-dark .fb-grid text{ fill:var(--ink); opacity:.85; }
    html.theme-dark .fb-grid line{ stroke:#3b3a34; }
    html.theme-dark .fb-note text{ fill:var(--paper); font-weight:800; }
  </style>
</head>
<body>
  <main>
    <div class="topbar">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="index.html">‚Üê Back to index</a>
      </nav>
      <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme" title="Toggle theme">üåì</button>
    </div>
    
    <header>
      <h1>The Modal Architect</h1>
      <div class="subtitle">Design harmonic structures from scale geometry. Choose a mode, a root, write degrees, and pick inversions.</div>
      <div class="note" style="font-size:0.85rem; color:var(--muted); margin-top:.25rem;">
        Concept inspired by <em>@nickitus</em>.
      </div>
    </header>

    <details class="panel" open>
      <summary>Controls</summary>
      <div class="panel-body">
        <div class="controls" role="group" aria-label="Modal progression controls">
          <!-- NEW: Preset selector -->
          <div>
            <label for="preset">Preset progressions by style</label>
            <select id="preset" aria-label="Choose a preset progression"></select>
            <div class="hint">Choosing a preset will set <em>Root</em>, <em>Mode</em>, and <em>Progression</em> automatically. You can still edit them.</div>
          </div>

          <div>
            <label for="progression">Progression (roman degrees)</label>
            <input id="progression" type="text" placeholder="I - IV - VII - iii" value="I - IV - VII - iii" />
            <div class="hint">Supports accidentals: <code>#iv</code>, <code>bVII</code>, <code>vii¬∞</code>. Use dashes, commas, or spaces.</div>
          </div>

          <div>
            <label for="root">Root / Tonic</label>
            <select id="root"></select>
          </div>

          <div>
            <label for="mode">Mode</label>
            <select id="mode">
              <option>Ionian</option><option>Dorian</option><option>Phrygian</option>
              <option selected>Lydian</option><option>Mixolydian</option>
              <option>Aeolian</option><option>Locrian</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button class="primary" id="go" type="button">Generate</button>
          <button id="example" type="button">Example: C Lydian ‚Äî I IV VII iii</button>
        </div>
      </div>
    </details>

    <section id="results" class="cards" aria-live="polite"></section>

    <p class="hint" style="margin-top:.5rem">Tip: use ‚óÄ ‚ñ∂ to change inversion and ‚ñ≤ ‚ñº to move the position on the focused card.</p>
    
    <footer>
      <a class="btn" href="https://buymeacoffee.com/Contumance" target="_blank" rel="noopener noreferrer"
        aria-label="Support this library on Buy Me a Coffee">
        <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 8h14.5a2 2 0 0 1 0 4H18l-1 5a4 4 0 0 1-3.95 3.3H8.95A4 4 0 0 1 5 17l-1-9z"/>
          <path d="M3 8h17"/><path d="M7 4h6"/>
        </svg>
        <span>Buy me a coffee</span>
      </a>

      <span class="note">Concept inspired by <em>@nickitus</em>.</span>
      <span class="note">Fuel the craft. Inspire the next page.</span>
      <span>¬© <span id="y"></span> Re:sonance <small class="byline">by <em>Contumance</em></small></span>
    </footer>
    
  </main>

  <!-- Theme toggle -->
  <script>
    (function () {
      const KEY='theme-preference', root=document.documentElement, btn=document.getElementById('themeToggle');
      function setIcon(){ btn.textContent='‚óë'; } function apply(m){ root.classList.toggle('theme-dark', m==='dark'); setIcon(); }
      function pref(){ const s=localStorage.getItem(KEY); if(s==='light'||s==='dark') return s; return matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'; }
      let cur=pref(); apply(cur);
      btn.addEventListener('click', ()=>{ cur=cur==='dark'?'light':'dark'; localStorage.setItem(KEY,cur); apply(cur); });
      document.getElementById('y').textContent=new Date().getFullYear();
    })();
  </script>

  <!-- App logic (SVG fretboards unified with The Chords Book) -->
  <script>
    /* ---------- Theory ---------- */
    const NOTES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const PC=Object.fromEntries(NOTES.map((n,i)=>[n,i]));
    const DEG = {0:'R',1:'‚ô≠2',2:'2',3:'‚ô≠3',4:'3',5:'4',6:'‚ô≠5',7:'5',8:'‚ôØ5',9:'6',10:'‚ô≠7',11:'7'};

    // Guitar tuning pitch-classes 6..1 (E A D G B E)
    const TUNING_PC = [4,9,2,7,11,4];

    // String labels in Guitar Pro order (top to bottom): e B G D A E
    const STRING_LABELS = ['e','B','G','D','A','E'];

    const MODES={
      "Ionian":[0,2,4,5,7,9,11],
      "Dorian":[0,2,3,5,7,9,10],
      "Phrygian":[0,1,3,5,7,8,10],
      "Lydian":[0,2,4,6,7,9,11],
      "Mixolydian":[0,2,4,5,7,9,10],
      "Aeolian":[0,2,3,5,7,8,10],
      "Locrian":[0,1,3,5,6,8,10]
    };
    const wrap=n=>((n%12)+12)%12;

    function scalePCs(rootPC,mode){ return MODES[mode].map(s=>wrap(rootPC+s)); }
    function triadForDegree(scale,i){ return [ scale[i%7], scale[(i+2)%7], scale[(i+4)%7] ]; }
    function qualityOfTriad([r,t,f]){
      const d3=wrap(t-r), d5=wrap(f-r);
      if(d3===4 && d5===7) return 'maj';
      if(d3===3 && d5===7) return 'min';
      if(d3===3 && d5===6) return 'dim';
      if(d3===4 && d5===8) return 'aug';
      return '';
    }

    // Roman degrees
    const ROMAN_MAP={i:1,ii:2,iii:3,iv:4,v:5,vi:6,vii:7};
    function parseDegreeToken(tok){
      tok=tok.trim();
      let acc=0; if(tok[0]==='#'){acc=+1; tok=tok.slice(1);} if(tok[0]==='b'||tok[0]==='B'){acc=-1; tok=tok.slice(1);}
      const dim=/¬∞/.test(tok); const base=tok.toLowerCase().replace(/[¬∞\+]/g,''); const n=ROMAN_MAP[base]||1;
      return {degree:n,accidental:acc,isDim:dim,raw:tok};
    }
    function cleanTokens(str){ return str.split(/[\s,\-‚Äì‚Äî]+/).filter(Boolean); }
    const romanToIdx = d => (d-1+7)%7;

    // Helpers for strings and frets
    function noteAt(stringNo,fret){ const idx={6:0,5:1,4:2,3:3,2:4,1:5}[stringNo]; return wrap(TUNING_PC[idx]+fret); }

    /* ---------- Build 4-3-2 close triad then extend to 6 strings ---------- */
    function findCloseTriad(triadPCs, inversion=0, startF=0){
      const bassIdx=[0,1,2][inversion];
      for(let f4=startF; f4<=12; f4++){
        if(noteAt(4,f4)!==triadPCs[bassIdx]) continue;
        const rest=[0,1,2].filter(i=>i!==bassIdx);
        let best=null, spanBest=99;
        for(let f3=Math.max(0,f4-4); f3<=Math.min(15,f4+6); f3++){
          if(!rest.some(i=>noteAt(3,f3)===triadPCs[i])) continue;
          for(let f2=Math.max(0,Math.min(f3,f4)-4); f2<=Math.min(15,Math.max(f3,f4)+6); f2++){
            if(!rest.some(i=>noteAt(2,f2)===triadPCs[i])) continue;
            const span=Math.max(f4,f3,f2)-Math.min(f4,f3,f2);
            if(span<=5 && span<spanBest){ spanBest=span; best={f4,f3,f2}; }
          }
        }
        if(best) return best;
      }
      return null;
    }
    function chooseFretForString(stringNo, triadPCs, base){
      const center=base+2.5, prio=[0,1,2]; // prefer R‚Üí3‚Üí5
      let best=null, bestRank=99, bestDist=1e9;
      for(let f=base; f<=base+5; f++){
        const pc=noteAt(stringNo,f); const idx=triadPCs.indexOf(pc); if(idx===-1) continue;
        const rank=prio.indexOf(idx), dist=Math.abs(f-center);
        if(rank<bestRank || (rank===bestRank && dist<bestDist)){ best=f; bestRank=rank; bestDist=dist; }
      }
      return best;
    }
    function extendToSixStrings(triadPCs, voicing432){
      const minF=Math.min(voicing432.f4,voicing432.f3,voicing432.f2);
      const base=Math.floor(minF/4)*4;
      const frets={6:null,5:null,4:voicing432.f4,3:voicing432.f3,2:voicing432.f2,1:null};
      frets[6]=chooseFretForString(6,triadPCs,base);
      frets[5]=chooseFretForString(5,triadPCs,base);
      frets[1]=chooseFretForString(1,triadPCs,base);
      return {base, frets};
    }

    /* ---------- SVG renderer (Guitar Pro style: top=1st string "e") ---------- */
    function svgMiniFretboard(fullVoicing, labelsMode, triadPCs, startFOverride){
      const strings=6;
      const startF = startFOverride ?? fullVoicing.base;
      const maxF = Math.max(...Object.values(fullVoicing.frets).filter(f=>f!=null));
      const fretsCount = Math.max(3, (maxF - startF) + 1);
      const x0=70, y0=46, dx=44, dy=24, w=fretsCount*44+96, h=strings*24+76;

      const g=[];
      g.push(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}">`);
      g.push(`<g class="fb-grid">`);

      // Draw 6 horizontal lines; label top-to-bottom as e B G D A E
      for(let r=0; r<strings; r++){
        const y=y0 + r*dy;
        g.push(`<line x1="${x0}" y1="${y}" x2="${x0+fretsCount*dx}" y2="${y}" />`);
        g.push(`<text x="${x0-15}" y="${y+4}" font-size="10" text-anchor="end">${STRING_LABELS[r]}</text>`);
      }

      // Vertical fret lines
      for(let f=0; f<=fretsCount; f++){
        const x=x0+f*dx; const isNut=(startF===0 && f===1);
        g.push(`<line x1="${x}" y1="${(y0 - dy/2)}" x2="${x}" y2="${(y0 + (strings-1)*dy + dy/2)}" class="${isNut?'nut':''}" />`);
      }
      // Fret numbers above
      for(let c=0; c<fretsCount; c++){
        const x=x0+(c+0.5)*dx; const label=startF+c;
        g.push(`<text x="${x}" y="${(y0 - dy/1.3)}" font-size="10" text-anchor="middle">${label}</text>`);
      }
      g.push(`</g>`);

      g.push(`<g class="fb-note">`);
      // Plot notes with string 1 at the TOP (row 0), string 6 at the BOTTOM (row 5)
      for(let s=1; s<=6; s++){
        const fret=fullVoicing.frets[s];
        if(fret==null) continue;
        const row = s - 1;
        const cx=x0+(fret - startF + 0.5)*dx;
        const cy=y0 + row*dy;
        let label='';
        if(labelsMode==='notes'){
          const pc = noteAt(s, fret);
          label = NOTES[pc];
        }else if(labelsMode==='degrees'){
          const pc = noteAt(s, fret);
          const rel = (pc - triadPCs[0] + 12) % 12; // relative to triad root
          label = DEG[rel] || '';
        }
        g.push(`<circle cx="${cx}" cy="${cy}" r="10.5"></circle>`);
        if(label) g.push(`<text x="${cx}" y="${cy+3}" text-anchor="middle">${label}</text>`);
      }
      g.push(`</g>`);
      g.push(`</svg>`);
      return g.join('');
    }

    /* ---------- Presets ---------- */
    const PRESETS = [
      // Rock / Pop
      { id:'pop4', group:'Rock / Pop', label:'Four-chord pop ‚Äî I V vi IV (C Ionian)', root:'C', mode:'Ionian', progression:'I V vi IV' },
      { id:'pop_vi', group:'Rock / Pop', label:'vi IV I V (C Ionian)', root:'C', mode:'Ionian', progression:'vi IV I V' },
      { id:'pop_145', group:'Rock / Pop', label:'I IV V (C Ionian)', root:'C', mode:'Ionian', progression:'I IV V' },

      // Jazz
      { id:'jazz_251', group:'Jazz', label:'ii V I (C Ionian)', root:'C', mode:'Ionian', progression:'ii V I' },
      { id:'jazz_minor_251', group:'Jazz', label:'ii¬∞ V i (A Aeolian)', root:'A', mode:'Aeolian', progression:'ii¬∞ V i' },
      { id:'jazz_turn', group:'Jazz', label:'I vi ii V (C Ionian)', root:'C', mode:'Ionian', progression:'I vi ii V' },

      // Blues (triad skeletons)
      { id:'blues_basic', group:'Blues', label:'I IV V (G Mixolydian)', root:'G', mode:'Mixolydian', progression:'I IV V' },
      { id:'blues_shuffle', group:'Blues', label:'I IV I V IV I V (A Mixolydian)', root:'A', mode:'Mixolydian', progression:'I IV I V IV I V' },

      // Metal / Heavy
      { id:'metal_aeo', group:'Metal / Heavy', label:'i VI VII (E Aeolian)', root:'E', mode:'Aeolian', progression:'i VI VII' },
      { id:'metal_phry', group:'Metal / Heavy', label:'i bII i (E Phrygian)', root:'E', mode:'Phrygian', progression:'i bII i' },
      { id:'metal_iv', group:'Metal / Heavy', label:'i iv v (D Aeolian)', root:'D', mode:'Aeolian', progression:'i iv v' },
      { id:'andalusian', group:'Metal / Heavy', label:'Andalusian ‚Äî i VII VI V (A Aeolian)', root:'A', mode:'Aeolian', progression:'i VII VI V' },

      // Modal vamps
      { id:'modal_dor', group:'Modal', label:'Dorian vamp ‚Äî i IV (D Dorian)', root:'D', mode:'Dorian', progression:'i IV' },
      { id:'modal_lyd', group:'Modal', label:'Lydian color ‚Äî I II (C Lydian)', root:'C', mode:'Lydian', progression:'I II' },
      { id:'modal_mixo', group:'Modal', label:'Mixolydian ‚Äî I bVII IV (G Mixolydian)', root:'G', mode:'Mixolydian', progression:'I bVII IV' },

      // EDM / Alt (minor pop)
      { id:'edm_min', group:'EDM / Alt', label:'i VI III VII (A Aeolian)', root:'A', mode:'Aeolian', progression:'i VI III VII' }
    ];

    /* ---------- UI ---------- */
    const rootSel=document.getElementById('root');
    NOTES.forEach((n,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=n; rootSel.appendChild(o); });
    rootSel.value=0;

    const modeSel=document.getElementById('mode');
    const progInput=document.getElementById('progression');
    const results=document.getElementById('results');

    // Build preset select with <optgroup>
    (function buildPresetSelect(){
      const sel=document.getElementById('preset');
      const byGroup = {};
      PRESETS.forEach(p => { (byGroup[p.group] ||= []).push(p); });
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = '‚Äî Choose a preset ‚Äî';
      sel.appendChild(placeholder);
      Object.keys(byGroup).forEach(g=>{
        const og=document.createElement('optgroup'); og.label=g;
        byGroup[g].forEach(p=>{
          const opt=document.createElement('option');
          opt.value=p.id; opt.textContent=p.label;
          og.appendChild(opt);
        });
        sel.appendChild(og);
      });
      sel.addEventListener('change', ()=>{
        const id=sel.value;
        const p=PRESETS.find(x=>x.id===id);
        if(!p) return;
        // apply preset
        const rootPC = NOTES.indexOf(p.root);
        if(rootPC>=0) rootSel.value = rootPC;
        modeSel.value = p.mode;
        progInput.value = p.progression;
        generate();
      });
    })();

    document.getElementById('example').addEventListener('click', ()=>{
      rootSel.value = NOTES.indexOf('C'); modeSel.value='Lydian'; progInput.value='I - IV - VII - iii'; generate();
    });
    document.getElementById('go').addEventListener('click', generate);

    function btn(txt){ const b=document.createElement('button'); b.className='iconbtn'; b.textContent=txt; return b; }
    function chordSymbolFromTriad(tri){ const q=qualityOfTriad(tri); const root=NOTES[tri[0]]; return root + (q==='maj'?'maj': q==='min'?'min': q==='dim'?'dim': q==='aug'?'+':''); }

    function generate(){
      results.innerHTML='';
      const rootPC=parseInt(rootSel.value,10);
      const modeName=modeSel.value;
      const scale=scalePCs(rootPC,modeName);
      const tokens=cleanTokens(progInput.value);

      tokens.forEach(tk=>{
        const {degree,accidental,isDim}=parseDegreeToken(tk);
        let di=(romanToIdx(degree)+accidental+7)%7;
        let tri=triadForDegree(scale,di);
        if(isDim){ tri=[tri[0], wrap(tri[0]+3), wrap(tri[0]+6)]; }
        const chordName=chordSymbolFromTriad(tri);

        const card=document.createElement('div'); card.className='card'; card.tabIndex=0;
        const title=document.createElement('div'); title.className='titleline';
        title.innerHTML=`<span class="deg">${tk}</span><span class="name">${chordName}</span>`;
        card.appendChild(title);

        const meta=document.createElement('div'); meta.className='meta';
        meta.innerHTML=`<span>Mode: ${modeName}</span><span>‚Ä¢</span><span>Root: ${NOTES[rootPC]}</span>`;
        card.appendChild(meta);

        const ctrls=document.createElement('div'); ctrls.className='controls-row';
        const invChip=document.createElement('span'); invChip.className='chip'; invChip.textContent='Root position';
        const posChip=document.createElement('span'); posChip.className='chip'; posChip.textContent='Pos: 0';
        const prevInv=btn('‚óÄ'), nextInv=btn('‚ñ∂'), up=btn('‚ñ≤'), down=btn('‚ñº');
        ctrls.append(prevInv,invChip,nextInv,down,posChip,up);
        card.appendChild(ctrls);

        const fb=document.createElement('div'); fb.className='fb'; card.appendChild(fb);

        let inversion=0, startF=0, currentFull=null;

        function redraw(){
          const v432=findCloseTriad(tri, inversion, startF);
          if(!v432){ fb.innerHTML=`<div class="hint">No playable voicing here.</div>`; return; }
          currentFull=extendToSixStrings(tri, v432);
          invChip.textContent = inversion===0?'Root position':(inversion===1?'1st inversion':'2nd inversion');
          posChip.textContent = 'Pos: ' + currentFull.base;
          fb.innerHTML = svgMiniFretboard(currentFull, 'degrees', tri);
        }

        nextInv.addEventListener('click', ()=>{ inversion=(inversion+1)%3; redraw(); });
        prevInv.addEventListener('click', ()=>{ inversion=(inversion+2)%3; redraw(); });
        up.addEventListener('click',   ()=>{ startF=Math.min(12,startF+4); redraw(); });
        down.addEventListener('click', ()=>{ startF=Math.max(0,startF-4); redraw(); });
        card.addEventListener('keydown', e=>{
          if(e.key==='ArrowRight'){ inversion=(inversion+1)%3; redraw(); }
          if(e.key==='ArrowLeft'){  inversion=(inversion+2)%3; redraw(); }
          if(e.key==='ArrowUp'){    startF=Math.min(12,startF+4); redraw(); }
          if(e.key==='ArrowDown'){  startF=Math.max(0,startF-4); redraw(); }
        });

        results.appendChild(card);
        redraw();
      });
    }

    (function init(){ try{ document.getElementById('root').value=0; generate(); }catch(e){ console.error(e); } })();
  </script>
</body>
</html>