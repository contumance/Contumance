<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Modal Architect ‚Äî Contumance</title>
  <meta name="description" content="Design harmonic structures from scale geometry. Choose a mode, a root, write degrees, and craft playable guitar inversions." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚ô™</text></svg>">

  <style>
    /* ---- Shared palette & rhythm (unified with Scales/Chords) ---- */
    :root{
      --paper:#f5f1e8; --ink:#2f2a1e; --muted:#6b6253;
      --link:#2d5842; --link-visited:#514f7a;
      --accent:#a08a63; --rule:#d8d2c2; --accent-soft:#999;
      --maxw:42rem; --radius:14px; --lh:1.6; --fs-base:18px;
    }
    html.theme-dark{
      --paper:#10110f; --ink:#dbd6c9; --muted:#a39c8c;
      --link:#a9d0b8; --link-visited:#c0b8e0;
      --accent:#2a2b27; --rule:#2a2b27; --accent-soft:#7f7a6b;
    }
    html{ font-size:var(--fs-base); }
    body{
      margin:0; padding:0; color:var(--ink); background:var(--paper); line-height:var(--lh);
      font-family: ui-serif, Georgia, "Iowan Old Style", "Palatino Linotype", Palatino, serif;
      text-rendering: optimizeLegibility; -webkit-font-smoothing: antialiased;
    }
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.06;
      background-image:
        radial-gradient(circle at 25% 15%, #000 0.5px, transparent 0.5px),
        radial-gradient(circle at 75% 85%, #000 0.5px, transparent 0.5px);
      background-size:3px 3px, 3px 3px; mix-blend-mode:multiply;
    }
    main{ max-width:var(--maxw); margin:0 auto; padding:7vh 1.25rem 4rem; }

    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem; }
    nav.breadcrumb{ font-size:.95rem; }
    nav.breadcrumb a{ color:var(--link); text-decoration:none; text-underline-offset:2px; }
    h1{ margin:.2rem 0 .3rem 0; font-weight:600; font-size:clamp(1.6rem,4vw,2.2rem); }
    .subtitle{ color:var(--muted); font-size:.95rem; margin-bottom:.8rem; }
    .theme-toggle{
      border:1px solid var(--accent); background:transparent; color:var(--ink);
      border-radius:.45rem; padding:.35rem .55rem; cursor:pointer; font-size:1.15rem; line-height:1;
    }
    .theme-toggle:focus-visible{ outline:2px dashed var(--accent); outline-offset:2px; }

    details.panel{ border:1px solid var(--accent); border-radius:.6rem; background: rgba(255,255,255,0.6); }
    html.theme-dark details.panel{ background: rgba(0,0,0,0.1); }
    details.panel>summary{ cursor:pointer; list-style:none; padding:.6rem .8rem; font-size:.95rem; font-weight:600; color:var(--ink); }
    details.panel>summary::-webkit-details-marker{ display:none; }
    details.panel .panel-body{ padding:.6rem .8rem .9rem; }
    details.panel>summary::after{ content:"‚ñæ"; float:right; transition:transform .2s ease; }
    details.panel[open]>summary::after{ transform:rotate(180deg); }

    .controls{ display:grid; gap:8px; align-items:center; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); margin-bottom:8px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; opacity:.9; display:block; }
    input[type="text"], select, button{
      appearance:none; border:1px solid var(--accent); background:transparent; color:var(--ink);
      padding:10px 12px; border-radius:.5rem; font-family:inherit; font-size:14px; line-height:1; min-width:0; outline:none;
    }
    button.primary{ background:var(--ink); color:var(--paper); border-color:var(--ink); }
    button:focus-visible, input[type="text"]:focus-visible, select:focus-visible{ outline:2px dashed var(--accent); outline-offset:2px; }

    .cards{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); margin-top:12px; }
    .card{ border:1px solid var(--accent); border-radius:.6rem; padding:.85rem; background:transparent; }
    .titleline{ display:flex; align-items:baseline; justify-content:space-between; gap:.5rem; }
    .deg{ font-weight:700; letter-spacing:.03em; }
    .name{ font-variant:small-caps; font-weight:600; }
    .meta{ color:var(--muted); font-size:.85rem; display:flex; gap:.6rem; flex-wrap:wrap; margin:.35rem 0 .55rem; }

    .controls-row{ display:flex; gap:.4rem; flex-wrap:wrap; align-items:center; margin:.25rem 0 .55rem; }
    .chip{ border:1px solid var(--accent); border-radius:999px; padding:.2rem .6rem; font-size:.8rem; color:var(--muted); }
    .iconbtn{ border:1px solid var(--accent); background:transparent; color:inherit; width:2.1rem; height:2.1rem; border-radius:.5rem; cursor:pointer; }

    /* Hint/comment style (smaller, italic, muted + indent with guide) */
    .hint{
      font-size: .8rem;
      color: var(--muted);
      font-style: italic;
      opacity: .85;
      margin-top: .25rem;
      padding-left: .7rem;
      border-left: 1px dashed var(--accent-soft);
      line-height: 1.4;
    }

    /* --- Mini fretboard SVG (same system as The Chords Book) --- */
    .fb svg{ max-width:100%; height:auto; display:block; }
    .fb-grid line{ stroke:var(--rule); stroke-width:1; }
    .fb-grid .nut{ stroke:var(--ink); stroke-width:3; }
    .fb-note circle{ fill:var(--ink); }
    .fb-note text{ font-size:10px; font-weight:700; fill:var(--paper); }
    .fb-grid text{ fill:var(--muted); }
    html.theme-dark .fb-grid text{ fill:var(--ink); opacity:.85; }
    html.theme-dark .fb-grid line{ stroke:#3b3a34; }
    html.theme-dark .fb-note text{ fill:var(--paper); font-weight:800; }

    footer{ display:flex; flex-direction:column; align-items:center; gap:.25rem; font-size:.9rem; opacity:.9; padding:1.5rem 0; }
    footer .btn{ display:inline-flex; align-items:center; gap:.5rem; text-decoration:none; border:1px solid var(--accent); border-radius:999px; padding:.45rem .95rem; font-size:.9rem; font-weight:500; transition:background-color .25s ease, color .25s ease, transform .1s ease, filter .2s ease; }
    html:not(.theme-dark) footer .btn{ background:color-mix(in oklab, var(--accent) 10%, var(--paper) 90%); color:var(--ink); }
    html:not(.theme-dark) footer .btn:hover{ background:color-mix(in oklab, var(--accent) 20%, var(--paper) 80%); }
    html.theme-dark footer .btn{ background:color-mix(in oklab, var(--accent) 40%, var(--ink) 60%); color:var(--paper); }
    html.theme-dark footer .btn:hover{ background:color-mix(in oklab, var(--accent) 55%, var(--ink) 45%); }
    footer .btn .btn-icon{ width:1.2rem; height:1.2rem; stroke:currentColor; }
    footer .note{font-size:.85rem;color:var(--muted)}
    footer .byline{font-size:.75rem;opacity:.7}
    footer .byline em{font-style:italic;letter-spacing:.02em}

    @media (prefers-reduced-motion:no-preference){
      a{ position:relative; background-image:linear-gradient(currentColor,currentColor); background-position:0 100%; background-repeat:no-repeat; background-size:0% 1px; transition:background-size .25s ease, color .2s ease; }
      a:hover, a:focus-visible{ background-size:100% 1px; outline:none; }
    }
  </style>
</head>
<body>
  <main>
    <div class="topbar">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="index.html">‚Üê Back to index</a>
      </nav>
      <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme" title="Toggle theme">üåì</button>
    </div>

    <header>
      <h1>The Modal Architect</h1>
      <div class="subtitle">Design harmonic structures from scale geometry. Choose a mode, a root, write degrees, and pick inversions.</div>
    </header>

    <details class="panel" open>
      <summary>Controls</summary>
      <div class="panel-body">
        <div class="controls" role="group" aria-label="Modal progression controls">
          <div>
            <label for="progression">Progression (roman degrees)</label>
            <input id="progression" type="text" placeholder="I - IV - VII - iii" value="I - IV - VII - iii">
            <div class="hint">Supports accidentals: <code>#iv</code>, <code>bVII</code>, <code>vii¬∞</code>. Use dashes, commas, or spaces.</div>
          </div>
          <div>
            <label for="root">Root / Tonic</label>
            <select id="root"></select>
          </div>
          <div>
            <label for="mode">Mode</label>
            <select id="mode">
              <option>Ionian</option><option>Dorian</option><option>Phrygian</option>
              <option selected>Lydian</option><option>Mixolydian</option>
              <option>Aeolian</option><option>Locrian</option>
            </select>
          </div>
        </div>
        <div class="row">
          <button class="primary" id="go" type="button">Generate</button>
          <button id="example" type="button">Example: C Lydian ‚Äî I IV VII iii</button>
        </div>
      </div>
    </details>

    <section id="results" class="cards" aria-live="polite"></section>

    <p class="hint" style="margin-top:.5rem">Tip: use ‚óÄ ‚ñ∂ to change inversion and ‚ñ≤ ‚ñº to move the position on the focused card.</p>
    
    <footer>
  <a class="btn" href="https://buymeacoffee.com/Contumance" target="_blank" rel="noopener noreferrer"
     aria-label="Support this library on Buy Me a Coffee">
    <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M4 8h14.5a2 2 0 0 1 0 4H18l-1 5a4 4 0 0 1-3.95 3.3H8.95A4 4 0 0 1 5 17l-1-9z"/>
      <path d="M3 8h17"/><path d="M7 4h6"/>
    </svg>
    <span>Buy me a coffee</span>
  </a>

  <!-- ‚ú® Nueva l√≠nea de dedicatoria -->
  <span class="note">Concept inspired by <em>@nickitus</em>.</span>

  <span class="note">Fuel the craft. Inspire the next page.</span>
  <span>¬© <span id="y"></span> Re:sonance <small class="byline">by <em>Contumance</em></small></span>
</footer>
    
  </main>

  <!-- Theme toggle -->
  <script>
    (function () {
      const KEY='theme-preference', root=document.documentElement, btn=document.getElementById('themeToggle');
      function setIcon(){ btn.textContent='‚óë'; } function apply(m){ root.classList.toggle('theme-dark', m==='dark'); setIcon(); }
      function pref(){ const s=localStorage.getItem(KEY); if(s==='light'||s==='dark') return s; return matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'; }
      let cur=pref(); apply(cur);
      btn.addEventListener('click', ()=>{ cur=cur==='dark'?'light':'dark'; localStorage.setItem(KEY,cur); apply(cur); });
      document.getElementById('y').textContent=new Date().getFullYear();
    })();
  </script>

  <!-- App logic (SVG fretboards unified with The Chords Book) -->
  <script>
    /* ---------- Theory ---------- */
    const NOTES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const PC=Object.fromEntries(NOTES.map((n,i)=>[n,i]));
    const DEG = {0:'R',1:'‚ô≠2',2:'2',3:'‚ô≠3',4:'3',5:'4',6:'‚ô≠5',7:'5',8:'‚ôØ5',9:'6',10:'‚ô≠7',11:'7'};

    // Guitar tuning pitch-classes 6..1 (E A D G B E)
    const TUNING_PC = [4,9,2,7,11,4];

    const MODES={
      "Ionian":[0,2,4,5,7,9,11],
      "Dorian":[0,2,3,5,7,9,10],
      "Phrygian":[0,1,3,5,7,8,10],
      "Lydian":[0,2,4,6,7,9,11],
      "Mixolydian":[0,2,4,5,7,9,10],
      "Aeolian":[0,2,3,5,7,8,10],
      "Locrian":[0,1,3,5,6,8,10]
    };
    const wrap=n=>((n%12)+12)%12;

    function scalePCs(rootPC,mode){ return MODES[mode].map(s=>wrap(rootPC+s)); }
    function triadForDegree(scale,i){ return [ scale[i%7], scale[(i+2)%7], scale[(i+4)%7] ]; }
    function qualityOfTriad([r,t,f]){
      const d3=wrap(t-r), d5=wrap(f-r);
      if(d3===4 && d5===7) return 'maj';
      if(d3===3 && d5===7) return 'min';
      if(d3===3 && d5===6) return 'dim';
      if(d3===4 && d5===8) return 'aug';
      return '';
    }

    // Roman degrees
    const ROMAN_MAP={i:1,ii:2,iii:3,iv:4,v:5,vi:6,vii:7};
    function parseDegreeToken(tok){
      tok=tok.trim();
      let acc=0; if(tok[0]==='#'){acc=+1; tok=tok.slice(1);} if(tok[0]==='b'||tok[0]==='B'){acc=-1; tok=tok.slice(1);}
      const dim=/¬∞/.test(tok); const base=tok.toLowerCase().replace(/[¬∞\+]/g,''); const n=ROMAN_MAP[base]||1;
      return {degree:n,accidental:acc,isDim:dim,raw:tok};
    }
    function cleanTokens(str){ return str.split(/[\s,\-‚Äì‚Äî]+/).filter(Boolean); }
    const romanToIdx = d => (d-1+7)%7;

    // Helpers for strings and frets
    function noteAt(stringNo,fret){ const idx={6:0,5:1,4:2,3:3,2:4,1:5}[stringNo]; return wrap(TUNING_PC[idx]+fret); }

    /* ---------- Build 4-3-2 close triad then extend to 6 strings ---------- */
    function findCloseTriad(triadPCs, inversion=0, startF=0){
      const bassIdx=[0,1,2][inversion];
      for(let f4=startF; f4<=12; f4++){
        if(noteAt(4,f4)!==triadPCs[bassIdx]) continue;
        const rest=[0,1,2].filter(i=>i!==bassIdx);
        let best=null, spanBest=99;
        for(let f3=Math.max(0,f4-4); f3<=Math.min(15,f4+6); f3++){
          if(!rest.some(i=>noteAt(3,f3)===triadPCs[i])) continue;
          for(let f2=Math.max(0,Math.min(f3,f4)-4); f2<=Math.min(15,Math.max(f3,f4)+6); f2++){
            if(!rest.some(i=>noteAt(2,f2)===triadPCs[i])) continue;
            const span=Math.max(f4,f3,f2)-Math.min(f4,f3,f2);
            if(span<=5 && span<spanBest){ spanBest=span; best={f4,f3,f2}; }
          }
        }
        if(best) return best;
      }
      return null;
    }
    function chooseFretForString(stringNo, triadPCs, base){
      const center=base+2.5, prio=[0,1,2]; // prefer R‚Üí3‚Üí5
      let best=null, bestRank=99, bestDist=1e9;
      for(let f=base; f<=base+5; f++){
        const pc=noteAt(stringNo,f); const idx=triadPCs.indexOf(pc); if(idx===-1) continue;
        const rank=prio.indexOf(idx), dist=Math.abs(f-center);
        if(rank<bestRank || (rank===bestRank && dist<bestDist)){ best=f; bestRank=rank; bestDist=dist; }
      }
      return best;
    }
    function extendToSixStrings(triadPCs, voicing432){
      const minF=Math.min(voicing432.f4,voicing432.f3,voicing432.f2);
      const base=Math.floor(minF/4)*4;
      const frets={6:null,5:null,4:voicing432.f4,3:voicing432.f3,2:voicing432.f2,1:null};
      frets[6]=chooseFretForString(6,triadPCs,base);
      frets[5]=chooseFretForString(5,triadPCs,base);
      frets[1]=chooseFretForString(1,triadPCs,base);
      return {base, frets};
    }

    /* ---------- SVG renderer (same as The Chords Book) ---------- */
    function svgMiniFretboard(fullVoicing, labelsMode, triadPCs, startFOverride){
      const strings=6;
      const startF = startFOverride ?? fullVoicing.base;
      const maxF = Math.max(...Object.values(fullVoicing.frets).filter(f=>f!=null));
      const fretsCount = Math.max(3, (maxF - startF) + 1);
      const x0=70, y0=46, dx=44, dy=24, w=fretsCount*44+96, h=strings*24+76;

      const g=[];
      g.push(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}">`);
      g.push(`<g class="fb-grid">`);
      for(let s=0;s<strings;s++){
        const y=y0+s*dy;
        g.push(`<line x1="${x0}" y1="${y}" x2="${x0+fretsCount*dx}" y2="${y}" />`);
        g.push(`<text x="${x0-15}" y="${y+4}" font-size="10" text-anchor="end">${6-s}</text>`);
      }
      for(let f=0; f<=fretsCount; f++){
        const x=x0+f*dx; const isNut=(startF===0 && f===1);
        g.push(`<line x1="${x}" y1="${(y0 - dy/2)}" x2="${x}" y2="${(y0 + (strings-1)*dy + dy/2)}" class="${isNut?'nut':''}" />`);
      }
      for(let c=0; c<fretsCount; c++){
        const x=x0+(c+0.5)*dx; const label=startF+c;
        g.push(`<text x="${x}" y="${(y0 - dy/1.3)}" font-size="10" text-anchor="middle">${label}</text>`);
      }
      g.push(`</g>`);

      g.push(`<g class="fb-note">`);
      for(let s=6; s>=1; s--){
        const fret=fullVoicing.frets[s];
        if(fret==null) continue;
        const row = 6 - s; // s=6 -> row 0
        const cx=x0+(fret - startF + 0.5)*dx;
        const cy=y0 + row*dy;
        let label='';
        if(labelsMode==='notes'){
          const pc = noteAt(s, fret);
          label = NOTES[pc];
        }else if(labelsMode==='degrees'){
          const pc = noteAt(s, fret);
          const rel = (pc - triadPCs[0] + 12) % 12; // relative to triad root
          label = DEG[rel] || '';
        }
        g.push(`<circle cx="${cx}" cy="${cy}" r="10.5"></circle>`);
        if(label) g.push(`<text x="${cx}" y="${cy+3}" text-anchor="middle">${label}</text>`);
      }
      g.push(`</g>`);
      g.push(`</svg>`);
      return g.join('');
    }

    /* ---------- UI ---------- */
    const rootSel=document.getElementById('root');
    NOTES.forEach((n,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=n; rootSel.appendChild(o); });
    rootSel.value=0;

    const modeSel=document.getElementById('mode');
    const progInput=document.getElementById('progression');
    const results=document.getElementById('results');

    document.getElementById('example').addEventListener('click', ()=>{
      rootSel.value = NOTES.indexOf('C'); modeSel.value='Lydian'; progInput.value='I - IV - VII - iii'; generate();
    });
    document.getElementById('go').addEventListener('click', generate);

    function btn(txt){ const b=document.createElement('button'); b.className='iconbtn'; b.textContent=txt; return b; }
    function chordSymbolFromTriad(tri){ const q=qualityOfTriad(tri); const root=NOTES[tri[0]]; return root + (q==='maj'?'maj': q==='min'?'min': q==='dim'?'dim': q==='aug'?'+':''); }

    function generate(){
      results.innerHTML='';
      const rootPC=parseInt(rootSel.value,10);
      const modeName=modeSel.value;
      const scale=scalePCs(rootPC,modeName);
      const tokens=cleanTokens(progInput.value);

      tokens.forEach(tk=>{
        const {degree,accidental,isDim}=parseDegreeToken(tk);
        let di=(romanToIdx(degree)+accidental+7)%7;
        let tri=triadForDegree(scale,di);
        if(isDim){ tri=[tri[0], wrap(tri[0]+3), wrap(tri[0]+6)]; }
        const chordName=chordSymbolFromTriad(tri);

        const card=document.createElement('div'); card.className='card'; card.tabIndex=0;
        const title=document.createElement('div'); title.className='titleline';
        title.innerHTML=`<span class="deg">${tk}</span><span class="name">${chordName}</span>`;
        card.appendChild(title);

        const meta=document.createElement('div'); meta.className='meta';
        meta.innerHTML=`<span>Mode: ${modeName}</span><span>‚Ä¢</span><span>Root: ${NOTES[rootPC]}</span>`;
        card.appendChild(meta);

        const ctrls=document.createElement('div'); ctrls.className='controls-row';
        const invChip=document.createElement('span'); invChip.className='chip'; invChip.textContent='Root position';
        const posChip=document.createElement('span'); posChip.className='chip'; posChip.textContent='Pos: 0';
        const prevInv=btn('‚óÄ'), nextInv=btn('‚ñ∂'), up=btn('‚ñ≤'), down=btn('‚ñº');
        ctrls.append(prevInv,invChip,nextInv,down,posChip,up);
        card.appendChild(ctrls);

        const fb=document.createElement('div'); fb.className='fb'; card.appendChild(fb);

        let inversion=0, startF=0, currentFull=null;

        function redraw(){
          const v432=findCloseTriad(tri, inversion, startF);
          if(!v432){ fb.innerHTML=`<div class="hint">No playable voicing here.</div>`; return; }
          currentFull=extendToSixStrings(tri, v432);
          invChip.textContent = inversion===0?'Root position':(inversion===1?'1st inversion':'2nd inversion');
          posChip.textContent = 'Pos: ' + currentFull.base;
          fb.innerHTML = svgMiniFretboard(currentFull, 'degrees', tri);
        }

        nextInv.addEventListener('click', ()=>{ inversion=(inversion+1)%3; redraw(); });
        prevInv.addEventListener('click', ()=>{ inversion=(inversion+2)%3; redraw(); });
        up.addEventListener('click',   ()=>{ startF=Math.min(12,startF+4); redraw(); });
        down.addEventListener('click', ()=>{ startF=Math.max(0,startF-4); redraw(); });
        card.addEventListener('keydown', e=>{
          if(e.key==='ArrowRight'){ inversion=(inversion+1)%3; redraw(); }
          if(e.key==='ArrowLeft'){  inversion=(inversion+2)%3; redraw(); }
          if(e.key==='ArrowUp'){    startF=Math.min(12,startF+4); redraw(); }
          if(e.key==='ArrowDown'){  startF=Math.max(0,startF-4); redraw(); }
        });

        results.appendChild(card);
        redraw();
      });
    }

    (function init(){ try{ document.getElementById('root').value=0; generate(); }catch(e){ console.error(e); } })();
  </script>
</body>
</html>