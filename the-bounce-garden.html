<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Bounce Garden ‚Äî Re:sonance</title>
  <meta name="description" content="Nodes bouncing inside a circle; each collision triggers its note or a drum (kick/snare/hat). With L/R panning per node and drones." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚ô™</text></svg>">
  <style>
    :root{
      --paper:#f5f1e8; --ink:#2f2a1e; --muted:#6b6253;
      --link:#2d5842; --link-visited:#514f7a;
      --accent:#a08a63; --rule:#d8d2c2; --accent-soft:#999;
      --maxw:42rem; --radius:14px; --lh:1.6; --fs-base:18px;
      --hit:#d9c8a6;
    }
    html.theme-dark{
      --paper:#10110f; --ink:#dbd6c9; --muted:#a39c8c;
      --link:#a9d0b8; --link-visited:#c0b8e0;
      --accent:#2a2b27; --rule:#2a2b27; --accent-soft:#7f7a6b;
      --hit:#2a2a22;
    }
    html{font-size:var(--fs-base)}
    body{
      margin:0; padding:0; color:var(--ink); background:var(--paper);
      font-family:ui-serif, Georgia, "Iowan Old Style", "Palatino Linotype", Palatino, serif;
      line-height:var(--lh); text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased;
    }
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.06;
      background-image:
        radial-gradient(circle at 25% 15%, #000 0.5px, transparent 0.5px),
        radial-gradient(circle at 75% 85%, #000 0.5px, transparent 0.5px);
      background-size:3px 3px, 3px 3px; mix-blend-mode:multiply;
    }
    main{max-width:var(--maxw); margin:0 auto; padding:7vh 1.25rem 4rem;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem;}
    nav.breadcrumb{font-size:.95rem}
    nav.breadcrumb a{color:var(--link); text-decoration:none; text-underline-offset:2px;}
    h1{margin:.2rem 0 .3rem 0; font-weight:600; font-size:clamp(1.6rem,4vw,2.2rem);}
    .subtitle{color:var(--muted); font-size:.95rem; margin-bottom:.8rem;}
    .theme-toggle{
      border:1px solid var(--accent); background:transparent; color:var(--ink);
      border-radius:.45rem; padding:.35rem .55rem; cursor:pointer; font-size:1.15rem; line-height:1;
    }
    .theme-toggle:focus-visible{outline:2px dashed var(--accent); outline-offset:2px;}
    hr{border:none; border-top:1px solid var(--accent); margin:1.25rem 0; opacity:.5;}

    /* Panels y controles */
    details.panel{border:1px solid var(--accent); border-radius:.6rem; background:rgba(255,255,255,.6);}
    html.theme-dark details.panel{background:rgba(0,0,0,.1);}
    details.panel>summary{cursor:pointer; list-style:none; padding:.6rem .8rem; font-size:.95rem; font-weight:600; color:var(--ink);}
    details.panel>summary::-webkit-details-marker{display:none;}
    details.panel>summary::after{content:"‚ñæ"; float:right; transition:transform .2s ease;}
    details.panel[open]>summary::after{transform:rotate(180deg);}
    details.panel .panel-body{padding:.6rem .8rem .9rem;}
    .controls{display:grid; gap:8px; align-items:center; grid-template-columns:repeat(auto-fit,minmax(170px,1fr)); margin-bottom:8px;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    label{font-size:12px; opacity:.9; display:flex; flex-direction:column; gap:6px;}
    select,button,input[type="number"],input[type="range"]{
      appearance:none; border:1px solid var(--accent); background:transparent; color:var(--ink);
      padding:10px 12px; border-radius:.5rem; font-family:inherit; font-size:14px; line-height:1; min-width:0;
    }
    button.primary{background:var(--ink); color:var(--paper); border-color:var(--ink);}

    /* Stage (c√≠rculo + canvas) ‚Äî ahora fuera del panel */
    .stage{
      border:1px solid var(--accent); border-radius:.6rem; background:transparent;
      margin:14px 0 10px; padding:10px; position:relative;
    }
    .circle-wrap{
      position:relative; width:100%; aspect-ratio:1/1;
      border:1px solid var(--rule); border-radius:.6rem; overflow:hidden; background:transparent;
    }
    canvas{position:absolute; display:block;}

    .tip{margin:.35rem 2px 1rem; font-size:.9rem; color:var(--muted);}

    /* Lista de nodos */
    .list{display:flex; flex-direction:column; gap:6px;}
    .node-item{
      display:flex; align-items:center; justify-content:space-between; gap:.6rem;
      border:1px dashed var(--rule); border-radius:.6rem; padding:.45rem .55rem; font-size:.95rem;
    }
    .left{display:flex; align-items:center; gap:.6rem; min-width:0}
    .swatch{width:12px; height:12px; border-radius:999px; flex:none}
    .muted{color:var(--muted)}
    .footer{margin:30px 0 60px; font-size:12px; color:var(--muted);}

    /* Footer (Buy Me a Coffee) */
    footer{display:flex; flex-direction:column; align-items:center; gap:.25rem; font-size:.9rem; opacity:.9; padding:1.5rem 0;}
    footer .btn{
      display:inline-flex; align-items:center; gap:.5rem; text-decoration:none;
      border:1px solid var(--accent); border-radius:999px; padding:.45rem .95rem;
      font-size:.9rem; font-weight:500; transition:background-color .25s ease, color .25s ease, transform .1s ease, filter .2s ease;
    }
    html:not(.theme-dark) footer .btn{ background:color-mix(in oklab, var(--accent) 10%, var(--paper) 90%); color:var(--ink); }
    html:not(.theme-dark) footer .btn:hover{ background:color-mix(in oklab, var(--accent) 20%, var(--paper) 80%); }
    html.theme-dark footer .btn{ background:color-mix(in oklab, var(--accent) 40%, var(--ink) 60%); color:var(--paper); }
    html.theme-dark footer .btn:hover{ background:color-mix(in oklab, var(--accent) 55%, var(--ink) 45%); }
    footer .btn .btn-icon{ width:1.2rem; height:1.2rem; stroke:currentColor; }
    footer .note{font-size:.85rem;color:var(--muted)}
    footer .byline{font-size:.75rem;opacity:.7}
    footer .byline em{font-style:italic;letter-spacing:.02em}
  </style>
</head>
<body>
  <main>
    <div class="topbar">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="index.html">‚Üê Back to index</a>
      </nav>
      <div class="row" style="gap:6px;">
        <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme" title="Toggle theme">üåì</button>
      </div>
    </div>

    <header>
      <h1>The Bounce Garden</h1>
      <div class="subtitle">Where collisions sing ‚Äî melodic orbits, drum hits, and long-tail drones inside a circle.</div>
    </header>

    <!-- ======= STAGE FUERA DEL PANEL ======= -->
    <section aria-label="Playground">
      <div class="stage">
        <div class="circle-wrap">
          <!-- solo canvas (un solo borde visible y preciso) -->
          <canvas id="canvas"></canvas>
        </div>
      </div>
      <p class="tip">Tip: use long durations (‚â•4 s) for smooth drones. Click on the circle to quickly add nodes. Try the ‚Äúkick/snare/hat‚Äù voices for rhythmic textures.</p>
    </section>

    <!-- ======= PANEL DE SETUP (colapsable) ======= -->
    <details class="panel" open>
      <summary>Nodes setup</summary>
      <div class="panel-body">
        <div class="controls" role="group" aria-label="Controls">
          <label>
            Note
            <select id="noteSelect"></select>
          </label>
          <label>
            Speed
            <input id="speedInput" type="range" min="0.5" max="10" step="0.1" value="3.5">
          </label>
          <label>
            Size
            <input id="sizeInput" type="range" min="6" max="22" step="1" value="11">
          </label>
          <label>
            Sustain
            <input id="durInput" type="range" min="0.1" max="12" step="0.1" value="4.0">
          </label>
          <label>
            Pan (L/R)
            <input id="panInput" type="range" min="-1" max="1" step="0.01" value="0">
          </label>
          <label>
            Voice
            <select id="voiceSelect">
              <option value="tone">Tone</option>
              <option value="kick">Kick</option>
              <option value="snare">Snare</option>
              <option value="hat">Hat</option>
            </select>
          </label>
          <label style="min-width:190px;">
            Volume
            <input id="volumeInput" type="range" min="0" max="1" step="0.01" value="0.45">
          </label>

          <div class="row">
            <button id="addBtn">Add node</button>
            <button id="clearBtn">Clear</button>
            <button id="pauseBtn">Pause</button>
            <button id="audioBtn" class="primary">Start audio</button>
          </div>
        </div>

        <!-- Lista de nodos (queda dentro del setup) -->
        <div class="list" id="nodeList" aria-live="polite"></div>
      </div>
    </details>

    <footer>
      <a class="btn" href="https://buymeacoffee.com/Contumance" target="_blank" rel="noopener noreferrer"
         aria-label="Support this library on Buy Me a Coffee">
        <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 8h14.5a2 2 0 0 1 0 4H18l-1 5a4 4 0 0 1-3.95 3.3H8.95A4 4 0 0 1 5 17l-1-9z"/>
          <path d="M3 8h17"/>
          <path d="M7 4h6"/>
        </svg>
        <span>Buy me a coffee</span>
      </a>
      <span class="note">Fuel the craft. Inspire the next page.</span>
      <span>¬© <span id="y"></span> Re:sonance <small class="byline">by <em>Contumance</em></small></span>
    </footer>
  </main>

  <!-- === Theme toggle === -->
  <script>
    (function(){
      const KEY='theme-preference';
      const root=document.documentElement;
      const btn=document.getElementById('themeToggle');
      function setIcon(){ btn.textContent = '‚óë'; }
      function apply(mode){ root.classList.toggle('theme-dark', mode==='dark'); setIcon(); }
      function getPreferred(){
        const saved=localStorage.getItem(KEY);
        if(saved==='light'||saved==='dark') return saved;
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light';
      }
      let current=getPreferred(); apply(current);
      btn.addEventListener('click',()=>{ current=current==='dark'?'light':'dark'; localStorage.setItem(KEY,current); apply(current); });
    })();
  </script>

  <script>
  // =================== Audio core ===================
  let audioCtx = null, masterGain = null;
  function ensureAudio(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = parseFloat(document.getElementById('volumeInput').value);
    masterGain.connect(audioCtx.destination);
  }
  function midiToFreq(m){ return 440 * Math.pow(2, (m - 69) / 12); }

  function makePanner(pan) {
    const p = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : null;
    if (p) p.pan.value = Math.max(-1, Math.min(1, pan || 0));
    return p;
  }

  // S√≠ntesis de tono (clara, sin FM) con filtro suave y paneo
  function playTone(freq, gainScale, durSec, pan){
    if (!audioCtx) return;
    const t0 = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const g   = audioCtx.createGain();
    const lp  = audioCtx.createBiquadFilter();
    const p   = makePanner(pan);

    osc.type = 'sine';
    lp.type  = 'lowpass';
    lp.frequency.value = Math.max(1500, freq * 3);

    const A=0.008, D=0.06, R=0.18;
    const hold = Math.max(0.08, durSec);
    const peak = Math.min(1, Math.max(0.05, gainScale));

    g.gain.setValueAtTime(0, t0);
    g.gain.linearRampToValueAtTime(peak, t0+A);
    g.gain.linearRampToValueAtTime(peak*0.85, t0+A+D);
    g.gain.setValueAtTime(peak*0.85, t0+hold);
    g.gain.linearRampToValueAtTime(0.0001, t0+hold+R);

    osc.frequency.setValueAtTime(freq, t0);

    osc.connect(g); g.connect(lp);
    if (p){ lp.connect(p); p.connect(masterGain); } else { lp.connect(masterGain); }

    osc.start(t0);
    osc.stop(t0 + hold + R + 0.02);
  }

  // ====== Drum mini-synths ======
  let _noiseBuf = null;
  function getNoiseBuffer(){
    if (_noiseBuf) return _noiseBuf;
    const len = (audioCtx?.sampleRate||48000) * 2;
    const buf = audioCtx.createBuffer(1, len, audioCtx.sampleRate);
    const d = buf.getChannelData(0);
    for (let i=0;i<len;i++) d[i] = (Math.random()*2-1);
    _noiseBuf = buf; return buf;
  }

  function playKick({pan=0, gain=0.9, dur=0.25, fStart=140, fEnd=48}={}){
    const t0 = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const g   = audioCtx.createGain();
    const p   = makePanner(pan);

    osc.type='sine';
    osc.frequency.setValueAtTime(fStart, t0);
    osc.frequency.exponentialRampToValueAtTime(fEnd, t0 + dur);

    g.gain.setValueAtTime(0, t0);
    g.gain.linearRampToValueAtTime(gain, t0+0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

    osc.connect(g);
    if (p){ g.connect(p); p.connect(masterGain);} else { g.connect(masterGain); }
    osc.start(t0);
    osc.stop(t0 + dur + 0.02);
  }

  function playSnare({pan=0, gain=0.5, dur=0.18, toneHz=330}={}){
    const t0 = audioCtx.currentTime;

    const nsrc = audioCtx.createBufferSource();
    nsrc.buffer = getNoiseBuffer();
    const hpf = audioCtx.createBiquadFilter(); hpf.type='highpass'; hpf.frequency.value=800;
    const bpf = audioCtx.createBiquadFilter(); bpf.type='bandpass'; bpf.frequency.value=1800; bpf.Q.value=0.5;
    const ng = audioCtx.createGain();
    const p  = makePanner(pan);

    ng.gain.setValueAtTime(gain, t0);
    ng.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

    nsrc.connect(hpf); hpf.connect(bpf); bpf.connect(ng);
    if (p){ ng.connect(p); p.connect(masterGain);} else { ng.connect(masterGain); }

    nsrc.start(t0);
    nsrc.stop(t0 + dur + 0.05);

    const osc = audioCtx.createOscillator();
    const g   = audioCtx.createGain();
    osc.type='triangle';
    osc.frequency.setValueAtTime(toneHz, t0);
    g.gain.setValueAtTime(gain*0.25, t0);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur*0.7);
    osc.connect(g);
    if (p){ g.connect(p); p.connect(masterGain);} else { g.connect(masterGain); }
    osc.start(t0);
    osc.stop(t0 + dur + 0.05);
  }

  function playHat({pan=0, gain=0.35, dur=0.07}={}){
    const t0 = audioCtx.currentTime;
    const nsrc = audioCtx.createBufferSource();
    nsrc.buffer = getNoiseBuffer();
    const hpf = audioCtx.createBiquadFilter(); hpf.type='highpass'; hpf.frequency.value=7000;
    const ng = audioCtx.createGain();
    const p  = makePanner(pan);

    ng.gain.setValueAtTime(gain, t0);
    ng.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

    nsrc.connect(hpf); hpf.connect(ng);
    if (p){ ng.connect(p); p.connect(masterGain);} else { ng.connect(masterGain); }

    nsrc.start(t0);
    nsrc.stop(t0 + dur + 0.02);
  }

  function triggerNodeSound(n, impactGain=0.55){
    if (!audioCtx) return;
    const voice = n.voice || 'tone';
    if (voice === 'tone'){
      const freq = midiToFreq(n.midi);
      playTone(freq, impactGain, n.dur, n.pan);
    } else if (voice === 'kick'){
      const base = Math.max(42, Math.min(180, midiToFreq(n.midi))); // usar nota como ‚Äúpeso‚Äù
      playKick({pan:n.pan, gain:impactGain, dur:Math.min(n.dur,0.35), fStart:base, fEnd:48});
    } else if (voice === 'snare'){
      playSnare({pan:n.pan, gain:impactGain, dur:Math.min(n.dur,0.25)});
    } else if (voice === 'hat'){
      playHat({pan:n.pan, gain:impactGain*0.9, dur:Math.min(n.dur,0.12)});
    }
  }

  // =================== Notas UI ===================
  const NOTES = (() => {
    const names=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const list=[];
    for (let oct=2; oct<=6; oct++){
      for (let i=0;i<12;i++){
        list.push({ name:`${names[i]}${oct}`, midi:12*(oct+1)+i });
      }
    }
    return list;
  })();
  const noteSelect=document.getElementById('noteSelect');
  NOTES.forEach(n=>{ const o=document.createElement('option'); o.value=n.midi; o.textContent=n.name; noteSelect.appendChild(o); });
  noteSelect.value = NOTES.find(n=>n.name==='A3')?.midi ?? NOTES[0].midi;

  // =================== Controles ===================
  const volumeInput = document.getElementById('volumeInput');
  volumeInput.addEventListener('input', e=>{ if (masterGain) masterGain.gain.value = parseFloat(e.target.value); });

  const audioBtn = document.getElementById('audioBtn');
  audioBtn.addEventListener('click', async ()=>{
    ensureAudio();
    await audioCtx.resume();
    audioBtn.textContent='Audio On';
    audioBtn.classList.remove('primary');
  });

  let paused=false;
  const pauseBtn=document.getElementById('pauseBtn');
  pauseBtn.addEventListener('click', ()=>{ paused=!paused; pauseBtn.textContent = paused ? 'Resume' : 'Pause'; });

  // =================== Canvas + F√≠sica ===================
  const canvas=document.getElementById('canvas');
  const ctx=canvas.getContext('2d', {alpha:true});
  let W=0,H=0,CX=0,CY=0,R=0;

  function resize(){
    const wrap = canvas.parentElement; // .circle-wrap
    const rect = wrap.getBoundingClientRect();
    const pad  = 14; // margen interno en px CSS
    const size = Math.min(rect.width, rect.height) - pad*2;

    canvas.width  = size * devicePixelRatio;
    canvas.height = size * devicePixelRatio;
    canvas.style.width  = (size) + 'px';
    canvas.style.height = (size) + 'px';
    canvas.style.left   = pad + 'px';
    canvas.style.top    = pad + 'px';

    const ring = 1.5 * devicePixelRatio; // grosor visible del borde
    W = canvas.width; H = canvas.height;
    CX = W/2; CY = H/2;
    R  = Math.min(W,H)/2 - ring/2; // radio de colisi√≥n alineado
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  // =================== Nodos ===================
  const nodes=[];
  const nodeList=document.getElementById('nodeList');

  function randColor(){
    const hues=[20,45,90,140,200,270,320]; const h=hues[Math.floor(Math.random()*hues.length)];
    return `hsl(${h} 60% 50%)`;
  }

  function addNode(midi, speedVal, radiusPx, durSec, pan, voice){
    const SPD_FACTOR = 4.6; // alta energ√≠a
    const r = Math.max(4, radiusPx) * devicePixelRatio;

    // posici√≥n inicial sin solaparse
    let placed=false,x=0,y=0,tries=0;
    while(!placed && tries<220){
      tries++;
      const ang=Math.random()*Math.PI*2;
      const rad = Math.random()*(R - r - 2*devicePixelRatio);
      x = CX + Math.cos(ang)*rad;
      y = CY + Math.sin(ang)*rad;
      placed = nodes.every(n => Math.hypot(x-n.x, y-n.y) >= (r+n.r+2*devicePixelRatio));
    }

    const theta=Math.random()*Math.PI*2;
    const vx = Math.cos(theta)*speedVal*SPD_FACTOR*devicePixelRatio;
    const vy = Math.sin(theta)*speedVal*SPD_FACTOR*devicePixelRatio;

    const node = {
      id: crypto.randomUUID(),
      x,y,vx,vy,
      r: r,
      midi,
      dur: Math.max(0.1, durSec),
      pan: Math.max(-1, Math.min(1, pan||0)),
      voice: voice || 'tone',
      color: randColor(),
      lastHit: 0
    };
    nodes.push(node);
    renderList();
  }

  function removeNode(id){
    const idx=nodes.findIndex(n=>n.id===id);
    if (idx>=0) nodes.splice(idx,1);
    renderList();
  }

  function renderList(){
    nodeList.innerHTML='';
    for (const n of nodes){
      const item=document.createElement('div'); item.className='node-item';
      const left=document.createElement('div'); left.className='left';
      const sw=document.createElement('span'); sw.className='swatch'; sw.style.background=n.color;
      const name = (NOTES.find(x=>x.midi===n.midi)?.name) || n.midi;
      const speed = (Math.hypot(n.vx,n.vy)/devicePixelRatio).toFixed(1);
      left.append(
        sw,
        document.createTextNode(`${name} ¬∑ v=${speed} ¬∑ r=${(n.r/devicePixelRatio|0)} ¬∑ dur=${n.dur.toFixed(1)}s ¬∑ pan=${n.pan.toFixed(2)} ¬∑ ${n.voice}`)
      );
      const rm=document.createElement('button'); rm.textContent='Remove';
      rm.addEventListener('click', ()=>removeNode(n.id));
      item.append(left, rm);
      nodeList.appendChild(item);
    }
  }

  // =================== Interacci√≥n ===================
  document.getElementById('addBtn').addEventListener('click', ()=>{
    const midi = parseInt(document.getElementById('noteSelect').value,10);
    const speed= parseFloat(document.getElementById('speedInput').value);
    const size = parseInt(document.getElementById('sizeInput').value,10);
    const dur  = parseFloat(document.getElementById('durInput').value);
    const pan  = parseFloat(document.getElementById('panInput').value);
    const voice= document.getElementById('voiceSelect').value;
    addNode(midi, speed, size, dur, pan, voice);
    if (!audioCtx){ ensureAudio(); audioCtx.resume(); audioBtn.textContent='Audio On'; audioBtn.classList.remove('primary'); }
  });

  document.getElementById('clearBtn').addEventListener('click', ()=>{ nodes.splice(0,nodes.length); renderList(); });
  canvas.addEventListener('pointerdown', ()=>{ document.getElementById('addBtn').click(); }, {passive:true});

  // =================== Simulaci√≥n ===================
  const WALL_COOLDOWN=0.06;
  const PAIR_COOLDOWN=0.06;

  function step(dt){
    for (const n of nodes){
      n.x += n.vx * dt;
      n.y += n.vy * dt;

      // choque pared (c√≠rculo)
      const dx=n.x-CX, dy=n.y-CY;
      const dist=Math.hypot(dx,dy);
      const maxDist = R - n.r;
      if (dist > maxDist){
        const nx = dx/dist, ny = dy/dist;
        n.x = CX + nx*maxDist;
        n.y = CY + ny*maxDist;
        const vdotn = n.vx*nx + n.vy*ny;
        n.vx = n.vx - 2*vdotn*nx;
        n.vy = n.vy - 2*vdotn*ny;

        if (audioCtx){
          const t=audioCtx.currentTime;
          if (t - n.lastHit > WALL_COOLDOWN){
            const spd = Math.min(5.0, Math.hypot(n.vx,n.vy)/(3*devicePixelRatio));
            const gain = 0.45 + 0.25*spd;
            triggerNodeSound(n, gain);
            n.lastHit = t;
          }
        }
      }
    }

    // colisiones entre pares
    for (let i=0;i<nodes.length;i++){
      for (let j=i+1;j<nodes.length;j++){
        const a=nodes[i], b=nodes[j];
        const dx=b.x-a.x, dy=b.y-a.y;
        const dist=Math.hypot(dx,dy);
        const minDist=a.r+b.r;
        if (dist>0 && dist<minDist){
          const nx=dx/dist, ny=dy/dist;
          const overlap = (minDist - dist);
          const push = overlap/2;
          a.x -= nx*push; a.y -= ny*push;
          b.x += nx*push; b.y += ny*push;

          const avn = a.vx*nx + a.vy*ny;
          const bvn = b.vx*nx + b.vy*ny;
          const atx = a.vx - avn*nx, aty = a.vy - avn*ny;
          const btx = b.vx - bvn*nx, bty = b.vy - bvn*ny;
          a.vx = atx + bvn*nx; a.vy = aty + bvn*ny;
          b.vx = btx + avn*nx; b.vy = bty + avn*ny;

          if (audioCtx){
            const t=audioCtx.currentTime;
            if (t - a.lastHit > PAIR_COOLDOWN){ triggerNodeSound(a, 0.55); a.lastHit=t; }
            if (t - b.lastHit > PAIR_COOLDOWN){ triggerNodeSound(b, 0.55); b.lastHit=t; }
          }
        }
      }
    }
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Borde del c√≠rculo (√∫nico y alineado)
    ctx.save();
    const ring = 1.5 * devicePixelRatio;
    ctx.lineWidth = ring;
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--rule').trim() || '#ccc';
    ctx.beginPath();
    ctx.arc(CX, CY, R, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();

    for (const n of nodes){
      ctx.beginPath(); ctx.fillStyle=n.color;
      ctx.arc(n.x,n.y,n.r,0,Math.PI*2); ctx.fill();

      ctx.beginPath(); ctx.fillStyle='rgba(0,0,0,.12)';
      ctx.arc(n.x,n.y,Math.max(1.5*devicePixelRatio,n.r*0.25),0,Math.PI*2);
      ctx.fill();
    }
  }

  let last=performance.now();
  function loop(now){
    requestAnimationFrame(loop);
    const dtMs = now - last; last = now;
    if (paused){ draw(); return; }
    const dt = Math.min(0.03, dtMs/1000); // cap de estabilidad
    step(dt);
    draw();
  }
  requestAnimationFrame(loop);

  // Accesos r√°pidos
  window.addEventListener('keydown', (e)=>{
    if (e.key===' '){ e.preventDefault(); pauseBtn.click(); }
    if (e.key.toLowerCase()==='a'){ document.getElementById('addBtn').click(); }
  });

  // Volumen inicial y a√±o
  document.getElementById('y').textContent = new Date().getFullYear();
  </script>

  <script>
    // Poblar select de notas al final (si no qued√≥ poblado)
    (function(){
      const sel=document.getElementById('noteSelect');
      if (!sel.options.length){
        const N=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        for (let oct=2; oct<=6; oct++){
          for (let i=0;i<12;i++){
            const opt=document.createElement('option');
            const name = `${N[i]}${oct}`;
            const midi = 12*(oct+1)+i;
            opt.value=midi; opt.textContent=name; sel.appendChild(opt);
          }
        }
        sel.value = 57; // A3 por defecto
      }
    })();
  </script>
</body>
</html>