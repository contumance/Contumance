<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Scales Book ‚Äî Contumance</title>
  <meta name="description" content="The Scales Book ‚Äî minimal interactive fretboard with e-ink-style aesthetics." />
  <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚ô™</text></svg>">
  <link rel="stylesheet" href="assets/kindle.css">
  <style>
    .theme-toggle{font-size:1.15rem}

    .controls{display:grid; gap:8px; align-items:center; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); margin-bottom:8px;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    label{font-size:12px; opacity:.9;}
    select,button,input[type="number"],input[type="range"]{
      appearance:none; border:1px solid var(--accent); background:transparent; color:var(--ink);
      padding:10px 12px; border-radius:.5rem; font-family:inherit; font-size:14px; line-height:1; min-width:0;
    }
    button.primary{background:var(--ink); color:var(--paper); border-color:var(--ink);}
    .tuning{display:grid; gap:8px; grid-template-columns:repeat(auto-fit,minmax(210px,1fr));}
    .tuning .string-card{border:1px solid var(--accent); border-radius:.6rem; background:transparent; padding:8px;}
    .octv{display:flex; align-items:center; gap:6px; font-size:12px; opacity:.9}
    .piano-wrap{border:1px solid var(--accent); border-radius:.6rem; background:transparent; margin:14px 0 18px; padding:10px 10px 14px;}
    .piano-head{display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-bottom:6px; font-size:.95rem;}
    .piano-caption{color:var(--muted); font-size:.85rem;}
    .support-note{margin:12px 0 16px;}
    .fretboard{width:100%; border:1px solid var(--accent); border-radius:.6rem; background:transparent;}
    .board{display:grid; grid-auto-rows:minmax(30px,5vh); grid-template-columns:40px repeat(24,1fr); position:relative; width:100%;}
    .string{display:contents;}
    .nut,.fret{border-right:1px solid var(--rule); position:relative;}
    .nut{display:flex; align-items:center; justify-content:center; font-size:12px; background:rgba(0,0,0,.04);}
    html.theme-dark .nut{background:rgba(255,255,255,.06);}
    .open-note{display:flex; align-items:center; justify-content:center; font-size:12px;}
    .cell{position:relative; display:flex; align-items:center; justify-content:center;}
    .fret-number{position:absolute; bottom:2px; right:6px; font-size:10px; opacity:.35;}
    .marker{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;}
    .dot{width:24px; height:24px; border-radius:999px; border:1.5px solid var(--accent-soft); background:transparent; display:flex; align-items:center; justify-content:center; font-size:11px; transition:transform .05s ease, background-color .12s ease;}
    .dot.root{background:var(--ink); color:var(--paper); border-color:var(--ink); font-weight:600;}
    .hit{animation:hit .18s ease;}
    @keyframes hit{ from{ background-color:var(--hit);} to{ background-color:transparent;} }
    .pos-marker{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:6px; height:6px; border-radius:999px; background:#bbb; opacity:.5;}
    .pos-marker.double{display:grid; grid-template-columns:1fr 1fr; gap:8px; width:auto; height:auto; background:transparent;}
    .pos-marker.double i{width:6px; height:6px; background:#bbb; opacity:.5; border-radius:999px; display:block;}
    .footer{margin:30px 0 60px; font-size:12px; color:var(--muted);}
  </style>
</head>
<body>
  <main>
    <div class="topbar">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="index.html">‚Üê Back to index</a>
      </nav>
      <div class="row" style="gap:6px;">
        <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme" title="Toggle theme">üåì</button>
      </div>
    </div>

    <header>
      <h1>The Scales Book</h1>
      <div class="subtitle">Paths that lead the hand to the new colors.</div>
    </header>

    <details class="panel" id="panel" open>
      <summary>Guitar setup</summary>
      <div class="panel-body">
        <div class="controls" role="group" aria-label="Controls">
          <div class="row">
            <label for="stringCount">Strings</label>
            <input id="stringCount" type="number" min="3" max="10" value="6" style="width:86px" />
            <button id="applyStrings">Apply</button>
          </div>
          <div class="row">
            <label for="root">Root</label>
            <select id="root"></select>
          </div>
          <div class="row">
            <label for="scale">Scale</label>
            <select id="scale" disabled>
              <option>Loading scales‚Ä¶</option>
            </select>
          </div>
          <div class="row">
            <label for="labels">Labels</label>
            <select id="labels">
              <option value="notes">Notes</option>
              <option value="degrees">Degrees</option>
              <option value="off">Hidden</option>
            </select>
          </div>
          <div class="row">
            <label for="wave">Wave</label>
            <select id="wave">
              <option>sine</option>
              <option>triangle</option>
              <option>square</option>
              <option>sawtooth</option>
            </select>
          </div>
          <div class="row" style="min-width:190px;">
            <label for="volume">Volume</label>
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.6" style="width:120px;">
          </div>
        </div>
        <div id="tuningPanel" class="tuning" aria-label="Tuning editor"></div>
      </div>
    </details>

    <section class="fretboard-wrap">
      <div id="fretboard" class="fretboard">
        <div id="board" class="board" role="grid" aria-label="Fretboard"></div>
      </div>
    </section>

    <section class="piano-wrap" aria-label="Piano octave">
      <div class="piano-head">
        <div><strong>Piano</strong> - one octave</div>
        <div class="piano-caption" id="pianoCaption">C Major (Ionian)</div>
      </div>
      <div id="pianoContainer" style="width:100%; overflow:hidden;"></div>
    </section>

    <section class="support-note" id="supportInline" aria-label="Support this project">
      <p style="margin:0">
        Did this page help you hear the fretboard differently? If you want to keep <strong>Re:sonance</strong> growing,
        you can <a href="https://buymeacoffee.com/Contumance" target="_blank" rel="noopener noreferrer">buy me a coffee</a>.
        It directly funds more tools and lessons. Thank you ‚ú®
      </p>
      <div class="actions">
        <a class="btn" href="https://buymeacoffee.com/Contumance" target="_blank" rel="noopener noreferrer" aria-label="Buy me a coffee">
          <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 8h14.5a2 2 0 0 1 0 4H18l-1 5a4 4 0 0 1-3.95 3.3H8.95A4 4 0 0 1 5 17l-1-9z"/>
            <path d="M3 8h17"/><path d="M7 4h6"/>
          </svg>
          <span>Buy me a coffee</span>
        </a>
        <button class="dismiss" type="button" id="dismissSupport">Not now</button>
      </div>
    </section>

    <p class="footer">Tip: use ¬± to shift each string by semitones. Everything is saved on this device (no backend).</p>

    <footer>
      <a class="btn" href="https://buymeacoffee.com/Contumance" target="_blank" rel="noopener noreferrer"
         aria-label="Support this library on Buy Me a Coffee">
        <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 8h14.5a2 2 0 0 1 0 4H18l-1 5a4 4 0 0 1-3.95 3.3H8.95A4 4 0 0 1 5 17l-1-9z"/>
          <path d="M3 8h17"/>
          <path d="M7 4h6"/>
        </svg>
        <span>Buy me a coffee</span>
      </a>
      <span class="note">Fuel the craft. Inspire the next page.</span>
      <span>¬© <span id="y"></span> Re:sonance <small class="byline">by <em>Contumance</em></small></span>
    </footer>
  </main>

  <!-- Theme toggle -->
  <script>
    (function(){
      const KEY='theme-preference';
      const root=document.documentElement;
      const btn=document.getElementById('themeToggle');
      function setIcon(mode){ btn.textContent = '‚óë'; }
      function apply(mode){ root.classList.toggle('theme-dark',mode==='dark'); setIcon(mode); }
      function getPreferred(){
        const saved=localStorage.getItem(KEY);
        if(saved==='light'||saved==='dark') return saved;
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light';
      }
      let current=getPreferred(); apply(current);
      btn.addEventListener('click',()=>{ current=current==='dark'?'light':'dark'; localStorage.setItem(KEY,current); apply(current); });
      document.getElementById('y').textContent = new Date().getFullYear();
    })();
  </script>

  <!-- Support inline logic (2 days, page-scoped + force flag) -->
  <script>
    (function supportInlineLogic(){
      const el  = document.getElementById('supportInline');
      const btn = document.getElementById('dismissSupport');
      if(!el || !btn) return;

      const FORCE = /[?&]support=1\b/.test(location.search) || location.hash === '#support';
      const KEY = 'support-note:scales:v1:dismissedUntil';
      const now = Date.now();
      const until = Number(localStorage.getItem(KEY) || 0);
      if (!FORCE && now < until) { el.style.display = 'none'; return; }
      el.style.display = 'block';
      btn.addEventListener('click', () => {
        const someDaysMs = 2 * 24 * 60 * 60 * 1000;
        localStorage.setItem(KEY, String(Date.now() + someDaysMs));
        el.style.display = 'none';
      });
    })();
  </script>

  <!-- Main app -->
  <script>
    (function(){
      // ------- Musical data -------
      const NOTES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      // SCALES ahora viene del JSON externo
      let SCALES = {};               // mapa nombre ‚Üí [intervalos]
      let SCALES_READY = false;      // flag
      const SCALES_URL = 'scales.json'; // mismo directorio

      // ------- State & persistence -------
      const DEFAULT_TUNING_6 = ["E","B","G","D","A","E"]; // 1st (highest) on top
      const DEFAULT_OCTAVES_6 = [4,3,3,3,2,2]; // E4,B3,G3,D3,A2,E2
      const LS_KEY="the_scales_book_state_v2_audio";

      const state = {
        strings:6,
        tuning:DEFAULT_TUNING_6.slice(),
        octaves:DEFAULT_OCTAVES_6.slice(),
        root:"C", scaleName:"Major (Ionian)", labelMode:"notes",
        wave:"sine", volume:0.6
      };
      try{
        const saved=JSON.parse(localStorage.getItem(LS_KEY)||"null");
        if(saved&&typeof saved==="object") Object.assign(state,saved);
      }catch(e){}
      function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

      // ------- DOM refs -------
      const board=document.getElementById("board");
      const rootSel=document.getElementById("root");
      const scaleSel=document.getElementById("scale");
      const labelsSel=document.getElementById("labels");
      const tuningPanel=document.getElementById("tuningPanel");
      const stringCountInput=document.getElementById("stringCount");
      const applyStringsBtn=document.getElementById("applyStrings");
      const pianoContainer=document.getElementById("pianoContainer");
      const pianoCaption=document.getElementById("pianoCaption");
      const waveSel=document.getElementById("wave");
      const volSlider=document.getElementById("volume");

      // ------- Helpers -------
      function noteIndex(name){ return NOTES_SHARP.indexOf(name); }
      function cycleNote(note, step){ let i=noteIndex(note); if(i<0) i=0; i=(i+step+12)%12; return NOTES_SHARP[i]; }
      function ensureTuningLen(n){
        if (!Array.isArray(state.tuning)) state.tuning = [];
        if (!Array.isArray(state.octaves)) state.octaves = [];
        while (state.tuning.length < n) {
          const i = state.tuning.length;
          const prevNote = (i > 0) ? state.tuning[i - 1] : "E";
          const prevOct  = (i > 0) ? (state.octaves[i - 1] ?? 2) : 2; // E2
          let prevPc = noteIndex(prevNote); if (prevPc < 0) prevPc = 4; // E
          let newPc = prevPc - 5; let octave = prevOct;
          if (newPc < 0) { newPc += 12; octave -= 1; }
          state.tuning.push(NOTES_SHARP[newPc]); state.octaves.push(octave);
        }
        if (state.tuning.length > n) { state.tuning.splice(n); state.octaves.splice(n); }
      }
      function inScale(pc, rootIdx, scale){ const rel=(pc-rootIdx+12)%12; return scale.indexOf(rel)!==-1; }
      function fillSelect(el, arr){ el.innerHTML = arr.map(v=>'<option value="'+v+'">'+v+'</option>').join(''); }

      // ------- AUDIO ENGINE (Web Audio) -------
      const AudioEngine = (function(){
        let ctx=null, master=null, started=false, currentWave = state.wave || "sine";
        function midiToFreq(m){ return 440 * Math.pow(2, (m-69)/12); }
        function noteToMidi(name, octave){ const pc=noteIndex(name); if(pc<0) return 60; return (octave+1)*12 + pc; }
        function start(){ if(started) return; ctx = new (window.AudioContext||window.webkitAudioContext)(); master = ctx.createGain(); master.gain.value = state.volume; master.connect(ctx.destination); started=true; }
        function resumeMaybe(){ if(ctx && ctx.state==="suspended") ctx.resume(); }
        function setVolume(v){ if(master) master.gain.value=v; }
        function setWave(w){ currentWave=w; }
        function playFreq(freq, opts){
          if(!started) start(); resumeMaybe();
          const t=ctx.currentTime, o=ctx.createOscillator(), g=ctx.createGain();
          const A=0.01, D=0.08, S=0.75, R=0.15;
          const vel = (opts && opts.vel)!=null ? opts.vel : 0.9;
          g.gain.setValueAtTime(0, t);
          g.gain.linearRampToValueAtTime(vel, t+A);
          g.gain.linearRampToValueAtTime(vel*S, t+A+D);
          o.type = currentWave; o.frequency.setValueAtTime(freq, t);
          o.connect(g); g.connect(master); o.start(t);
          const dur = (opts && opts.dur) || 0.6, end = t + dur;
          g.gain.setTargetAtTime(0.0001, end, R);
          o.stop(end + R*3);
        }
        function playNote(name, octave, opts){ const midi = noteToMidi(name, octave); playFreq(midiToFreq(midi), opts); }
        return {start,setVolume,setWave,playNote,noteToMidi};
      })();

      // ------- Tuning editor -------
      function renderTuningEditor(){
        ensureTuningLen(state.strings);
        let html="";
        for(let idx=0; idx<state.tuning.length; idx++){
          const note=state.tuning[idx], stringNum=idx+1, oct=state.octaves[idx] ?? 3;
          const opts=NOTES_SHARP.map(n=>'<option value="'+n+'"'+(n===note?' selected':'')+'>'+n+'</option>').join('');
          html+= '<div class="string-card">'
               +   '<div style="font-size:12px; opacity:.8; margin-bottom:6px;">String '+stringNum+'</div>'
               +   '<div class="row" style="gap:6px; flex-wrap:nowrap;">'
               +     '<button data-act="down" data-idx="'+idx+'" title="Lower note">‚àí</button>'
               +     '<div class="open-note" style="min-width:40px; text-align:center">'+note+'</div>'
               +     '<button data-act="up" data-idx="'+idx+'" title="Raise note">+</button>'
               +     '<select data-act="set" data-idx="'+idx+'" style="flex:1; min-width:0;">'+opts+'</select>'
               +   '</div>'
               +   '<div class="octv">'
               +     '<label>Octave</label>'
               +     '<button data-act="octDown" data-idx="'+idx+'" title="Octave -1">‚àí</button>'
               +     '<span id="oct'+idx+'" style="min-width:1.5ch; text-align:center;">'+oct+'</span>'
               +     '<button data-act="octUp" data-idx="'+idx+'" title="Octave +1">+</button>'
               +   '</div>'
               + '</div>';
        }
        tuningPanel.innerHTML=html;
        tuningPanel.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click',()=>{
            const i=+btn.dataset.idx; const act=btn.dataset.act;
            if(act==='up'||act==='down'){ state.tuning[i]=cycleNote(state.tuning[i], act==='up'?+1:-1); }
            else if(act==='octUp'){ state.octaves[i]=Math.min(8, (state.octaves[i]??3)+1); }
            else if(act==='octDown'){ state.octaves[i]=Math.max(-2, (state.octaves[i]??3)-1); }
            save(); renderTuningEditor(); renderBoard();
          }, {passive:true});
        });
        tuningPanel.querySelectorAll('select').forEach(sel=>{
          sel.addEventListener('change', ()=>{ const i=+sel.dataset.idx; state.tuning[i]=sel.value; save(); renderBoard(); });
        });
      }

      // ------- Fretboard render -------
      const FRETS=24;
      function renderBoard(){
        if(!SCALES_READY) return; // no render hasta que lleguen las escalas
        board.innerHTML="";
        const markerCols=new Set([3,5,7,9,12,15,17,19,21,24]);
        const scale=SCALES[state.scaleName] || [];
        const rootIdx=noteIndex(state.root);
        const degreeBySemitone=new Map();
        scale.forEach((off,i)=>degreeBySemitone.set(off%12, String(i+1)));

        for(let s=0; s<state.strings; s++){
          const openName = state.tuning[s];
          const openOct  = state.octaves[s] ?? 3;
          const openIdx=noteIndex(openName);
          const stringRow=document.createElement('div'); stringRow.className='string';

          const nut=document.createElement('div'); nut.className='nut open-note';
          if(s>0) nut.style.borderTop='1px solid var(--rule)';
          const labelSpan=document.createElement('span'); labelSpan.textContent=openName; nut.appendChild(labelSpan);

          const openSemitone=openIdx%12;
          if(inScale(openSemitone, rootIdx, scale)){
            const m0=document.createElement('div'); m0.className='marker';
            const d0=document.createElement('div'); d0.className='dot'; d0.dataset.note=openName; d0.dataset.oct=openOct; d0.dataset.src='nut';
            if(((openSemitone-rootIdx+12)%12)===0) d0.classList.add('root');
            let label0="";
            if(state.labelMode==='notes') label0=openName;
            else if(state.labelMode==='degrees'){ const rel0=(openSemitone-rootIdx+12)%12; label0=degreeBySemitone.get(rel0)||""; }
            d0.textContent=label0; m0.appendChild(d0); nut.appendChild(m0);
            d0.style.pointerEvents='auto'; d0.tabIndex=0;
          }
          stringRow.appendChild(nut);

          for(let f=1; f<=FRETS; f++){
            const cell=document.createElement('div'); cell.className='fret cell';
            if(s>0) cell.style.borderTop='1px solid var(--rule)';
            const semitone=(openIdx+f)%12;
            if(inScale(semitone, rootIdx, scale)){
              const m=document.createElement('div'); m.className='marker';
              const dot=document.createElement('div'); dot.className='dot';
              dot.dataset.note=NOTES_SHARP[semitone];
              const midiOpen = AudioEngine.noteToMidi(openName, openOct);
              const midiFret = midiOpen + f;
              const oct = Math.floor(midiFret/12) - 1;
              dot.dataset.oct=oct;
              if(((semitone-rootIdx+12)%12)===0) dot.classList.add('root');
              let label="";
              if(state.labelMode==='notes') label=NOTES_SHARP[semitone];
              else if(state.labelMode==='degrees'){ const rel=(semitone-rootIdx+12)%12; label=degreeBySemitone.get(rel)||""; }
              dot.textContent=label; m.appendChild(dot); cell.appendChild(m);
              dot.style.pointerEvents='auto'; dot.tabIndex=0;
            }
            if(s===state.strings-1){
              const num=document.createElement('div'); num.className='fret-number'; num.textContent=f; cell.appendChild(num);
              if(markerCols.has(f)){
                const pm=document.createElement('div');
                if(f===12||f===24){ pm.className='pos-marker double'; const i1=document.createElement('i'); const i2=document.createElement('i'); pm.appendChild(i1); pm.appendChild(i2); }
                else { pm.className='pos-marker'; }
                cell.appendChild(pm);
              }
            }
            stringRow.appendChild(cell);
          }
          board.appendChild(stringRow);
        }

        // play handlers
        board.querySelectorAll('.dot').forEach(dot=>{
          dot.addEventListener('pointerdown', ()=>{
            AudioEngine.playNote(dot.dataset.note, parseInt(dot.dataset.oct,10), {dur:0.5});
            dot.classList.add('hit'); setTimeout(()=>dot.classList.remove('hit'), 160);
          }, {passive:true});
          dot.addEventListener('keydown', e=>{
            if(e.key==='Enter' || e.key===' '){
              AudioEngine.playNote(dot.dataset.note, parseInt(dot.dataset.oct,10), {dur:0.5});
              dot.classList.add('hit'); setTimeout(()=>dot.classList.remove('hit'), 160);
            }
          });
        });

        renderPiano();
      }

      // ------- Piano (SVG, one octave C4‚ÄìC5) -------
      const WHITE = ["C","D","E","F","G","A","B"];
      const WHITE_PC = WHITE.map(n=>NOTES_SHARP.indexOf(n));
      const BLACK_AT = [0,1,3,4,5];
      const BLACK_NAMES = ["C#","D#","F#","G#","A#"];
      const BLACK_PC = BLACK_NAMES.map(n=>NOTES_SHARP.indexOf(n));

      function renderPiano(){
        if(!SCALES_READY) return;
        const w = pianoContainer.clientWidth || 520;
        const h = 160;
        const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("viewBox","0 0 "+w+" "+h);
        svg.setAttribute("width","100%");
        svg.setAttribute("height","auto");
        svg.setAttribute("role","img");
        svg.setAttribute("aria-label","Piano octave showing scale tones");

        const cs = getComputedStyle(document.documentElement);
        const ink = cs.getPropertyValue('--ink').trim() || '#2f2a1e';
        const paper = cs.getPropertyValue('--paper').trim() || '#f5f1e8';
        const accent = cs.getPropertyValue('--accent').trim() || '#a08a63';

        const pad = 10;
        const innerW = w - pad*2;
        const whiteW = innerW / 7.2;
        const whiteH = h - pad*2;
        const blackW = whiteW * 0.58;
        const blackH = whiteH * 0.58;
        const blackShift = whiteW * 0.74;

        const scale = SCALES[state.scaleName] || [];
        const rootIdx = noteIndex(state.root);
        const inScaleSet = new Set(scale.map(off => (rootIdx + off) % 12));

        pianoCaption.textContent = state.root + " " + state.scaleName;

        function attachPlay(el, name, octave){
          el.style.cursor='pointer';
          el.addEventListener('pointerdown', ()=>{ AudioEngine.playNote(name, octave, {dur:0.5}); }, {passive:true});
        }

        // White keys
        WHITE_PC.forEach((pc,i)=>{
          const x = pad + i*whiteW;
          const rect = document.createElementNS(svg.namespaceURI,"rect");
          rect.setAttribute("x",x); rect.setAttribute("y",pad);
          rect.setAttribute("width",whiteW); rect.setAttribute("height",whiteH);
          rect.setAttribute("fill",paper); rect.setAttribute("stroke",accent); rect.setAttribute("stroke-width","1"); rect.setAttribute("rx","4");
          svg.appendChild(rect);

          const label = document.createElementNS(svg.namespaceURI,"text");
          label.setAttribute("x", x + whiteW/2); label.setAttribute("y", pad + whiteH - 8);
          label.setAttribute("font-size","10"); label.setAttribute("text-anchor","middle"); label.setAttribute("fill",accent);
          label.textContent = WHITE[i]; svg.appendChild(label);

          if (inScaleSet.has(pc)){
            const cx = x + whiteW/2, cy = pad + whiteH * 0.75;
            const circle = document.createElementNS(svg.namespaceURI,"circle");
            circle.setAttribute("cx",cx); circle.setAttribute("cy",cy); circle.setAttribute("r",whiteW*0.15);
            circle.setAttribute("stroke",ink); circle.setAttribute("stroke-width","2"); circle.setAttribute("fill","none");
            if (pc === rootIdx){ circle.setAttribute("fill",ink); }
            svg.appendChild(circle);
          }
          attachPlay(rect, WHITE[i], 4);
        });

        // Black keys
        BLACK_PC.forEach((pc,j)=>{
          const afterWhite = BLACK_AT[j];
          const xLeft = pad + afterWhite*whiteW;
          const x = xLeft + blackShift - blackW/2;
          const y = pad;
          const rect = document.createElementNS(svg.namespaceURI,"rect");
          rect.setAttribute("x",x); rect.setAttribute("y",y);
          rect.setAttribute("width",blackW); rect.setAttribute("height",blackH);
          rect.setAttribute("rx","3"); rect.setAttribute("fill",ink);
          rect.setAttribute("stroke",accent); rect.setAttribute("stroke-width","1");
          svg.appendChild(rect);

          if (inScaleSet.has(pc)){
            const cx = x + blackW/2, cy = y + blackH * 0.55;
            const circ = document.createElementNS(svg.namespaceURI,"circle");
            circ.setAttribute("cx",cx); circ.setAttribute("cy",cy); circ.setAttribute("r",blackW*0.23);
            circ.setAttribute("stroke",paper); circ.setAttribute("stroke-width","2"); circ.setAttribute("fill","none");
            if (pc === rootIdx){ circ.setAttribute("fill",paper); }
            svg.appendChild(circ);
          }
          attachPlay(rect, BLACK_NAMES[j], 4);
        });

        pianoContainer.innerHTML=""; pianoContainer.appendChild(svg);
      }

      // ------- Events -------
      rootSel.addEventListener('change', () => { state.root = rootSel.value; save(); renderBoard(); });
      labelsSel.addEventListener('change', () => { state.labelMode = labelsSel.value; save(); renderBoard(); });
      applyStringsBtn.addEventListener('click', () => {
        const n = Math.max(3, Math.min(10, parseInt(stringCountInput.value || 6, 10)));
        state.strings = n; ensureTuningLen(n); save(); renderTuningEditor(); renderBoard();
      });
      waveSel.addEventListener('change', ()=>{ state.wave=waveSel.value; save(); AudioEngine.setWave(state.wave); });
      volSlider.addEventListener('input', ()=>{ state.volume=parseFloat(volSlider.value); save(); AudioEngine.setVolume(state.volume); });

      // ------- Init (roots ya disponibles) -------
      fillSelect(rootSel, NOTES_SHARP);
      rootSel.value = state.root;
      waveSel.value = state.wave; volSlider.value = state.volume; labelsSel.value = state.labelMode; stringCountInput.value=state.strings;

      // ------- Carga externa de escalas -------
      async function loadScales(){
        try{
          const res = await fetch(SCALES_URL, {cache:'no-cache'});
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          // Aceptamos objeto plano {name:[...], ...}
          if(Object.prototype.toString.call(data) === '[object Object]'){
            SCALES = data;
          }else{
            throw new Error('Formato inv√°lido en scales.json');
          }

          // Poblar select y validar estado
          const names = Object.keys(SCALES);
          if(names.length === 0) throw new Error('scales.json est√° vac√≠o');

          // Si la escala guardada no existe en el JSON, usar la primera
          if(!SCALES[state.scaleName]) state.scaleName = names[0];

          fillSelect(scaleSel, names);
          scaleSel.value = state.scaleName;
          scaleSel.disabled = false;

          // Evento de cambio (ahora que hay datos)
          scaleSel.addEventListener('change', ()=>{ state.scaleName = scaleSel.value; save(); renderBoard(); });

          SCALES_READY = true;
          renderTuningEditor();
          renderBoard();
        }catch(err){
          console.error('Error cargando scales.json', err);
          // Fallback m√≠nimo para no romper la UI
          SCALES = {
            "Major (Ionian)": [0,2,4,5,7,9,11],
            "Natural minor (Aeolian)": [0,2,3,5,7,8,10],
            "Pentatonic minor": [0,3,5,7,10]
          };
          const names = Object.keys(SCALES);
          if(!SCALES[state.scaleName]) state.scaleName = names[0];
          fillSelect(scaleSel, names);
          scaleSel.value = state.scaleName;
          scaleSel.disabled = false;
          scaleSel.addEventListener('change', ()=>{ state.scaleName = scaleSel.value; save(); renderBoard(); });
          SCALES_READY = true;
          renderTuningEditor();
          renderBoard();

          // Mensaje suave al usuario
          const msg = document.createElement('p');
          msg.style.color = 'var(--muted)';
          msg.style.fontSize = '.9rem';
          msg.style.marginTop = '8px';
          msg.textContent = 'Could not load scales.json. Using a minimal fallback.';
          document.querySelector('.controls')?.appendChild(msg);
        }
      }

      // Keep piano crisp on resize
      let rT; window.addEventListener('resize', ()=>{ clearTimeout(rT); rT=setTimeout(renderPiano, 120); });

      // Lanzar carga
      loadScales();
    })();
  </script>
</body>
</html>