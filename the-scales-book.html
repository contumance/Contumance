<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Scales Book ‚Äî Contumance</title>
  <meta name="description" content="The Scales Book ‚Äî minimal interactive fretboard with e-ink-style aesthetics." />
  <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚ô™</text></svg>">
  <style>
    :root{
      --paper:#f5f1e8; --ink:#2f2a1e; --muted:#6b6253;
      --link:#2d5842; --link-visited:#514f7a;
      --accent:#a08a63; --rule:#d8d2c2; --accent-soft:#999;
      --maxw:42rem; --radius:14px; --lh:1.6; --fs-base:18px;
      --hit:#d9c8a6;
    }
    html.theme-dark{
      --paper:#10110f; --ink:#dbd6c9; --muted:#a39c8c;
      --link:#a9d0b8; --link-visited:#c0b8e0;
      --accent:#2a2b27; --rule:#2a2b27; --accent-soft:#7f7a6b;
      --hit:#2a2a22;
    }
    html{font-size:var(--fs-base)}
    body{
      margin:0; padding:0; color:var(--ink); background:var(--paper);
      font-family:ui-serif, Georgia, "Iowan Old Style", "Palatino Linotype", Palatino, serif;
      line-height:var(--lh); text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased;
    }
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.06;
      background-image:
        radial-gradient(circle at 25% 15%, #000 0.5px, transparent 0.5px),
        radial-gradient(circle at 75% 85%, #000 0.5px, transparent 0.5px);
      background-size:3px 3px, 3px 3px; mix-blend-mode:multiply;
    }
    main{max-width:var(--maxw); margin:0 auto; padding:7vh 1.25rem 4rem;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem;}
    nav.breadcrumb{font-size:.95rem}
    nav.breadcrumb a{color:var(--link); text-decoration:none; text-underline-offset:2px;}
    h1{margin:.2rem 0 .3rem 0; font-weight:600; font-size:clamp(1.6rem,4vw,2.2rem);}
    .subtitle{color:var(--muted); font-size:.95rem; margin-bottom:.8rem;}
    .theme-toggle{
      border:1px solid var(--accent); background:transparent; color:var(--ink);
      border-radius:.45rem; padding:.35rem .55rem; cursor:pointer; font-size:1.15rem; line-height:1;
    }
    .theme-toggle:focus-visible{outline:2px dashed var(--accent); outline-offset:2px;}
    hr{border:none; border-top:1px solid var(--accent); margin:1.25rem 0; opacity:.5;}
    details.panel{border:1px solid var(--accent); border-radius:.6rem; background:rgba(255,255,255,.6);}
    html.theme-dark details.panel{background:rgba(0,0,0,.1);}
    details.panel>summary{cursor:pointer; list-style:none; padding:.6rem .8rem; font-size:.95rem; font-weight:600; color:var(--ink);}
    details.panel>summary::-webkit-details-marker{display:none;}
    details.panel .panel-body{padding:.6rem .8rem .9rem;}
    .controls{display:grid; gap:8px; align-items:center; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); margin-bottom:8px;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    label{font-size:12px; opacity:.9;}
    select,button,input[type="number"],input[type="range"]{
      appearance:none; border:1px solid var(--accent); background:transparent; color:var(--ink);
      padding:10px 12px; border-radius:.5rem; font-family:inherit; font-size:14px; line-height:1; min-width:0;
    }
    button.primary{background:var(--ink); color:var(--paper); border-color:var(--ink);}
    .tuning{display:grid; gap:8px; grid-template-columns:repeat(auto-fit,minmax(210px,1fr));}
    .tuning .string-card{border:1px solid var(--accent); border-radius:.6rem; background:transparent; padding:8px;}
    .octv{display:flex; align-items:center; gap:6px; font-size:12px; opacity:.9}

    .piano-wrap{
      border:1px solid var(--accent); border-radius:.6rem; background:transparent;
      margin:14px 0 18px; padding:10px 10px 14px;
    }
    .piano-head{display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-bottom:6px; font-size:.95rem;}
    .piano-caption{color:var(--muted); font-size:.85rem;}

    .fretboard{width:100%; border:1px solid var(--accent); border-radius:.6rem; background:transparent;}
    .board{display:grid; grid-auto-rows:minmax(30px,5vh); grid-template-columns:40px repeat(24,1fr); position:relative; width:100%;}
    .string{display:contents;}
    .nut,.fret{border-right:1px solid var(--rule); position:relative;}
    .nut{display:flex; align-items:center; justify-content:center; font-size:12px; background:rgba(0,0,0,.04);}
    html.theme-dark .nut{background:rgba(255,255,255,.06);}
    .open-note{display:flex; align-items:center; justify-content:center; font-size:12px;}
    .cell{position:relative; display:flex; align-items:center; justify-content:center;}
    .fret-number{position:absolute; bottom:2px; right:6px; font-size:10px; opacity:.35;}
    .marker{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;}
    .dot{width:24px; height:24px; border-radius:999px; border:1.5px solid var(--accent-soft); background:transparent; display:flex; align-items:center; justify-content:center; font-size:11px; transition:transform .05s ease, background-color .12s ease;}
    .dot.root{background:var(--ink); color:var(--paper); border-color:var(--ink); font-weight:600;}
    .hit{animation:hit .18s ease;}
    @keyframes hit{ from{ background-color:var(--hit);} to{ background-color:transparent;} }
    .pos-marker{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:6px; height:6px; border-radius:999px; background:#bbb; opacity:.5;}
    .pos-marker.double{display:grid; grid-template-columns:1fr 1fr; gap:8px; width:auto; height:auto; background:transparent;}
    .pos-marker.double i{width:6px; height:6px; background:#bbb; opacity:.5; border-radius:999px; display:block;}
    .footer{margin:30px 0 60px; font-size:12px; color:var(--muted);}
    @media (prefers-reduced-motion:no-preference){
      a{position:relative; background-image:linear-gradient(currentColor,currentColor); background-position:0 100%;
        background-repeat:no-repeat; background-size:0% 1px; transition:background-size .25s ease, color .2s ease;}
      a:hover, a:focus-visible{background-size:100% 1px; outline:none;}
    }
    footer{
      margin-top:2.5rem; font-size:.95rem; color:var(--muted);
      display:flex; gap:.75rem; align-items:center; flex-wrap:wrap
    }
    .btn{border:1px solid var(--accent); padding:.5rem .8rem; border-radius:.35rem; text-decoration:none}
    .note{width:100%; color:var(--muted); font-style:italic; margin-top:.35rem}
  </style>
</head>
<body>
  <main>
    <div class="topbar">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="index.html">‚Üê Back to index</a>
      </nav>
      
        <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme" title="Toggle theme">üåì</button>
          
          <div class="row" style="gap:6px;">
        
        <!-- Sound controls 
        <button id="audioEnable" class="theme-toggle" title="Enable sound">üîà Enable sound</button>
        -->
      </div>
    </div>

    <header>
      <h1>The Scales Book</h1>
      <div class="subtitle">Minimal interactive fretboard for learning scales (3‚Äì10 strings, up to 24 frets).</div>
    </header>

    <details class="panel" id="panel" open>
      <summary>Guitar setup</summary>
      <div class="panel-body">
        <div class="controls" role="group" aria-label="Controls">
          <div class="row">
            <label for="stringCount">Strings</label>
            <input id="stringCount" type="number" min="3" max="10" value="6" style="width:86px" />
            <button id="applyStrings">Apply</button>
          </div>
          <div class="row">
            <label for="root">Root</label>
            <select id="root"></select>
          </div>
          <div class="row">
            <label for="scale">Scale</label>
            <select id="scale"></select>
          </div>
          <div class="row">
            <label for="labels">Labels</label>
            <select id="labels">
              <option value="notes">Notes</option>
              <option value="degrees">Degrees</option>
              <option value="off">Hidden</option>
            </select>
          </div>
          <!-- synth extras -->
          <div class="row">
            <label for="wave">Wave</label>
            <select id="wave">
              <option>sine</option>
              <option>triangle</option>
              <option>square</option>
              <option>sawtooth</option>
            </select>
          </div>
          <div class="row" style="min-width:190px;">
            <label for="volume">Volume</label>
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.6" style="width:120px;">
          </div>
        </div>
        <div id="tuningPanel" class="tuning" aria-label="Tuning editor"></div>
      </div>
    </details>

    <section class="fretboard-wrap">
      <div id="fretboard" class="fretboard">
        <div id="board" class="board" role="grid" aria-label="Fretboard"></div>
      </div>
    </section>

    <!-- ===== Piano (one octave C‚ÄìC) ===== -->
    <section class="piano-wrap" aria-label="Piano octave">
      <div class="piano-head">
        <div><strong>Piano</strong> - one octave</div>
        <div class="piano-caption" id="pianoCaption">C Major (Ionian)</div>
      </div>
      <div id="pianoContainer" style="width:100%; overflow:hidden;"></div>
    </section>

    <p class="footer">Tip: use ¬± to shift each string by semitones. Everything is saved on this device (no backend).</p>

    <footer>
      <a class="btn" href="YOUR_CAFECITO_URL" target="_blank" rel="noopener">Invite me a coffee ‚òï</a>
      <span class="note">Fuel the craft. Inspire the next page.</span>
      <span>¬© <span id="y"></span> Contumance</span>
    </footer>
  </main>

  <script>
    // --- Theme toggle ---
    (function(){
      const KEY='theme-preference';
      const root=document.documentElement;
      const btn=document.getElementById('themeToggle');
      function setIcon(mode){ btn.textContent = '‚óë'; }
      function apply(mode){ root.classList.toggle('theme-dark',mode==='dark'); setIcon(mode); }
      function getPreferred(){
        const saved=localStorage.getItem(KEY);
        if(saved==='light'||saved==='dark') return saved;
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light';
      }
      let current=getPreferred(); apply(current);
      btn.addEventListener('click',()=>{ current=current==='dark'?'light':'dark'; localStorage.setItem(KEY,current); apply(current); });
    })();
  </script>

  <script>
    (function(){
      // ------- Musical data -------
      var NOTES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      var SCALES = {
        "Major (Ionian)": [0,2,4,5,7,9,11],
        "Natural minor (Aeolian)": [0,2,3,5,7,8,10],
        "Harmonic minor": [0,2,3,5,7,8,11],
        "Melodic minor (asc)": [0,2,3,5,7,9,11],
        "Pentatonic major": [0,2,4,7,9],
        "Pentatonic minor": [0,3,5,7,10],
        "Blues minor": [0,3,5,6,7,10],
        "Dorian": [0,2,3,5,7,9,10],
        "Phrygian": [0,1,3,5,7,8,10],
        "Lydian": [0,2,4,6,7,9,11],
        "Mixolydian": [0,2,4,5,7,9,10],
        "Locrian": [0,1,3,5,6,8,10],
        "Whole tone": [0,2,4,6,8,10],
        "Chromatic": [0,1,2,3,4,5,6,7,8,9,10,11]
      };
      var DEFAULT_TUNING_6 = ["E","B","G","D","A","E"]; // 1st (highest) on top
      var DEFAULT_OCTAVES_6 = [4,3,3,3,2,2]; // E4,B3,G3,D3,A2,E2

      // ------- State & persistence -------
      var state = {
        strings:6,
        tuning:DEFAULT_TUNING_6.slice(),
        octaves:DEFAULT_OCTAVES_6.slice(),
        root:"C", scaleName:"Major (Ionian)", labelMode:"notes",
        wave:"sine", volume:0.6
      };
      var LS_KEY="the_scales_book_state_v2_audio";
      try{ var saved=JSON.parse(localStorage.getItem(LS_KEY)||"null"); if(saved&&typeof saved==="object") Object.assign(state,saved);}catch(e){}
      function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

      // ------- DOM refs -------
      var board=document.getElementById("board");
      var rootSel=document.getElementById("root");
      var scaleSel=document.getElementById("scale");
      var labelsSel=document.getElementById("labels");
      var tuningPanel=document.getElementById("tuningPanel");
      var stringCountInput=document.getElementById("stringCount");
      var applyStringsBtn=document.getElementById("applyStrings");
      var pianoContainer=document.getElementById("pianoContainer");
      var pianoCaption=document.getElementById("pianoCaption");
      var audioEnableBtn=document.getElementById("audioEnable");
      var waveSel=document.getElementById("wave");
      var volSlider=document.getElementById("volume");

      // ------- Helpers -------
      function noteIndex(name){ return NOTES_SHARP.indexOf(name); }
      function cycleNote(note, step){ var i=noteIndex(note); if(i<0) i=0; i=(i+step+12)%12; return NOTES_SHARP[i]; }
      function ensureLen(arr, n, fill){
        if(arr.length<n){ while(arr.length<n) arr.push(fill); }
        else if(arr.length>n){ arr.splice(n); }
      }
      function ensureTuningLen(n){
        ensureLen(state.tuning, n, state.tuning[state.tuning.length-1]||"E");
        ensureLen(state.octaves, n, 3);
      }
      function inScale(pc, rootIdx, scale){ var rel=(pc-rootIdx+12)%12; return scale.indexOf(rel)!==-1; }

      // ------- Populate selects -------
      function fillSelect(el, arr){ el.innerHTML = arr.map(v=>'<option value="'+v+'">'+v+'</option>').join(''); }
      fillSelect(rootSel, NOTES_SHARP);
      fillSelect(scaleSel, Object.keys(SCALES));
      rootSel.value=state.root; scaleSel.value=state.scaleName; stringCountInput.value=state.strings; labelsSel.value=state.labelMode;
      waveSel.value=state.wave; volSlider.value=state.volume;

      // ====== AUDIO ENGINE (Web Audio) ======
      var AudioEngine = (function(){
        let ctx=null, master=null;
        let started=false;
        const A4=440; // reference
        function midiToFreq(m){ return 440 * Math.pow(2, (m-69)/12); }
        function noteToMidi(name, octave){
          const pc=noteIndex(name); if(pc<0) return 60; // fallback C4
          // MIDI formula with C-1 = 0 => C4=60, A4=69
          return (octave+1)*12 + pc;
        }
        function start(){
          if(started) return;
          ctx = new (window.AudioContext||window.webkitAudioContext)();
          master = ctx.createGain(); master.gain.value = state.volume;
          master.connect(ctx.destination);
          started=true;
        }
        function resumeMaybe(){ if(ctx && ctx.state==="suspended") ctx.resume(); }
        function setVolume(v){ if(master) master.gain.value=v; }
        function setWave(w){ currentWave=w; }
        let currentWave = state.wave || "sine";

        function playFreq(freq, opts){
          if(!started) return;
          resumeMaybe();
          const t=ctx.currentTime;
          const o=ctx.createOscillator();
          const g=ctx.createGain();

          // Envelope
          const A=0.01, D=0.08, S=0.75, R=0.15;
          const vel = (opts && opts.vel)!=null ? opts.vel : 0.9;
          g.gain.setValueAtTime(0, t);
          g.gain.linearRampToValueAtTime(vel, t+A);
          g.gain.linearRampToValueAtTime(vel*S, t+A+D);

          o.type = currentWave;
          o.frequency.setValueAtTime(freq, t);

          o.connect(g); g.connect(master);
          o.start(t);

          // auto release
          const dur = (opts && opts.dur) || 0.6;
          const end = t + dur;
          g.gain.setTargetAtTime(0.0001, end, R);
          o.stop(end + R*3);
        }

        function playNote(name, octave, opts){
          const midi = noteToMidi(name, octave);
          const freq = midiToFreq(midi);
          playFreq(freq, opts);
        }

        return {start, setVolume, setWave, playNote, noteToMidi};
      })();

      // Unlock on button (and any first interaction)
      audioEnableBtn.addEventListener('click', function(){
        AudioEngine.start();
        audioEnableBtn.textContent = 'üîä Sound on';
        audioEnableBtn.disabled = true;
      }, {passive:true});

      // ------- Tuning editor (now with octave) -------
      function renderTuningEditor(){
        ensureTuningLen(state.strings);
        var html="";
        for(var idx=0; idx<state.tuning.length; idx++){
          var note=state.tuning[idx], stringNum=idx+1, oct=state.octaves[idx] ?? 3;
          var opts=NOTES_SHARP.map(n=>'<option value="'+n+'"'+(n===note?' selected':'')+'>'+n+'</option>').join('');
          html+= '<div class="string-card">'
               +   '<div style="font-size:12px; opacity:.8; margin-bottom:6px;">String '+stringNum+'</div>'
               +   '<div class="row" style="gap:6px; flex-wrap:nowrap;">'
               +     '<button data-act="down" data-idx="'+idx+'" title="Lower note">‚àí</button>'
               +     '<div class="open-note" style="min-width:40px; text-align:center">'+note+'</div>'
               +     '<button data-act="up" data-idx="'+idx+'" title="Raise note">+</button>'
               +     '<select data-act="set" data-idx="'+idx+'" style="flex:1; min-width:0;">'+opts+'</select>'
               +   '</div>'
               +   '<div class="octv">'
               +     '<label>Octave</label>'
               +     '<button data-act="octDown" data-idx="'+idx+'" title="Octave -1">‚àí</button>'
               +     '<span id="oct'+idx+'" style="min-width:1.5ch; text-align:center;">'+oct+'</span>'
               +     '<button data-act="octUp" data-idx="'+idx+'" title="Octave +1">+</button>'
               +   '</div>'
               + '</div>';
        }
        tuningPanel.innerHTML=html;
        tuningPanel.querySelectorAll('button').forEach(function(btn){
          btn.addEventListener('click',function(){
            var i=+btn.dataset.idx; var act=btn.dataset.act;
            if(act==='up'||act==='down'){
              state.tuning[i]=cycleNote(state.tuning[i], act==='up'?+1:-1);
            }else if(act==='octUp'){ state.octaves[i]=Math.min(8, (state.octaves[i]??3)+1); }
            else if(act==='octDown'){ state.octaves[i]=Math.max(-2, (state.octaves[i]??3)-1); }
            save(); renderTuningEditor(); renderBoard();
          }, {passive:true});
        });
        tuningPanel.querySelectorAll('select').forEach(function(sel){
          sel.addEventListener('change', function(){ var i=+sel.dataset.idx; state.tuning[i]=sel.value; save(); renderBoard(); });
        });
      }

      // ------- Fretboard render -------
      var FRETS=24;
      function renderBoard(){
        board.innerHTML="";
        var markerCols=new Set([3,5,7,9,12,15,17,19,21,24]);
        var scale=SCALES[state.scaleName];
        var rootIdx=noteIndex(state.root);
        var degreeBySemitone=new Map();
        scale.forEach(function(off,i){ degreeBySemitone.set(off%12, String(i+1)); });

        for(var s=0; s<state.strings; s++){
          var openName = state.tuning[s];
          var openOct  = state.octaves[s] ?? 3;
          var openIdx=noteIndex(openName);
          var stringRow=document.createElement('div'); stringRow.className='string';

          var nut=document.createElement('div'); nut.className='nut open-note';
          if(s>0) nut.style.borderTop='1px solid var(--rule)';
          var labelSpan=document.createElement('span'); labelSpan.textContent=openName; nut.appendChild(labelSpan);

          var openSemitone=openIdx%12;
          if(inScale(openSemitone, rootIdx, scale)){
            var m0=document.createElement('div'); m0.className='marker';
            var d0=document.createElement('div'); d0.className='dot'; d0.dataset.note=openName; d0.dataset.oct=openOct; d0.dataset.src='nut';
            if(((openSemitone-rootIdx+12)%12)===0) d0.classList.add('root');
            var label0="";
            if(state.labelMode==='notes') label0=openName;
            else if(state.labelMode==='degrees'){ var rel0=(openSemitone-rootIdx+12)%12; label0=degreeBySemitone.get(rel0)||""; }
            d0.textContent=label0; m0.appendChild(d0); nut.appendChild(m0);
            d0.style.pointerEvents='auto';
            d0.tabIndex=0;
          }
          stringRow.appendChild(nut);

          for(var f=1; f<=FRETS; f++){
            var cell=document.createElement('div'); cell.className='fret cell';
            if(s>0) cell.style.borderTop='1px solid var(--rule)';
            var semitone=(openIdx+f)%12;
            if(inScale(semitone, rootIdx, scale)){
              var m=document.createElement('div'); m.className='marker';
              var dot=document.createElement('div'); dot.className='dot';
              dot.dataset.note=NOTES_SHARP[semitone];
              // compute absolute octave by how many wraps from open
              var midiOpen = AudioEngine.noteToMidi(openName, openOct);
              var midiFret = midiOpen + f;
              // back out octave for label (C-based octave)
              var pc = (midiFret % 12 + 12) % 12;
              var oct = Math.floor(midiFret/12) - 1; // inverse of (oct+1)*12
              dot.dataset.oct=oct;
              if(((semitone-rootIdx+12)%12)===0) dot.classList.add('root');
              var label="";
              if(state.labelMode==='notes') label=NOTES_SHARP[semitone];
              else if(state.labelMode==='degrees'){ var rel=(semitone-rootIdx+12)%12; label=degreeBySemitone.get(rel)||""; }
              dot.textContent=label; m.appendChild(dot); cell.appendChild(m);
              dot.style.pointerEvents='auto';
              dot.tabIndex=0;
            }
            if(s===state.strings-1){
              var num=document.createElement('div'); num.className='fret-number'; num.textContent=f; cell.appendChild(num);
              if(markerCols.has(f)){
                var pm=document.createElement('div');
                if(f===12||f===24){ pm.className='pos-marker double'; var i1=document.createElement('i'); var i2=document.createElement('i'); pm.appendChild(i1); pm.appendChild(i2); }
                else { pm.className='pos-marker'; }
                cell.appendChild(pm);
              }
            }
            stringRow.appendChild(cell);
          }
          board.appendChild(stringRow);
        }

        // attach play handlers
        board.querySelectorAll('.dot').forEach(function(dot){
          dot.addEventListener('pointerdown', function(e){
            if(AudioEngine){ 
              if(!audioEnableBtn.disabled) { /* auto-start on first touch if user taps a note */
                AudioEngine.start(); audioEnableBtn.textContent='üîä Sound on'; audioEnableBtn.disabled=true;
              }
              AudioEngine.playNote(dot.dataset.note, parseInt(dot.dataset.oct,10), {dur:0.5});
            }
            dot.classList.add('hit');
            setTimeout(()=>dot.classList.remove('hit'), 160);
          }, {passive:true});
          dot.addEventListener('keydown', function(e){
            if(e.key==='Enter' || e.key===' '){
              AudioEngine.playNote(dot.dataset.note, parseInt(dot.dataset.oct,10), {dur:0.5});
              dot.classList.add('hit'); setTimeout(()=>dot.classList.remove('hit'), 160);
            }
          });
        });

        // refresh piano too
        renderPiano();
      }

      // ------- Piano (SVG, one octave C4‚ÄìC5) -------
      var WHITE = ["C","D","E","F","G","A","B"];
      var WHITE_PC = WHITE.map(n=>NOTES_SHARP.indexOf(n)); // [0,2,4,5,7,9,11]
      var BLACK_AT = [0,1,3,4,5];               // after C,D,F,G,A
      var BLACK_NAMES = ["C#","D#","F#","G#","A#"];
      var BLACK_PC = BLACK_NAMES.map(n=>NOTES_SHARP.indexOf(n)); // [1,3,6,8,10]

      function renderPiano(){
        var w = pianoContainer.clientWidth || 520;
        var h = 160;
        var svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("viewBox","0 0 "+w+" "+h);
        svg.setAttribute("width","100%");
        svg.setAttribute("height","auto");
        svg.setAttribute("role","img");
        svg.setAttribute("aria-label","Piano octave showing scale tones");

        var ink = getComputedStyle(document.documentElement).getPropertyValue('--ink').trim() || '#2f2a1e';
        var paper = getComputedStyle(document.documentElement).getPropertyValue('--paper').trim() || '#f5f1e8';
        var accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#a08a63';

        var pad = 10;
        var innerW = w - pad*2;
        var whiteW = innerW / 7.2;
        var whiteH = h - pad*2;
        var blackW = whiteW * 0.58;
        var blackH = whiteH * 0.58;
        var blackShift = whiteW * 0.74;

        var scale = SCALES[state.scaleName];
        var rootIdx = noteIndex(state.root);
        var inScaleSet = new Set(scale.map(off => (rootIdx + off) % 12));

        pianoCaption.textContent = state.root + " " + state.scaleName;

        // helper to attach play
        function attachPlay(el, name, octave){
          el.style.cursor='pointer';
          el.addEventListener('pointerdown', function(){
            if(!audioEnableBtn.disabled){ AudioEngine.start(); audioEnableBtn.textContent='üîä Sound on'; audioEnableBtn.disabled=true; }
            AudioEngine.playNote(name, octave, {dur:0.5});
          }, {passive:true});
        }

        // --- White keys ---
        WHITE_PC.forEach(function(pc,i){
          var x = pad + i*whiteW;
          var rect = document.createElementNS(svg.namespaceURI,"rect");
          rect.setAttribute("x",x);
          rect.setAttribute("y",pad);
          rect.setAttribute("width",whiteW);
          rect.setAttribute("height",whiteH);
          rect.setAttribute("fill",paper);
          rect.setAttribute("stroke",accent);
          rect.setAttribute("stroke-width","1");
          rect.setAttribute("rx","4");
          svg.appendChild(rect);

          // labels
          var label = document.createElementNS(svg.namespaceURI,"text");
          label.setAttribute("x", x + whiteW/2);
          label.setAttribute("y", pad + whiteH - 8);
          label.setAttribute("font-size","10");
          label.setAttribute("text-anchor","middle");
          label.setAttribute("fill",accent);
          label.textContent = WHITE[i];
          svg.appendChild(label);

          // highlight if in scale
          if (inScaleSet.has(pc)){
            var cx = x + whiteW/2;
            var cy = pad + whiteH * 0.75;
            var circle = document.createElementNS(svg.namespaceURI,"circle");
            circle.setAttribute("cx",cx);
            circle.setAttribute("cy",cy);
            circle.setAttribute("r",whiteW*0.15);
            circle.setAttribute("stroke",ink);
            circle.setAttribute("stroke-width","2");
            circle.setAttribute("fill","none");
            if (pc === rootIdx){ circle.setAttribute("fill",ink); }
            svg.appendChild(circle);
          }

          // Click plays C4..B4
          attachPlay(rect, WHITE[i], 4);
        });

        // --- Black keys ---
        BLACK_PC.forEach(function(pc,j){
          var afterWhite = BLACK_AT[j];
          var xLeft = pad + afterWhite*whiteW;
          var x = xLeft + blackShift - blackW/2;
          var y = pad;
          var rect = document.createElementNS(svg.namespaceURI,"rect");
          rect.setAttribute("x",x);
          rect.setAttribute("y",y);
          rect.setAttribute("width",blackW);
          rect.setAttribute("height",blackH);
          rect.setAttribute("rx","3");
          rect.setAttribute("fill",ink);
          rect.setAttribute("stroke",accent);
          rect.setAttribute("stroke-width","1");
          svg.appendChild(rect);

          if (inScaleSet.has(pc)){
            var cx = x + blackW/2;
            var cy = y + blackH * 0.55;
            var circ = document.createElementNS(svg.namespaceURI,"circle");
            circ.setAttribute("cx",cx);
            circ.setAttribute("cy",cy);
            circ.setAttribute("r",blackW*0.23);
            circ.setAttribute("stroke",paper);
            circ.setAttribute("stroke-width","2");
            circ.setAttribute("fill","none");
            if (pc === rootIdx){ circ.setAttribute("fill",paper); }
            svg.appendChild(circ);
          }

          // Click plays C#4..A#4
          attachPlay(rect, BLACK_NAMES[j], 4);
        });

        pianoContainer.innerHTML="";
        pianoContainer.appendChild(svg);
      }

      // ------- Events -------
      rootSel.addEventListener('change', function () { state.root = rootSel.value; save(); renderBoard(); });
      scaleSel.addEventListener('change', function () { state.scaleName = scaleSel.value; save(); renderBoard(); });
      labelsSel.addEventListener('change', function () { state.labelMode = labelsSel.value; save(); renderBoard(); });
      applyStringsBtn.addEventListener('click', function () {
        var n = Math.max(3, Math.min(10, parseInt(stringCountInput.value || 6, 10)));
        state.strings = n; ensureTuningLen(n); save(); renderTuningEditor(); renderBoard();
      });
      waveSel.addEventListener('change', function(){ state.wave=waveSel.value; save(); AudioEngine.setWave(state.wave); });
      volSlider.addEventListener('input', function(){ state.volume=parseFloat(volSlider.value); save(); AudioEngine.setVolume(state.volume); });

      // ------- Init -------
      document.getElementById('y').textContent = new Date().getFullYear();
      fillSelect(rootSel, NOTES_SHARP); // ensure
      renderTuningEditor();
      renderBoard();
      rootSel.value=state.root; scaleSel.value=state.scaleName; labelsSel.value=state.labelMode;

      // Keep piano crisp on resize
      var rT; window.addEventListener('resize', function(){ clearTimeout(rT); rT=setTimeout(renderPiano, 120); });

      // Accessibility: allow space to click enable
      window.addEventListener('keydown', function(e){
        if((e.key==='AudioVolumeUp'||e.key===' ') && !audioEnableBtn.disabled){ audioEnableBtn.click(); }
      });
    })();
  </script>
</body>
</html>