<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="scales_doc_title">The Scales Book — Contumance</title>
  <meta name="description" content="The Scales Book — minimal interactive fretboard with e-ink-style aesthetics." data-i18n="scales_doc_description" data-i18n-attr="content" />
  <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>♪</text></svg>">
  <link rel="stylesheet" href="assets/kindle.css">
  <style>
    .theme-toggle{font-size:1.15rem}

    .controls{display:grid; gap:8px; align-items:center; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); margin-bottom:8px;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    label{font-size:12px; opacity:.9;}
    select,button,input[type="number"],input[type="range"]{
      appearance:none; border:1px solid var(--accent); background:transparent; color:var(--ink);
      padding:10px 12px; border-radius:.5rem; font-family:inherit; font-size:14px; line-height:1; min-width:0;
    }
    button.primary{background:var(--ink); color:var(--paper); border-color:var(--ink);}
    .tuning{display:grid; gap:8px; grid-template-columns:repeat(auto-fit,minmax(210px,1fr));}
    .tuning .string-card{border:1px solid var(--accent); border-radius:.6rem; background:transparent; padding:8px;}
    .octv{display:flex; align-items:center; gap:6px; font-size:12px; opacity:.9}
    .piano-wrap{border:1px solid var(--accent); border-radius:.6rem; background:transparent; margin:14px 0 18px; padding:10px 10px 14px;}
    .piano-head{display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-bottom:6px; font-size:.95rem;}
    .piano-caption{color:var(--muted); font-size:.85rem;}
    .fretboard-wrap{margin-top:16px;}
    .support-note{margin:12px 0 16px;}
    .fretboard{width:100%; border:1px solid var(--accent); border-radius:.6rem; background:transparent;}
    .board{display:grid; grid-auto-rows:minmax(30px,5vh); grid-template-columns:40px repeat(24,1fr); position:relative; width:100%;}
    .string{display:contents;}
    .nut,.fret{border-right:1px solid var(--rule); position:relative;}
    .nut{display:flex; align-items:center; justify-content:center; font-size:12px; background:rgba(0,0,0,.04);}
    html.theme-dark .nut{background:rgba(255,255,255,.06);}
    .open-note{display:flex; align-items:center; justify-content:center; font-size:12px;}
    .cell{position:relative; display:flex; align-items:center; justify-content:center;}
    .fret-number{position:absolute; bottom:2px; right:6px; font-size:10px; opacity:.35;}
    .marker{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;}
    .dot{width:24px; height:24px; border-radius:999px; border:1.5px solid var(--accent-soft); background:transparent; display:flex; align-items:center; justify-content:center; font-size:11px; transition:transform .05s ease, background-color .12s ease;}
    .dot.root{background:var(--ink); color:var(--paper); border-color:var(--ink); font-weight:600;}
    .hit{animation:hit .18s ease;}
    @keyframes hit{ from{ background-color:var(--hit);} to{ background-color:transparent;} }
    .pos-marker{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:6px; height:6px; border-radius:999px; background:#bbb; opacity:.5;}
    .pos-marker.double{display:grid; grid-template-columns:1fr 1fr; gap:8px; width:auto; height:auto; background:transparent;}
    .pos-marker.double i{width:6px; height:6px; background:#bbb; opacity:.5; border-radius:999px; display:block;}
    .footer{margin:30px 0 60px; font-size:12px; color:var(--muted);}
  </style>
</head>
<body>
  <main>
    <div class="topbar">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="index.html" data-i18n="scales_back">← Back to index</a>
      </nav>
      <div class="row" style="gap:6px; position:relative;">
        <label class="visually-hidden" for="langSelect" data-i18n="lang_label">Language</label>
        <select id="langSelect" class="lang-select" aria-label="Language" title="Language">
          <option value="en">EN</option>
          <option value="es">ES</option>
          <option value="pt">PT</option>
        </select>
        <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme" title="Toggle theme">☾</button>
      </div>
    </div>

    <header>
      <h1 data-i18n="scales_heading">The Scales Book</h1>
      <div class="subtitle" data-i18n="scales_subtitle">Paths that lead the hand to the new colors.</div>
    </header>

    <details class="panel" id="panel" open>
      <summary data-i18n="scales_panel_summary">Guitar setup</summary>
      <div class="panel-body">
        <div class="controls" role="group" aria-label="Controls">
          <div class="row">
            <label for="stringCount" data-i18n="scales_control_strings">Strings</label>
            <input id="stringCount" type="number" min="3" max="10" value="6" style="width:86px" />
            <button id="applyStrings" data-i18n="scales_apply">Apply</button>
          </div>
          <div class="row">
            <label for="root" data-i18n="scales_control_root">Root</label>
            <select id="root"></select>
          </div>
          <div class="row">
            <label for="scale" data-i18n="scales_control_scale">Scale</label>
            <select id="scale" disabled title="Choose a scale" data-i18n-attr="title" data-i18n="scales_scale_select_title">
              <option data-i18n="scales_loading">Loading scales…</option>
            </select>
          </div>
          <div class="row">
            <label for="labels" data-i18n="scales_control_labels">Labels</label>
            <select id="labels">
              <option value="notes" data-i18n="scales_labels_notes">Notes</option>
              <option value="degrees" data-i18n="scales_labels_degrees">Degrees</option>
              <option value="off" data-i18n="scales_labels_off">Hidden</option>
            </select>
          </div>
          <div class="row">
            <label for="wave" data-i18n="scales_control_wave">Wave</label>
            <select id="wave">
              <option data-i18n="scales_wave_sine">sine</option>
              <option data-i18n="scales_wave_triangle">triangle</option>
              <option data-i18n="scales_wave_square">square</option>
              <option data-i18n="scales_wave_saw">sawtooth</option>
            </select>
          </div>
          <div class="row" style="min-width:190px;">
            <label for="volume" data-i18n="scales_control_volume">Volume</label>
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.6" style="width:120px;">
          </div>
        </div>
        <div id="tuningPanel" class="tuning" aria-label="Tuning editor"></div>
      </div>
    </details>

    <section class="fretboard-wrap">
      <div id="fretboard" class="fretboard">
        <div id="board" class="board" role="grid" aria-label="Fretboard"></div>
      </div>
    </section>

    <section class="piano-wrap" aria-label="Piano octave" data-i18n="scales_piano_region" data-i18n-attr="aria-label" data-i18n-attr-only>
      <div class="piano-head">
        <div><strong data-i18n="scales_piano_word">Piano</strong> <span data-i18n="scales_piano_one_octave">— one octave</span></div>
        <div class="piano-caption" id="pianoCaption">C Major (Ionian)</div>
      </div>
      <div id="pianoContainer" style="width:100%; overflow:hidden;"></div>
    </section>

    <section class="support-note" id="supportInline" aria-label="Support this project" data-i18n="scales_support_label" data-i18n-attr="aria-label">
      <p style="margin:0">
        <span data-i18n="scales_support_intro">Did this page help you hear the fretboard differently?</span>
        <span data-i18n="scales_support_keep_prefix">If you want to keep </span>
        <strong>Re:sonance</strong>
        <span data-i18n="scales_support_keep_suffix"> growing,</span>
        <span data-i18n="scales_support_cta_prefix">you can </span>
        <a href="https://buymeacoffee.com/Contumance" target="_blank" rel="noopener noreferrer" data-i18n="scales_buyme">buy me a coffee</a>
        <span data-i18n="scales_support_cta_suffix">.</span>
        <span data-i18n="scales_support_note">It directly funds more tools and lessons. Thank you ✨</span>
      </p>
      <div class="actions">
        <a class="btn" href="https://buymeacoffee.com/Contumance" target="_blank" rel="noopener noreferrer" aria-label="Buy me a coffee" data-i18n="scales_buyme_aria" data-i18n-attr="aria-label">
          <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 8h14.5a2 2 0 0 1 0 4H18l-1 5a4 4 0 0 1-3.95 3.3H8.95A4 4 0 0 1 5 17l-1-9z"/>
            <path d="M3 8h17"/><path d="M7 4h6"/>
          </svg>
          <span data-i18n="scales_buyme">Buy me a coffee</span>
        </a>
        <button class="dismiss" type="button" id="dismissSupport" data-i18n="scales_support_dismiss">Not now</button>
      </div>
    </section>

    <p class="footer" data-i18n="scales_tip">Tip: use ± to shift each string by semitones. Everything is saved on this device (no backend).</p>

    <footer>
      <a class="btn" href="https://buymeacoffee.com/Contumance" target="_blank" rel="noopener noreferrer"
         aria-label="Support this library on Buy Me a Coffee" data-i18n="scales_footer_buyme_aria" data-i18n-attr="aria-label">
        <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 8h14.5a2 2 0 0 1 0 4H18l-1 5a4 4 0 0 1-3.95 3.3H8.95A4 4 0 0 1 5 17l-1-9z"/>
          <path d="M3 8h17"/>
          <path d="M7 4h6"/>
        </svg>
        <span data-i18n="scales_buyme">Buy me a coffee</span>
      </a>
      <span class="note" data-i18n="scales_footer_note">Fuel the craft. Inspire the next page.</span>
      <span>© <span id="y"></span> Re:sonance <small class="byline">by <em>Contumance</em></small></span>
    </footer>
  </main>

  <script src="assets/i18n.js"></script>
  <script>
    const scalesMessages = {
      en: {
        doc_title: "The Scales Book — Contumance",
        doc_description: "The Scales Book — minimal interactive fretboard with e-ink-style aesthetics.",
        lang_label: "Language",
        scales_back: "← Back to index",
        scales_heading: "The Scales Book",
        scales_subtitle: "Paths that lead the hand to the new colors.",
        scales_panel_summary: "Guitar setup",
        scales_control_strings: "Strings",
        scales_apply: "Apply",
        scales_control_root: "Root",
        scales_control_scale: "Scale",
        scales_scale_select_title: "Choose a scale",
        scales_loading: "Loading scales…",
        scales_control_labels: "Labels",
        scales_labels_notes: "Notes",
        scales_labels_degrees: "Degrees",
        scales_labels_off: "Hidden",
        scales_control_wave: "Wave",
        scales_wave_sine: "sine",
        scales_wave_triangle: "triangle",
        scales_wave_square: "square",
        scales_wave_saw: "sawtooth",
        scales_control_volume: "Volume",
        scales_piano_region: "Piano octave",
        scales_piano_word: "Piano",
        scales_piano_one_octave: "— one octave",
        scales_support_label: "Support this project",
        scales_support_intro: "Did this page help you hear the fretboard differently?",
        scales_support_keep_prefix: "If you want to keep ",
        scales_support_keep_suffix: " growing,",
        scales_support_cta_prefix: "you can ",
        scales_support_cta_suffix: ".",
        scales_support_note: "It directly funds more tools and lessons. Thank you ✨",
        scales_buyme: "Buy me a coffee",
        scales_buyme_aria: "Buy me a coffee",
        scales_support_dismiss: "Not now",
        scales_tip: "Tip: use ± to shift each string by semitones. Everything is saved on this device (no backend).",
        scales_footer_buyme_aria: "Support this library on Buy Me a Coffee",
        scales_footer_note: "Fuel the craft. Inspire the next page.",
        theme_to_light: "Switch to light mode",
        theme_to_dark: "Switch to dark mode",
        scales_string_label: "String {n}",
        scales_octave_label: "Octave",
        scales_lower_note: "Lower note",
        scales_raise_note: "Raise note",
        scales_octave_down: "Octave -1",
        scales_octave_up: "Octave +1",
        scales_fallback_msg: "Could not load scales.json. Using a minimal fallback."
      },
      es: {
        doc_title: "The Scales Book — Contumance",
        doc_description: "The Scales Book — diapasón interactivo minimalista con estética de tinta electrónica.",
        lang_label: "Idioma",
        scales_back: "← Volver al índice",
        scales_heading: "The Scales Book",
        scales_subtitle: "Caminos que llevan la mano hacia nuevos colores.",
        scales_panel_summary: "Configuración de guitarra",
        scales_control_strings: "Cuerdas",
        scales_apply: "Aplicar",
        scales_control_root: "Tónica",
        scales_control_scale: "Escala",
        scales_scale_select_title: "Elige una escala",
        scales_loading: "Cargando escalas…",
        scales_control_labels: "Etiquetas",
        scales_labels_notes: "Notas",
        scales_labels_degrees: "Grados",
        scales_labels_off: "Ocultas",
        scales_control_wave: "Onda",
        scales_wave_sine: "seno",
        scales_wave_triangle: "triángulo",
        scales_wave_square: "cuadrada",
        scales_wave_saw: "diente de sierra",
        scales_control_volume: "Volumen",
        scales_piano_region: "Octava de piano",
        scales_piano_word: "Piano",
        scales_piano_one_octave: "— una octava",
        scales_support_label: "Apoya este proyecto",
        scales_support_intro: "¿Esta página te ayudó a escuchar el diapasón de otra forma?",
        scales_support_keep_prefix: "Si quieres que ",
        scales_support_keep_suffix: " siga creciendo,",
        scales_support_cta_prefix: "puedes ",
        scales_support_cta_suffix: ".",
        scales_support_note: "Financia directamente más herramientas y lecciones. Gracias ✨",
        scales_buyme: "Invítame un café",
        scales_buyme_aria: "Invítame un café",
        scales_support_dismiss: "Ahora no",
        scales_tip: "Truco: usa ± para mover cada cuerda por semitonos. Todo se guarda en este dispositivo (sin backend).",
        scales_footer_buyme_aria: "Apoya esta biblioteca en Buy Me a Coffee",
        scales_footer_note: "Alimenta el oficio. Inspira la siguiente página.",
        theme_to_light: "Cambiar a modo claro",
        theme_to_dark: "Cambiar a modo oscuro",
        scales_string_label: "Cuerda {n}",
        scales_octave_label: "Octava",
        scales_lower_note: "Bajar nota",
        scales_raise_note: "Subir nota",
        scales_octave_down: "Octava -1",
        scales_octave_up: "Octava +1",
        scales_fallback_msg: "No se pudo cargar scales.json. Usando un respaldo mínimo."
      },
      pt: {
        doc_title: "The Scales Book — Contumance",
        doc_description: "The Scales Book — escala interativa minimalista com estética de e-ink.",
        lang_label: "Idioma",
        scales_back: "← Voltar ao índice",
        scales_heading: "The Scales Book",
        scales_subtitle: "Caminhos que conduzem a mão a novas cores.",
        scales_panel_summary: "Configuração da guitarra",
        scales_control_strings: "Cordas",
        scales_apply: "Aplicar",
        scales_control_root: "Tônica",
        scales_control_scale: "Escala",
        scales_scale_select_title: "Escolha uma escala",
        scales_loading: "Carregando escalas…",
        scales_control_labels: "Rótulos",
        scales_labels_notes: "Notas",
        scales_labels_degrees: "Graus",
        scales_labels_off: "Ocultos",
        scales_control_wave: "Onda",
        scales_wave_sine: "seno",
        scales_wave_triangle: "triângulo",
        scales_wave_square: "quadrada",
        scales_wave_saw: "serra",
        scales_control_volume: "Volume",
        scales_piano_region: "Oitava do piano",
        scales_piano_word: "Piano",
        scales_piano_one_octave: "— uma oitava",
        scales_support_label: "Apoie este projeto",
        scales_support_intro: "Esta página ajudou você a ouvir o braço de outra forma?",
        scales_support_keep_prefix: "Se quiser que ",
        scales_support_keep_suffix: " continue crescendo,",
        scales_support_cta_prefix: "você pode ",
        scales_support_cta_suffix: ".",
        scales_support_note: "Isso financia diretamente mais ferramentas e lições. Obrigado ✨",
        scales_buyme: "Me pague um café",
        scales_buyme_aria: "Me pague um café",
        scales_support_dismiss: "Agora não",
        scales_tip: "Dica: use ± para deslocar cada corda por semitons. Tudo fica salvo neste dispositivo (sem backend).",
        scales_footer_buyme_aria: "Apoie esta biblioteca no Buy Me a Coffee",
        scales_footer_note: "Alimente o ofício. Inspire a próxima página.",
        theme_to_light: "Alternar para modo claro",
        theme_to_dark: "Alternar para modo escuro",
        scales_string_label: "Corda {n}",
        scales_octave_label: "Oitava",
        scales_lower_note: "Baixar nota",
        scales_raise_note: "Subir nota",
        scales_octave_down: "Oitava -1",
        scales_octave_up: "Oitava +1",
        scales_fallback_msg: "Não foi possível carregar scales.json. Usando um fallback mínimo."
      }
    };

    window.tr = (key, fallback) => (window.ReI18n ? ReI18n.t(key, fallback) : (fallback || key));
    ReI18n.init({
      messages: scalesMessages,
      select: document.getElementById('langSelect')
    });
  </script>

  <!-- Theme toggle -->
  <script>
    (function(){
      const KEY='theme-preference';
      const root=document.documentElement;
      const btn=document.getElementById('themeToggle');
      const safeTr=(k,f)=> (window.ReI18n ? ReI18n.t(k,f) : (f||k));
      function setIcon(mode){
        if(!btn) return;
        btn.textContent = mode==='dark' ? '☀︎' : '☾';
        const label = mode==='dark'
          ? safeTr('theme_to_light', 'Switch to light mode')
          : safeTr('theme_to_dark', 'Switch to dark mode');
        btn.setAttribute('aria-label', label);
        btn.setAttribute('title', label);
      }
      function apply(mode){ root.classList.toggle('theme-dark',mode==='dark'); setIcon(mode); }
      function getPreferred(){
        const saved=localStorage.getItem(KEY);
        if(saved==='light'||saved==='dark') return saved;
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light';
      }
      let current=getPreferred(); apply(current);
      if(btn){
        btn.addEventListener('click',()=>{ current=current==='dark'?'light':'dark'; localStorage.setItem(KEY,current); apply(current); });
      }
      if(window.ReI18n){
        ReI18n.onChange(()=>{ setIcon(current); });
      }
      document.getElementById('y').textContent = new Date().getFullYear();
    })();
  </script>

  <!-- Support inline logic (2 days, page-scoped + force flag) -->
  <script>
    (function supportInlineLogic(){
      const el  = document.getElementById('supportInline');
      const btn = document.getElementById('dismissSupport');
      if(!el || !btn) return;

      const FORCE = /[?&]support=1\b/.test(location.search) || location.hash === '#support';
      const KEY = 'support-note:scales:v1:dismissedUntil';
      const now = Date.now();
      const until = Number(localStorage.getItem(KEY) || 0);
      if (!FORCE && now < until) { el.style.display = 'none'; return; }
      el.style.display = 'block';
      btn.addEventListener('click', () => {
        const someDaysMs = 2 * 24 * 60 * 60 * 1000;
        localStorage.setItem(KEY, String(Date.now() + someDaysMs));
        el.style.display = 'none';
      });
    })();
  </script>

  <!-- Main app -->
  <script>
    (function(){
      // ------- Musical data -------
      const NOTES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      // SCALES ahora viene del JSON externo
      let SCALES = {};               // mapa nombre → [intervalos]
      let SCALE_LABELS = {};         // mapa nombre → labels por idioma
      let SCALES_READY = false;      // flag
      const SCALES_URL = 'scales.json'; // mismo directorio

      // ------- State & persistence -------
      const DEFAULT_TUNING_6 = ["E","B","G","D","A","E"]; // 1st (highest) on top
      const DEFAULT_OCTAVES_6 = [4,3,3,3,2,2]; // E4,B3,G3,D3,A2,E2
      const LS_KEY="the_scales_book_state_v2_audio";

      const state = {
        strings:6,
        tuning:DEFAULT_TUNING_6.slice(),
        octaves:DEFAULT_OCTAVES_6.slice(),
        root:"C", scaleName:"Major (Ionian)", labelMode:"notes",
        wave:"sine", volume:0.6
      };
      try{
        const saved=JSON.parse(localStorage.getItem(LS_KEY)||"null");
        if(saved&&typeof saved==="object") Object.assign(state,saved);
      }catch(e){}
      function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

      // ------- DOM refs -------
      const board=document.getElementById("board");
      const rootSel=document.getElementById("root");
      const scaleSel=document.getElementById("scale");
      const labelsSel=document.getElementById("labels");
      const tuningPanel=document.getElementById("tuningPanel");
      const stringCountInput=document.getElementById("stringCount");
      const applyStringsBtn=document.getElementById("applyStrings");
      const pianoContainer=document.getElementById("pianoContainer");
      const pianoCaption=document.getElementById("pianoCaption");
      const waveSel=document.getElementById("wave");
      const volSlider=document.getElementById("volume");

      // ------- Helpers -------
      const t = (key, fallback) => (window.ReI18n ? ReI18n.t(key, fallback) : (fallback || key));
      function format(template, values){
        return template.replace(/\{(\w+)\}/g, (_, k) => (values && values[k] != null) ? values[k] : '');
      }
      function noteIndex(name){ return NOTES_SHARP.indexOf(name); }
      function cycleNote(note, step){ let i=noteIndex(note); if(i<0) i=0; i=(i+step+12)%12; return NOTES_SHARP[i]; }
      function ensureTuningLen(n){
        if (!Array.isArray(state.tuning)) state.tuning = [];
        if (!Array.isArray(state.octaves)) state.octaves = [];
        while (state.tuning.length < n) {
          const i = state.tuning.length;
          const prevNote = (i > 0) ? state.tuning[i - 1] : "E";
          const prevOct  = (i > 0) ? (state.octaves[i - 1] ?? 2) : 2; // E2
          let prevPc = noteIndex(prevNote); if (prevPc < 0) prevPc = 4; // E
          let newPc = prevPc - 5; let octave = prevOct;
          if (newPc < 0) { newPc += 12; octave -= 1; }
          state.tuning.push(NOTES_SHARP[newPc]); state.octaves.push(octave);
        }
        if (state.tuning.length > n) { state.tuning.splice(n); state.octaves.splice(n); }
      }
      function inScale(pc, rootIdx, scale){ const rel=(pc-rootIdx+12)%12; return scale.indexOf(rel)!==-1; }
      function fillSelect(el, arr){
        el.innerHTML = arr.map(item => {
          if(typeof item === 'string'){
            return '<option value="'+item+'">'+item+'</option>';
          }
          const value = item && item.value != null ? item.value : '';
          const label = item && item.label != null ? item.label : value;
          const attrs = item && item.disabled ? ' disabled' : '';
          return '<option value="'+value+'"'+attrs+'>'+label+'</option>';
        }).join('');
      }
      function getScaleLabel(name){
        const data = SCALE_LABELS[name];
        if(window.ReI18n && data){
          return ReI18n.translateLabel(data, name);
        }
        if(data){
          if(typeof data === 'string') return data;
          if(data.en) return data.en;
        }
        return name;
      }
      function buildScaleOptions(){
        return Object.keys(SCALES).map(name => ({ value: name, label: getScaleLabel(name) }));
      }
      function refreshScaleSelect(){
        if(!scaleSel) return;
        const names = Object.keys(SCALES);
        if(!names.length) return;
        const options = buildScaleOptions();
        fillSelect(scaleSel, options);
        if(state.scaleName && SCALES[state.scaleName]){
          scaleSel.value = state.scaleName;
        }
      }

      // ------- AUDIO ENGINE (Web Audio) -------
      const AudioEngine = (function(){
        let ctx=null, master=null, started=false, currentWave = state.wave || "sine";
        function midiToFreq(m){ return 440 * Math.pow(2, (m-69)/12); }
        function noteToMidi(name, octave){ const pc=noteIndex(name); if(pc<0) return 60; return (octave+1)*12 + pc; }
        function start(){ if(started) return; ctx = new (window.AudioContext||window.webkitAudioContext)(); master = ctx.createGain(); master.gain.value = state.volume; master.connect(ctx.destination); started=true; }
        function resumeMaybe(){ if(ctx && ctx.state==="suspended") ctx.resume(); }
        function setVolume(v){ if(master) master.gain.value=v; }
        function setWave(w){ currentWave=w; }
        function playFreq(freq, opts){
          if(!started) start(); resumeMaybe();
          const t=ctx.currentTime, o=ctx.createOscillator(), g=ctx.createGain();
          const A=0.01, D=0.08, S=0.75, R=0.15;
          const vel = (opts && opts.vel)!=null ? opts.vel : 0.9;
          g.gain.setValueAtTime(0, t);
          g.gain.linearRampToValueAtTime(vel, t+A);
          g.gain.linearRampToValueAtTime(vel*S, t+A+D);
          o.type = currentWave; o.frequency.setValueAtTime(freq, t);
          o.connect(g); g.connect(master); o.start(t);
          const dur = (opts && opts.dur) || 0.6, end = t + dur;
          g.gain.setTargetAtTime(0.0001, end, R);
          o.stop(end + R*3);
        }
        function playNote(name, octave, opts){ const midi = noteToMidi(name, octave); playFreq(midiToFreq(midi), opts); }
        return {start,setVolume,setWave,playNote,noteToMidi};
      })();

      // ------- Tuning editor -------
      function renderTuningEditor(){
        ensureTuningLen(state.strings);
        let html="";
        for(let idx=0; idx<state.tuning.length; idx++){
          const note=state.tuning[idx], stringNum=idx+1, oct=state.octaves[idx] ?? 3;
          const opts=NOTES_SHARP.map(n=>'<option value="'+n+'"'+(n===note?' selected':'')+'>'+n+'</option>').join('');
          const stringLabel=format(t('scales_string_label','String {n}'), {n:stringNum});
          const octaveLabel=t('scales_octave_label','Octave');
          const lowerTitle=t('scales_lower_note','Lower note');
          const raiseTitle=t('scales_raise_note','Raise note');
          const octaveDown=t('scales_octave_down','Octave -1');
          const octaveUp=t('scales_octave_up','Octave +1');
          html+= '<div class="string-card">'
               +   '<div style="font-size:12px; opacity:.8; margin-bottom:6px;">'+stringLabel+'</div>'
               +   '<div class="row" style="gap:6px; flex-wrap:nowrap;">'
               +     '<button data-act="down" data-idx="'+idx+'" title="'+lowerTitle+'">−</button>'
               +     '<div class="open-note" style="min-width:40px; text-align:center">'+note+'</div>'
               +     '<button data-act="up" data-idx="'+idx+'" title="'+raiseTitle+'">+</button>'
               +     '<select data-act="set" data-idx="'+idx+'" style="flex:1; min-width:0;">'+opts+'</select>'
               +   '</div>'
               +   '<div class="octv">'
               +     '<label>'+octaveLabel+'</label>'
               +     '<button data-act="octDown" data-idx="'+idx+'" title="'+octaveDown+'">−</button>'
               +     '<span id="oct'+idx+'" style="min-width:1.5ch; text-align:center;">'+oct+'</span>'
               +     '<button data-act="octUp" data-idx="'+idx+'" title="'+octaveUp+'">+</button>'
               +   '</div>'
               + '</div>';
        }
        tuningPanel.innerHTML=html;
        tuningPanel.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click',()=>{
            const i=+btn.dataset.idx; const act=btn.dataset.act;
            if(act==='up'||act==='down'){ state.tuning[i]=cycleNote(state.tuning[i], act==='up'?+1:-1); }
            else if(act==='octUp'){ state.octaves[i]=Math.min(8, (state.octaves[i]??3)+1); }
            else if(act==='octDown'){ state.octaves[i]=Math.max(-2, (state.octaves[i]??3)-1); }
            save(); renderTuningEditor(); renderBoard();
          }, {passive:true});
        });
        tuningPanel.querySelectorAll('select').forEach(sel=>{
          sel.addEventListener('change', ()=>{ const i=+sel.dataset.idx; state.tuning[i]=sel.value; save(); renderBoard(); });
        });
      }

      // ------- Fretboard render -------
      const FRETS=24;
      function renderBoard(){
        if(!SCALES_READY) return; // no render hasta que lleguen las escalas
        board.innerHTML="";
        const markerCols=new Set([3,5,7,9,12,15,17,19,21,24]);
        const scale=SCALES[state.scaleName] || [];
        const rootIdx=noteIndex(state.root);
        const degreeBySemitone=new Map();
        scale.forEach((off,i)=>degreeBySemitone.set(off%12, String(i+1)));

        if(pianoCaption){
          const display = getScaleLabel(state.scaleName || '');
          pianoCaption.textContent = (state.root || '') + ' ' + display;
        }

        for(let s=0; s<state.strings; s++){
          const openName = state.tuning[s];
          const openOct  = state.octaves[s] ?? 3;
          const openIdx=noteIndex(openName);
          const stringRow=document.createElement('div'); stringRow.className='string';

          const nut=document.createElement('div'); nut.className='nut open-note';
          if(s>0) nut.style.borderTop='1px solid var(--rule)';
          const labelSpan=document.createElement('span'); labelSpan.textContent=openName; nut.appendChild(labelSpan);

          const openSemitone=openIdx%12;
          if(inScale(openSemitone, rootIdx, scale)){
            const m0=document.createElement('div'); m0.className='marker';
            const d0=document.createElement('div'); d0.className='dot'; d0.dataset.note=openName; d0.dataset.oct=openOct; d0.dataset.src='nut';
            if(((openSemitone-rootIdx+12)%12)===0) d0.classList.add('root');
            let label0="";
            if(state.labelMode==='notes') label0=openName;
            else if(state.labelMode==='degrees'){ const rel0=(openSemitone-rootIdx+12)%12; label0=degreeBySemitone.get(rel0)||""; }
            d0.textContent=label0; m0.appendChild(d0); nut.appendChild(m0);
            d0.style.pointerEvents='auto'; d0.tabIndex=0;
          }
          stringRow.appendChild(nut);

          for(let f=1; f<=FRETS; f++){
            const cell=document.createElement('div'); cell.className='fret cell';
            if(s>0) cell.style.borderTop='1px solid var(--rule)';
            const semitone=(openIdx+f)%12;
            if(inScale(semitone, rootIdx, scale)){
              const m=document.createElement('div'); m.className='marker';
              const dot=document.createElement('div'); dot.className='dot';
              dot.dataset.note=NOTES_SHARP[semitone];
              const midiOpen = AudioEngine.noteToMidi(openName, openOct);
              const midiFret = midiOpen + f;
              const oct = Math.floor(midiFret/12) - 1;
              dot.dataset.oct=oct;
              if(((semitone-rootIdx+12)%12)===0) dot.classList.add('root');
              let label="";
              if(state.labelMode==='notes') label=NOTES_SHARP[semitone];
              else if(state.labelMode==='degrees'){ const rel=(semitone-rootIdx+12)%12; label=degreeBySemitone.get(rel)||""; }
              dot.textContent=label; m.appendChild(dot); cell.appendChild(m);
              dot.style.pointerEvents='auto'; dot.tabIndex=0;
            }
            if(s===state.strings-1){
              const num=document.createElement('div'); num.className='fret-number'; num.textContent=f; cell.appendChild(num);
              if(markerCols.has(f)){
                const pm=document.createElement('div');
                if(f===12||f===24){ pm.className='pos-marker double'; const i1=document.createElement('i'); const i2=document.createElement('i'); pm.appendChild(i1); pm.appendChild(i2); }
                else { pm.className='pos-marker'; }
                cell.appendChild(pm);
              }
            }
            stringRow.appendChild(cell);
          }
          board.appendChild(stringRow);
        }

        // play handlers
        board.querySelectorAll('.dot').forEach(dot=>{
          dot.addEventListener('pointerdown', ()=>{
            AudioEngine.playNote(dot.dataset.note, parseInt(dot.dataset.oct,10), {dur:0.5});
            dot.classList.add('hit'); setTimeout(()=>dot.classList.remove('hit'), 160);
          }, {passive:true});
          dot.addEventListener('keydown', e=>{
            if(e.key==='Enter' || e.key===' '){
              AudioEngine.playNote(dot.dataset.note, parseInt(dot.dataset.oct,10), {dur:0.5});
              dot.classList.add('hit'); setTimeout(()=>dot.classList.remove('hit'), 160);
            }
          });
        });

        renderPiano();
      }

      // ------- Piano (SVG, one octave C4–C5) -------
      const WHITE = ["C","D","E","F","G","A","B"];
      const WHITE_PC = WHITE.map(n=>NOTES_SHARP.indexOf(n));
      const BLACK_AT = [0,1,3,4,5];
      const BLACK_NAMES = ["C#","D#","F#","G#","A#"];
      const BLACK_PC = BLACK_NAMES.map(n=>NOTES_SHARP.indexOf(n));

      function renderPiano(){
        if(!SCALES_READY) return;
        const w = pianoContainer.clientWidth || 520;
        const h = 160;
        const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("viewBox","0 0 "+w+" "+h);
        svg.setAttribute("width", String(w));
        svg.setAttribute("height", String(h));
        svg.setAttribute("role","img");
        svg.setAttribute("aria-label","Piano octave showing scale tones");
        svg.setAttribute("preserveAspectRatio","xMidYMid meet");
        svg.style.width = "100%";
        svg.style.height = "auto";
        svg.style.display = "block";

        const cs = getComputedStyle(document.documentElement);
        const ink = cs.getPropertyValue('--ink').trim() || '#2f2a1e';
        const paper = cs.getPropertyValue('--paper').trim() || '#f5f1e8';
        const accent = cs.getPropertyValue('--accent').trim() || '#a08a63';

        const pad = 10;
        const innerW = w - pad*2;
        const whiteW = innerW / 7.2;
        const whiteH = h - pad*2;
        const blackW = whiteW * 0.58;
        const blackH = whiteH * 0.58;
        const blackShift = whiteW * 0.74;

        const scale = SCALES[state.scaleName] || [];
        const rootIdx = noteIndex(state.root);
        const inScaleSet = new Set(scale.map(off => (rootIdx + off) % 12));

        if (pianoCaption) {
          const pianoLabel = (state.root || '') + ' ' + getScaleLabel(state.scaleName || '');
          pianoCaption.textContent = pianoLabel.trim();
        }

        function attachPlay(el, name, octave){
          el.style.cursor='pointer';
          el.addEventListener('pointerdown', ()=>{ AudioEngine.playNote(name, octave, {dur:0.5}); }, {passive:true});
        }

        // White keys
        WHITE_PC.forEach((pc,i)=>{
          const x = pad + i*whiteW;
          const rect = document.createElementNS(svg.namespaceURI,"rect");
          rect.setAttribute("x",x); rect.setAttribute("y",pad);
          rect.setAttribute("width",whiteW); rect.setAttribute("height",whiteH);
          rect.setAttribute("fill",paper); rect.setAttribute("stroke",accent); rect.setAttribute("stroke-width","1"); rect.setAttribute("rx","4");
          svg.appendChild(rect);

          const label = document.createElementNS(svg.namespaceURI,"text");
          label.setAttribute("x", x + whiteW/2); label.setAttribute("y", pad + whiteH - 8);
          label.setAttribute("font-size","10"); label.setAttribute("text-anchor","middle"); label.setAttribute("fill",accent);
          label.textContent = WHITE[i]; svg.appendChild(label);

          if (inScaleSet.has(pc)){
            const cx = x + whiteW/2, cy = pad + whiteH * 0.75;
            const circle = document.createElementNS(svg.namespaceURI,"circle");
            circle.setAttribute("cx",cx); circle.setAttribute("cy",cy); circle.setAttribute("r",whiteW*0.15);
            circle.setAttribute("stroke",ink); circle.setAttribute("stroke-width","2"); circle.setAttribute("fill","none");
            if (pc === rootIdx){ circle.setAttribute("fill",ink); }
            svg.appendChild(circle);
          }
          attachPlay(rect, WHITE[i], 4);
        });

        // Black keys
        BLACK_PC.forEach((pc,j)=>{
          const afterWhite = BLACK_AT[j];
          const xLeft = pad + afterWhite*whiteW;
          const x = xLeft + blackShift - blackW/2;
          const y = pad;
          const rect = document.createElementNS(svg.namespaceURI,"rect");
          rect.setAttribute("x",x); rect.setAttribute("y",y);
          rect.setAttribute("width",blackW); rect.setAttribute("height",blackH);
          rect.setAttribute("rx","3"); rect.setAttribute("fill",ink);
          rect.setAttribute("stroke",accent); rect.setAttribute("stroke-width","1");
          svg.appendChild(rect);

          if (inScaleSet.has(pc)){
            const cx = x + blackW/2, cy = y + blackH * 0.55;
            const circ = document.createElementNS(svg.namespaceURI,"circle");
            circ.setAttribute("cx",cx); circ.setAttribute("cy",cy); circ.setAttribute("r",blackW*0.23);
            circ.setAttribute("stroke",paper); circ.setAttribute("stroke-width","2"); circ.setAttribute("fill","none");
            if (pc === rootIdx){ circ.setAttribute("fill",paper); }
            svg.appendChild(circ);
          }
          attachPlay(rect, BLACK_NAMES[j], 4);
        });

        pianoContainer.innerHTML=""; pianoContainer.appendChild(svg);
      }

      // ------- Events -------
      rootSel.addEventListener('change', () => { state.root = rootSel.value; save(); renderBoard(); });
      labelsSel.addEventListener('change', () => { state.labelMode = labelsSel.value; save(); renderBoard(); });
      applyStringsBtn.addEventListener('click', () => {
        const n = Math.max(3, Math.min(10, parseInt(stringCountInput.value || 6, 10)));
        state.strings = n; ensureTuningLen(n); save(); renderTuningEditor(); renderBoard();
      });
      waveSel.addEventListener('change', ()=>{ state.wave=waveSel.value; save(); AudioEngine.setWave(state.wave); });
      volSlider.addEventListener('input', ()=>{ state.volume=parseFloat(volSlider.value); save(); AudioEngine.setVolume(state.volume); });

      // ------- Init (roots ya disponibles) -------
      fillSelect(rootSel, NOTES_SHARP);
      rootSel.value = state.root;
      waveSel.value = state.wave; volSlider.value = state.volume; labelsSel.value = state.labelMode; stringCountInput.value=state.strings;

      if(window.ReI18n){
        ReI18n.onChange(()=>{
          renderTuningEditor();
          refreshScaleSelect();
          if(SCALES_READY) renderBoard();
        });
      }

      // ------- Carga externa de escalas -------
      async function loadScales(){
        try{
          const res = await fetch(SCALES_URL, {cache:'no-cache'});
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          // Aceptamos objeto plano {name:[...], ...} o {name:{intervals:[], labels:{...}}}
          if(Object.prototype.toString.call(data) === '[object Object]'){
            const processed = {};
            const labels = {};
            Object.entries(data).forEach(([name, value]) => {
              if(Array.isArray(value)){
                processed[name] = value;
                labels[name] = labels[name] || { en: name };
                return;
              }
              if(value && typeof value === 'object'){
                let intervals = [];
                if(Array.isArray(value.intervals)) intervals = value.intervals;
                else if(Array.isArray(value.steps)) intervals = value.steps;
                else if(Array.isArray(value.scale)) intervals = value.scale;
                else if(Array.isArray(value.values)) intervals = value.values;
                else if(Array.isArray(value.notes)) intervals = value.notes;
                else if(Array.isArray(value)) intervals = Array.from(value);
                if(intervals.length){ processed[name] = intervals; }
                if(value.labels && typeof value.labels === 'object') labels[name] = value.labels;
                else if(value.label && typeof value.label === 'object') labels[name] = value.label;
                else if(typeof value.label === 'string') labels[name] = { en: value.label };
              }
              if(!processed[name]){
                processed[name] = [];
              }
              if(!labels[name]) labels[name] = { en: name };
            });
            SCALES = processed;
            SCALE_LABELS = labels;
          }else{
            throw new Error('Formato inválido en scales.json');
          }

          // Poblar select y validar estado
          const names = Object.keys(SCALES);
          if(names.length === 0) throw new Error('scales.json está vacío');

          // Si la escala guardada no existe en el JSON, usar la primera
          if(!SCALES[state.scaleName]) state.scaleName = names[0];

          refreshScaleSelect();
          scaleSel.disabled = false;

          // Evento de cambio (ahora que hay datos)
          scaleSel.addEventListener('change', ()=>{ state.scaleName = scaleSel.value; save(); renderBoard(); });

          SCALES_READY = true;
          renderTuningEditor();
          renderBoard();
        }catch(err){
          console.error('Error cargando scales.json', err);
          // Fallback mínimo para no romper la UI
          SCALES = {
            "Major (Ionian)": [0,2,4,5,7,9,11],
            "Natural minor (Aeolian)": [0,2,3,5,7,8,10],
            "Pentatonic minor": [0,3,5,7,10]
          };
          SCALE_LABELS = {
            "Major (Ionian)": { en: "Major (Ionian)", es: "Mayor (Jónica)", pt: "Maior (Jônica)" },
            "Natural minor (Aeolian)": { en: "Natural minor (Aeolian)", es: "Menor natural (Eolia)", pt: "Menor natural (Eólia)" },
            "Pentatonic minor": { en: "Pentatonic minor", es: "Pentatónica menor", pt: "Pentatônica menor" }
          };
          const names = Object.keys(SCALES);
          if(!SCALES[state.scaleName]) state.scaleName = names[0];
          refreshScaleSelect();
          scaleSel.disabled = false;
          scaleSel.addEventListener('change', ()=>{ state.scaleName = scaleSel.value; save(); renderBoard(); });
          SCALES_READY = true;
          renderTuningEditor();
          renderBoard();

          // Mensaje suave al usuario
          const msg = document.createElement('p');
          msg.style.color = 'var(--muted)';
          msg.style.fontSize = '.9rem';
          msg.style.marginTop = '8px';
          msg.textContent = t('scales_fallback_msg', 'Could not load scales.json. Using a minimal fallback.');
          document.querySelector('.controls')?.appendChild(msg);
        }
      }

      // Keep piano crisp on resize
      let rT; window.addEventListener('resize', ()=>{ clearTimeout(rT); rT=setTimeout(renderPiano, 120); });

      // Lanzar carga
      loadScales();
    })();
  </script>
</body>
</html>