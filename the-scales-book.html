<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Scales Book ‚Äî Contumance</title>
  <meta name="description" content="The Scales Book ‚Äî minimal interactive fretboard with e-ink-style aesthetics." />
  <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚ô™</text></svg>">
  <style>
    /* Base palette (light mode) aligned with index */
    :root{
      --paper:#f5f1e8; --ink:#2f2a1e; --muted:#6b6253;
      --link:#2d5842; --link-visited:#514f7a;
      --accent:#a08a63; --rule:#d8d2c2; --accent-soft:#999;
      --maxw:42rem; --radius:14px; --lh:1.6; --fs-base:18px;
    }
    /* Dark mode */
    html.theme-dark{
      --paper:#10110f; --ink:#dbd6c9; --muted:#a39c8c;
      --link:#a9d0b8; --link-visited:#c0b8e0;
      --accent:#2a2b27; --rule:#2a2b27; --accent-soft:#7f7a6b;
    }
    html{font-size:var(--fs-base)}
    body{
      margin:0; padding:0; color:var(--ink); background:var(--paper);
      font-family:ui-serif, Georgia, "Iowan Old Style", "Palatino Linotype", Palatino, serif;
      line-height:var(--lh); text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased;
    }
    /* subtle paper texture */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.06;
      background-image:
        radial-gradient(circle at 25% 15%, #000 0.5px, transparent 0.5px),
        radial-gradient(circle at 75% 85%, #000 0.5px, transparent 0.5px);
      background-size:3px 3px, 3px 3px; mix-blend-mode:multiply;
    }
    main{max-width:var(--maxw); margin:0 auto; padding:7vh 1.25rem 4rem;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem;}
    nav.breadcrumb{font-size:.95rem}
    nav.breadcrumb a{color:var(--link); text-decoration:none; text-underline-offset:2px;}
    h1{margin:.2rem 0 .3rem 0; font-weight:600; font-size:clamp(1.6rem,4vw,2.2rem);}
    .subtitle{color:var(--muted); font-size:.95rem; margin-bottom:.8rem;}
    .theme-toggle{
      border:1px solid var(--accent); background:transparent; color:var(--ink);
      border-radius:.45rem; padding:.35rem .55rem; cursor:pointer; font-size:1.15rem; line-height:1;
    }
    .theme-toggle:focus-visible{outline:2px dashed var(--accent); outline-offset:2px;}
    hr{border:none; border-top:1px solid var(--accent); margin:1.25rem 0; opacity:.5;}
    details.panel{border:1px solid var(--accent); border-radius:.6rem; background:rgba(255,255,255,.6);}
    html.theme-dark details.panel{background:rgba(0,0,0,.1);}
    details.panel>summary{cursor:pointer; list-style:none; padding:.6rem .8rem; font-size:.95rem; font-weight:600; color:var(--ink);}
    details.panel>summary::-webkit-details-marker{display:none;}
    details.panel .panel-body{padding:.6rem .8rem .9rem;}
    .controls{display:grid; gap:8px; align-items:center; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); margin-bottom:8px;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    label{font-size:12px; opacity:.9;}
    select,button,input[type="number"]{
      appearance:none; border:1px solid var(--accent); background:transparent; color:var(--ink);
      padding:10px 12px; border-radius:.5rem; font-family:inherit; font-size:14px; line-height:1; min-width:0;
    }
    button.primary{background:var(--ink); color:var(--paper); border-color:var(--ink);}
    .tuning{display:grid; gap:8px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr));}
    .tuning .string-card{border:1px solid var(--accent); border-radius:.6rem; background:transparent; padding:8px;}

    /* -------- Piano section -------- */
    .piano-wrap{
      border:1px solid var(--accent); border-radius:.6rem; background:transparent;
      margin:14px 0 18px; padding:10px 10px 14px;
    }
    .piano-head{display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-bottom:6px; font-size:.95rem;}
    .piano-caption{color:var(--muted); font-size:.85rem;}

    /* Fretboard */
    .fretboard{width:100%; border:1px solid var(--accent); border-radius:.6rem; background:transparent;}
    .board{display:grid; grid-auto-rows:minmax(30px,5vh); grid-template-columns:40px repeat(24,1fr); position:relative; width:100%;}
    .string{display:contents;}
    .nut,.fret{border-right:1px solid var(--rule); position:relative;}
    .nut{display:flex; align-items:center; justify-content:center; font-size:12px; background:rgba(0,0,0,.04);}
    html.theme-dark .nut{background:rgba(255,255,255,.06);}
    .open-note{display:flex; align-items:center; justify-content:center; font-size:12px;}
    .cell{position:relative; display:flex; align-items:center; justify-content:center;}
    .fret-number{position:absolute; bottom:2px; right:6px; font-size:10px; opacity:.35;}
    .marker{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;}
    .dot{width:24px; height:24px; border-radius:999px; border:1.5px solid var(--accent-soft); background:transparent; display:flex; align-items:center; justify-content:center; font-size:11px;}
    .dot.root{background:var(--ink); color:var(--paper); border-color:var(--ink); font-weight:600;}
    .pos-marker{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:6px; height:6px; border-radius:999px; background:#bbb; opacity:.5;}
    .pos-marker.double{display:grid; grid-template-columns:1fr 1fr; gap:8px; width:auto; height:auto; background:transparent;}
    .pos-marker.double i{width:6px; height:6px; background:#bbb; opacity:.5; border-radius:999px; display:block;}
    .footer{margin:30px 0 60px; font-size:12px; color:var(--muted);}
    @media (prefers-reduced-motion:no-preference){
      a{position:relative; background-image:linear-gradient(currentColor,currentColor); background-position:0 100%;
        background-repeat:no-repeat; background-size:0% 1px; transition:background-size .25s ease, color .2s ease;}
      a:hover, a:focus-visible{background-size:100% 1px; outline:none;}
    }
    
    footer{
      margin-top:2.5rem; font-size:.95rem; color:var(--muted);
      display:flex; gap:.75rem; align-items:center; flex-wrap:wrap
    }
    .btn{border:1px solid var(--accent); padding:.5rem .8rem; border-radius:.35rem; text-decoration:none}
    .note{width:100%; color:var(--muted); font-style:italic; margin-top:.35rem}
  </style>
</head>
<body>
  <main>
    <div class="topbar">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="index.html">‚Üê Back to index</a>
      </nav>
      <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme" title="Toggle theme">üåì</button>
    </div>

    <header>
      <h1>The Scales Book</h1>
      <div class="subtitle">Minimal interactive fretboard for learning scales (3‚Äì10 strings, up to 24 frets).</div>
    </header>

    <details class="panel" id="panel" open>
      <summary>Guitar setup</summary>
      <div class="panel-body">
        <div class="controls" role="group" aria-label="Controls">
          <div class="row">
            <label for="stringCount">Strings</label>
            <input id="stringCount" type="number" min="3" max="10" value="6" style="width:86px" />
            <button id="applyStrings">Apply</button>
          </div>
          <div class="row">
            <label for="root">Root</label>
            <select id="root"></select>
          </div>
          <div class="row">
            <label for="scale">Scale</label>
            <select id="scale"></select>
          </div>
          <div class="row">
            <label for="labels">Labels</label>
            <select id="labels">
              <option value="notes">Notes</option>
              <option value="degrees">Degrees</option>
              <option value="off">Hidden</option>
            </select>
          </div>
        </div>
        <div id="tuningPanel" class="tuning" aria-label="Tuning editor"></div>
      </div>
    </details>

    <section class="fretboard-wrap">
      <div id="fretboard" class="fretboard">
        <div id="board" class="board" role="grid" aria-label="Fretboard"></div>
      </div>
    </section>

    <!-- ===== Piano (one octave C‚ÄìC) ===== -->
    <section class="piano-wrap" aria-label="Piano octave">
      <div class="piano-head">
        <div><strong>Piano</strong> - one octave</div>
        <div class="piano-caption" id="pianoCaption">C Major (Ionian)</div>
      </div>
      <div id="pianoContainer" style="width:100%; overflow:hidden;"></div>
    </section>

    <p class="footer">Tip: use ¬± to shift each string by semitones. Everything is saved on this device (no backend).</p>

    <footer>
      <a class="btn" href="YOUR_CAFECITO_URL" target="_blank" rel="noopener">Invite me a coffee ‚òï</a>
      <span class="note">Fuel the craft. Inspire the next page.</span>
      <span>¬© <span id="y"></span> Contumance</span>
    </footer>
  </main>

  <script>
    // --- Theme toggle ---
    (function(){
      const KEY='theme-preference';
      const root=document.documentElement;
      const btn=document.getElementById('themeToggle');
      function setIcon(mode){ btn.textContent = '‚óë'; }
      function apply(mode){ root.classList.toggle('theme-dark',mode==='dark'); setIcon(mode); }
      function getPreferred(){
        const saved=localStorage.getItem(KEY);
        if(saved==='light'||saved==='dark') return saved;
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light';
      }
      let current=getPreferred(); apply(current);
      btn.addEventListener('click',()=>{ current=current==='dark'?'light':'dark'; localStorage.setItem(KEY,current); apply(current); });
    })();
  </script>

  <script>
    (function(){
      // ------- Musical data -------
      var NOTES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      var SCALES = {
        "Major (Ionian)": [0,2,4,5,7,9,11],
        "Natural minor (Aeolian)": [0,2,3,5,7,8,10],
        "Harmonic minor": [0,2,3,5,7,8,11],
        "Melodic minor (asc)": [0,2,3,5,7,9,11],
        "Pentatonic major": [0,2,4,7,9],
        "Pentatonic minor": [0,3,5,7,10],
        "Blues minor": [0,3,5,6,7,10],
        "Dorian": [0,2,3,5,7,9,10],
        "Phrygian": [0,1,3,5,7,8,10],
        "Lydian": [0,2,4,6,7,9,11],
        "Mixolydian": [0,2,4,5,7,9,10],
        "Locrian": [0,1,3,5,6,8,10],
        "Whole tone": [0,2,4,6,8,10],
        "Chromatic": [0,1,2,3,4,5,6,7,8,9,10,11]
      };
      var DEFAULT_TUNING_6 = ["E","B","G","D","A","E"]; // 1st (highest) on top

      // ------- State & persistence -------
      var state = { strings:6, tuning:DEFAULT_TUNING_6.slice(), root:"C", scaleName:"Major (Ionian)", labelMode:"notes" };
      var LS_KEY="the_scales_book_state_v1";
      try{ var saved=JSON.parse(localStorage.getItem(LS_KEY)||"null"); if(saved&&typeof saved==="object") Object.assign(state,saved);}catch(e){}
      function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

      // ------- DOM refs -------
      var board=document.getElementById("board");
      var rootSel=document.getElementById("root");
      var scaleSel=document.getElementById("scale");
      var labelsSel=document.getElementById("labels");
      var tuningPanel=document.getElementById("tuningPanel");
      var stringCountInput=document.getElementById("stringCount");
      var applyStringsBtn=document.getElementById("applyStrings");
      var pianoContainer=document.getElementById("pianoContainer");
      var pianoCaption=document.getElementById("pianoCaption");

      // ------- Helpers -------
      function noteIndex(name){ return NOTES_SHARP.indexOf(name); }
      function cycleNote(note, step){ var i=noteIndex(note); if(i<0) i=0; i=(i+step+12)%12; return NOTES_SHARP[i]; }
      function ensureTuningLen(n){
        if(state.tuning.length<n){
          var last=state.tuning[state.tuning.length-1]||"E";
          while(state.tuning.length<n) state.tuning.push(last);
        }else if(state.tuning.length>n){ state.tuning=state.tuning.slice(0,n); }
      }
      function inScaleClass(pc, rootIdx, scale){ var rel=(pc-rootIdx+12)%12; return scale.indexOf(rel)!==-1; }

      // ------- Populate selects -------
      function fillSelect(el, arr){ el.innerHTML = arr.map(v=>'<option value="'+v+'">'+v+'</option>').join(''); }
      fillSelect(rootSel, NOTES_SHARP);
      fillSelect(scaleSel, Object.keys(SCALES));
      rootSel.value=state.root; scaleSel.value=state.scaleName; stringCountInput.value=state.strings; labelsSel.value=state.labelMode;

      // ------- Tuning editor -------
      function renderTuningEditor(){
        ensureTuningLen(state.strings);
        var html="";
        for(var idx=0; idx<state.tuning.length; idx++){
          var note=state.tuning[idx], stringNum=idx+1;
          var opts=NOTES_SHARP.map(n=>'<option value="'+n+'"'+(n===note?' selected':'')+'>'+n+'</option>').join('');
          html+= '<div class="string-card">'
               +   '<div style="font-size:12px; opacity:.8; margin-bottom:6px;">String '+stringNum+'</div>'
               +   '<div class="row" style="gap:6px;">'
               +     '<button data-act="down" data-idx="'+idx+'" title="Lower">‚àí</button>'
               +     '<div class="open-note" style="min-width:40px; text-align:center">'+note+'</div>'
               +     '<button data-act="up" data-idx="'+idx+'" title="Raise">+</button>'
               +     '<select data-act="set" data-idx="'+idx+'" style="flex:1; min-width:0;">'+opts+'</select>'
               +   '</div>'
               + '</div>';
        }
        tuningPanel.innerHTML=html;
        tuningPanel.querySelectorAll('button').forEach(function(btn){
          btn.addEventListener('click',function(){
            var i=+btn.dataset.idx; var act=btn.dataset.act;
            state.tuning[i]=cycleNote(state.tuning[i], act==='up'?+1:-1);
            save(); renderTuningEditor(); renderBoard();
          });
        });
        tuningPanel.querySelectorAll('select').forEach(function(sel){
          sel.addEventListener('change', function(){ var i=+sel.dataset.idx; state.tuning[i]=sel.value; save(); renderBoard(); });
        });
      }

      // ------- Fretboard render -------
      var FRETS=24;
      function renderBoard(){
        board.innerHTML="";
        var markerCols=new Set([3,5,7,9,12,15,17,19,21,24]);
        var scale=SCALES[state.scaleName];
        var rootIdx=noteIndex(state.root);
        var degreeBySemitone=new Map();
        scale.forEach(function(off,i){ degreeBySemitone.set(off%12, String(i+1)); });

        for(var s=0; s<state.strings; s++){
          var openIdx=noteIndex(state.tuning[s]);
          var stringRow=document.createElement('div'); stringRow.className='string';

          var nut=document.createElement('div'); nut.className='nut open-note';
          if(s>0) nut.style.borderTop='1px solid var(--rule)';
          var labelSpan=document.createElement('span'); labelSpan.textContent=state.tuning[s]; nut.appendChild(labelSpan);

          var openSemitone=openIdx%12;
          if(inScaleClass(openSemitone, rootIdx, scale)){
            var m0=document.createElement('div'); m0.className='marker';
            var d0=document.createElement('div'); d0.className='dot';
            if(((openSemitone-rootIdx+12)%12)===0) d0.classList.add('root');
            var label0="";
            if(state.labelMode==='notes') label0=NOTES_SHARP[openSemitone];
            else if(state.labelMode==='degrees'){ var rel0=(openSemitone-rootIdx+12)%12; label0=degreeBySemitone.get(rel0)||""; }
            d0.textContent=label0; m0.appendChild(d0); nut.appendChild(m0);
          }
          stringRow.appendChild(nut);

          for(var f=1; f<=FRETS; f++){
            var cell=document.createElement('div'); cell.className='fret cell';
            if(s>0) cell.style.borderTop='1px solid var(--rule)';
            var semitone=(openIdx+f)%12;
            if(inScaleClass(semitone, rootIdx, scale)){
              var m=document.createElement('div'); m.className='marker';
              var dot=document.createElement('div'); dot.className='dot';
              if(((semitone-rootIdx+12)%12)===0) dot.classList.add('root');
              var label="";
              if(state.labelMode==='notes') label=NOTES_SHARP[semitone];
              else if(state.labelMode==='degrees'){ var rel=(semitone-rootIdx+12)%12; label=degreeBySemitone.get(rel)||""; }
              dot.textContent=label; m.appendChild(dot); cell.appendChild(m);
            }
            if(s===state.strings-1){
              var num=document.createElement('div'); num.className='fret-number'; num.textContent=f; cell.appendChild(num);
              if(markerCols.has(f)){
                var pm=document.createElement('div');
                if(f===12||f===24){ pm.className='pos-marker double'; var i1=document.createElement('i'); var i2=document.createElement('i'); pm.appendChild(i1); pm.appendChild(i2); }
                else { pm.className='pos-marker'; }
                cell.appendChild(pm);
              }
            }
            stringRow.appendChild(cell);
          }
          board.appendChild(stringRow);
        }

        // refresh piano too
        renderPiano();
      }

      // ------- Piano (SVG, one octave C‚ÄìC) -------
      var WHITE = ["C","D","E","F","G","A","B"];
      var WHITE_PC = WHITE.map(n=>NOTES_SHARP.indexOf(n)); // [0,2,4,5,7,9,11]
      var BLACK_AT = [0,1,3,4,5];               // after C,D,F,G,A
      var BLACK_NAMES = ["C#","D#","F#","G#","A#"];
      var BLACK_PC = BLACK_NAMES.map(n=>NOTES_SHARP.indexOf(n)); // [1,3,6,8,10]

      function renderPianoOLD(){
        var w = pianoContainer.clientWidth || 640;
        var h = 160;
        var svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("viewBox","0 0 "+w+" "+h);
        svg.setAttribute("width","100%");
        svg.setAttribute("height","auto");
        svg.setAttribute("role","img");
        svg.setAttribute("aria-label","Piano octave showing scale tones");

        var ink = getComputedStyle(document.documentElement).getPropertyValue('--ink').trim() || '#2f2a1e';
        var paper = getComputedStyle(document.documentElement).getPropertyValue('--paper').trim() || '#f5f1e8';
        var accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#a08a63';

        // Sizes
        var pad = 10;
        var innerW = w - pad*2;
        var innerH = h - pad*2;
        var whiteW = innerW / 7;
        var whiteH = innerH;
        var blackW = whiteW * 0.6;
        var blackH = innerH * 0.62;

        // Scale membership
        var scale = SCALES[state.scaleName];
        var rootIdx = noteIndex(state.root);
        var inScaleSet = new Set(scale.map(function(off){ return (rootIdx + off) % 12; }));

        // Caption
        pianoCaption.textContent = state.root + " " + state.scaleName;

        // --- White keys ---
        WHITE_PC.forEach(function(pc, i){
          var x = pad + i*whiteW;
          var rect = document.createElementNS(svg.namespaceURI,"rect");
          rect.setAttribute("x",x); rect.setAttribute("y",pad);
          rect.setAttribute("width",whiteW); rect.setAttribute("height",whiteH);
          rect.setAttribute("rx","6"); rect.setAttribute("ry","6");
          rect.setAttribute("fill",paper);
          rect.setAttribute("stroke",accent);
          rect.setAttribute("stroke-width","1");
          svg.appendChild(rect);

          // If note in scale, add inner outline
          if (inScaleSet.has(pc)){
            var hi = document.createElementNS(svg.namespaceURI,"rect");
            hi.setAttribute("x",x+3); hi.setAttribute("y",pad+3);
            hi.setAttribute("width",whiteW-6); hi.setAttribute("height",whiteH-6);
            hi.setAttribute("rx","4"); hi.setAttribute("ry","4");
            hi.setAttribute("fill","none");
            hi.setAttribute("stroke",ink);
            hi.setAttribute("stroke-width","2");
            svg.appendChild(hi);
          }
          // If note is the root, fill badge at bottom
          if (pc === rootIdx){
            var badge = document.createElementNS(svg.namespaceURI,"rect");
            badge.setAttribute("x",x+whiteW*0.25);
            badge.setAttribute("y",pad+whiteH-16);
            badge.setAttribute("width",whiteW*0.5);
            badge.setAttribute("height",10);
            badge.setAttribute("rx","5");
            badge.setAttribute("fill",ink);
            svg.appendChild(badge);
          }

          // Optional tiny labels
          var label = document.createElementNS(svg.namespaceURI,"text");
          label.setAttribute("x", x + whiteW/2);
          label.setAttribute("y", pad + whiteH - 4);
          label.setAttribute("font-size","10");
          label.setAttribute("text-anchor","middle");
          label.setAttribute("fill",accent);
          label.textContent = WHITE[i];
          svg.appendChild(label);
        });

        // --- Black keys ---
        BLACK_PC.forEach(function(pc, j){
          // Black keys sit between certain white keys
          var afterWhiteIndex = BLACK_AT[j]; // index of white key to the left
          var xLeft = pad + afterWhiteIndex*whiteW;
          var x = xLeft + whiteW*0.7 - blackW/2; // centered between whites
          var y = pad;
          var rect = document.createElementNS(svg.namespaceURI,"rect");
          rect.setAttribute("x",x); rect.setAttribute("y",y);
          rect.setAttribute("width",blackW); rect.setAttribute("height",blackH);
          rect.setAttribute("rx","5"); rect.setAttribute("ry","5");
          rect.setAttribute("fill",ink);
          rect.setAttribute("stroke",accent);
          rect.setAttribute("stroke-width","1.2");
          svg.appendChild(rect);

          // If in scale, add bright border
          if (inScaleSet.has(pc)){
            var hi = document.createElementNS(svg.namespaceURI,"rect");
            hi.setAttribute("x",x+2); hi.setAttribute("y",y+2);
            hi.setAttribute("width",blackW-4); hi.setAttribute("height",blackH-4);
            hi.setAttribute("rx","4"); hi.setAttribute("ry","4");
            hi.setAttribute("fill","none");
            hi.setAttribute("stroke",paper);
            hi.setAttribute("stroke-width","2");
            svg.appendChild(hi);
          }
          // Root marker on black key (small circle)
          if (pc === rootIdx){
            var circ = document.createElementNS(svg.namespaceURI,"circle");
            circ.setAttribute("cx", x + blackW/2);
            circ.setAttribute("cy", y + blackH - 8);
            circ.setAttribute("r", 4);
            circ.setAttribute("fill", paper);
            svg.appendChild(circ);
          }
        });

        // Clear & mount
        pianoContainer.innerHTML = "";
        pianoContainer.appendChild(svg);
      }

      function renderPianoOLD2(){
        var w = pianoContainer.clientWidth || 560;
        var h = 120;
        var svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("viewBox","0 0 "+w+" "+h);
        svg.setAttribute("width","100%");
        svg.setAttribute("height","auto");

        var ink = getComputedStyle(document.documentElement).getPropertyValue('--ink').trim() || '#2f2a1e';
        var paper = getComputedStyle(document.documentElement).getPropertyValue('--paper').trim() || '#f5f1e8';
        var accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#a08a63';

        // Layout
        var pad = 8;
        var innerW = w - pad*2;
        var whiteW = innerW / 7;
        var whiteH = h - pad*2;
        var blackW = whiteW * 0.55;
        var blackH = whiteH * 0.58;
        var blackOffset = whiteW * 0.7; // relative shift for overlap realism

        // Scale membership
        var scale = SCALES[state.scaleName];
        var rootIdx = noteIndex(state.root);
        var inScaleSet = new Set(scale.map(off => (rootIdx + off) % 12));

        pianoCaption.textContent = state.root + " " + state.scaleName;

        // --- White keys base ---
        WHITE_PC.forEach(function(pc,i){
          var x = pad + i*whiteW;
          var rect = document.createElementNS(svg.namespaceURI,"rect");
          rect.setAttribute("x",x);
          rect.setAttribute("y",pad);
          rect.setAttribute("width",whiteW);
          rect.setAttribute("height",whiteH);
          rect.setAttribute("fill",paper);
          rect.setAttribute("stroke",accent);
          rect.setAttribute("stroke-width","1");
          rect.setAttribute("rx","4");
          svg.appendChild(rect);

          // note labels
          var label = document.createElementNS(svg.namespaceURI,"text");
          label.setAttribute("x", x + whiteW/2);
          label.setAttribute("y", pad + whiteH - 6);
          label.setAttribute("font-size","10");
          label.setAttribute("text-anchor","middle");
          label.setAttribute("fill",accent);
          label.textContent = WHITE[i];
          svg.appendChild(label);

          // circles for notes in scale
          if (inScaleSet.has(pc)){
            var cx = x + whiteW/2;
            var cy = pad + whiteH/2;
            var circle = document.createElementNS(svg.namespaceURI,"circle");
            circle.setAttribute("cx",cx);
            circle.setAttribute("cy",cy);
            circle.setAttribute("r",whiteW*0.2);
            circle.setAttribute("stroke",ink);
            circle.setAttribute("stroke-width","2");
            circle.setAttribute("fill","none");
            svg.appendChild(circle);

            // root = filled
            if (pc === rootIdx){
              circle.setAttribute("fill",ink);
            }
          }
        });

        // --- Black keys overlapping ---
        BLACK_PC.forEach(function(pc,j){
          var afterWhite = BLACK_AT[j];
          var xLeft = pad + afterWhite*whiteW;
          var x = xLeft + blackOffset - blackW/2;
          var y = pad;
          var rect = document.createElementNS(svg.namespaceURI,"rect");
          rect.setAttribute("x",x);
          rect.setAttribute("y",y);
          rect.setAttribute("width",blackW);
          rect.setAttribute("height",blackH);
          rect.setAttribute("rx","3");
          rect.setAttribute("fill",ink);
          rect.setAttribute("stroke",accent);
          rect.setAttribute("stroke-width","1");
          svg.appendChild(rect);

          if (inScaleSet.has(pc)){
            var cx = x + blackW/2;
            var cy = y + blackH/2;
            var circ = document.createElementNS(svg.namespaceURI,"circle");
            circ.setAttribute("cx",cx);
            circ.setAttribute("cy",cy);
            circ.setAttribute("r",blackW*0.22);
            circ.setAttribute("stroke",paper);
            circ.setAttribute("stroke-width","2");
            circ.setAttribute("fill","none");
            if (pc === rootIdx){
              circ.setAttribute("fill",paper);
            }
            svg.appendChild(circ);
          }
        });

        pianoContainer.innerHTML="";
        pianoContainer.appendChild(svg);
      }

      function renderPiano(){
        var w = pianoContainer.clientWidth || 520;
        var h = 160;
        var svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("viewBox","0 0 "+w+" "+h);
        svg.setAttribute("width","100%");
        svg.setAttribute("height","auto");

        var ink = getComputedStyle(document.documentElement).getPropertyValue('--ink').trim() || '#2f2a1e';
        var paper = getComputedStyle(document.documentElement).getPropertyValue('--paper').trim() || '#f5f1e8';
        var accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#a08a63';

        // Layout refinado
        var pad = 10;
        var innerW = w - pad*2;
        var whiteW = innerW / 7.2;  // un poco m√°s angostas
        var whiteH = h - pad*2;
        var blackW = whiteW * 0.58;
        var blackH = whiteH * 0.58;
        var blackShift = whiteW * 0.74; // centradas entre blancas

        // Escala actual
        var scale = SCALES[state.scaleName];
        var rootIdx = noteIndex(state.root);
        var inScaleSet = new Set(scale.map(off => (rootIdx + off) % 12));

        pianoCaption.textContent = state.root + " " + state.scaleName;

        // --- Blancas ---
        WHITE_PC.forEach(function(pc,i){
          var x = pad + i*whiteW;
          var rect = document.createElementNS(svg.namespaceURI,"rect");
          rect.setAttribute("x",x);
          rect.setAttribute("y",pad);
          rect.setAttribute("width",whiteW);
          rect.setAttribute("height",whiteH);
          rect.setAttribute("fill",paper);
          rect.setAttribute("stroke",accent);
          rect.setAttribute("stroke-width","1");
          rect.setAttribute("rx","4");
          svg.appendChild(rect);

          // Etiquetas
          var label = document.createElementNS(svg.namespaceURI,"text");
          label.setAttribute("x", x + whiteW/2);
          label.setAttribute("y", pad + whiteH - 8);
          label.setAttribute("font-size","10");
          label.setAttribute("text-anchor","middle");
          label.setAttribute("fill",accent);
          label.textContent = WHITE[i];
          svg.appendChild(label);

          // C√≠rculos de escala (m√°s abajo para no chocar con negras)
          if (inScaleSet.has(pc)){
            var cx = x + whiteW/2;
            var cy = pad + whiteH * 0.75;
            var circle = document.createElementNS(svg.namespaceURI,"circle");
            circle.setAttribute("cx",cx);
            circle.setAttribute("cy",cy);
            circle.setAttribute("r",whiteW*0.15);
            circle.setAttribute("stroke",ink);
            circle.setAttribute("stroke-width","2");
            circle.setAttribute("fill","none");
            if (pc === rootIdx){
              circle.setAttribute("fill",ink);
            }
            svg.appendChild(circle);
          }
        });

        // --- Negras ---
        BLACK_PC.forEach(function(pc,j){
          var afterWhite = BLACK_AT[j];
          var xLeft = pad + afterWhite*whiteW;
          var x = xLeft + blackShift - blackW/2;
          var y = pad;
          var rect = document.createElementNS(svg.namespaceURI,"rect");
          rect.setAttribute("x",x);
          rect.setAttribute("y",y);
          rect.setAttribute("width",blackW);
          rect.setAttribute("height",blackH);
          rect.setAttribute("rx","3");
          rect.setAttribute("fill",ink);
          rect.setAttribute("stroke",accent);
          rect.setAttribute("stroke-width","1");
          svg.appendChild(rect);

          // C√≠rculos sobre negras (centrados)
          if (inScaleSet.has(pc)){
            var cx = x + blackW/2;
            var cy = y + blackH * 0.55;
            var circ = document.createElementNS(svg.namespaceURI,"circle");
            circ.setAttribute("cx",cx);
            circ.setAttribute("cy",cy);
            circ.setAttribute("r",blackW*0.23);
            circ.setAttribute("stroke",paper);
            circ.setAttribute("stroke-width","2");
            circ.setAttribute("fill","none");
            if (pc === rootIdx){
              circ.setAttribute("fill",paper);
            }
            svg.appendChild(circ);
          }
        });

        pianoContainer.innerHTML="";
        pianoContainer.appendChild(svg);
      }

      // ------- Events -------
      rootSel.addEventListener('change', function () { state.root = rootSel.value; save(); renderBoard(); });
      scaleSel.addEventListener('change', function () { state.scaleName = scaleSel.value; save(); renderBoard(); });
      labelsSel.addEventListener('change', function () { state.labelMode = labelsSel.value; save(); renderBoard(); });
      applyStringsBtn.addEventListener('click', function () {
        var n = Math.max(3, Math.min(10, parseInt(stringCountInput.value || 6, 10)));
        state.strings = n; ensureTuningLen(n); save(); renderTuningEditor(); renderBoard();
      });

      // ------- Init -------
      renderTuningEditor();
      renderBoard();
      rootSel.value=state.root; scaleSel.value=state.scaleName; labelsSel.value=state.labelMode;

      // Keep piano crisp on resize
      var rT; window.addEventListener('resize', function(){ clearTimeout(rT); rT=setTimeout(renderPiano, 120); });
    })();
  </script>
</body>
</html>