<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="chords_doc_title">The Chords Book — playable positions (open + 0–12)</title>
  <meta name="description"
    content="All playable chord shapes within frets 0–12, including open strings. Supports 4–8 strings." data-i18n="chords_doc_description" data-i18n-attr="content" />
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>♪</text></svg>">
  <link rel="stylesheet" href="assets/kindle.css">
  <style>
    .theme-toggle {
      font-size: 1.15rem;
    }

    .lang-select {
      border: 1px solid var(--accent);
      background: var(--btn-bg);
      color: var(--ink);
      border-radius: .45rem;
      padding: .3rem .5rem;
      font-size: .95rem;
      line-height: 1;
      font-family: inherit;
      appearance: none;
      cursor: pointer;
      background-image: linear-gradient(transparent, transparent), linear-gradient(transparent, transparent);
    }

    .lang-select:focus-visible {
      outline: 2px dashed var(--accent);
      outline-offset: 2px;
    }

    .controls {
      display: grid;
      gap: 8px;
      align-items: center;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      margin-bottom: 8px;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    label {
      font-size: 12px;
      opacity: .9;
    }

    select,
    button,
    input[type="number"] {
      appearance: none;
      border: 1px solid var(--accent);
      background: transparent;
      color: var(--ink);
      padding: 10px 12px;
      border-radius: .5rem;
      font-family: inherit;
      font-size: 14px;
      line-height: 1;
      min-width: 0;
      outline: none;
    }

    select:focus-visible,
    button:focus-visible,
    input[type="number"]:focus-visible {
      outline: 2px dashed var(--accent);
      outline-offset: 2px;
    }

    .tuning {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .string-card {
      border: 1px solid var(--accent);
      border-radius: .6rem;
      padding: 8px;
      background: transparent;
    }

    .bank {
      margin: 12px 0 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .counter {
      color: var(--muted);
      font-size: .9rem;
    }

    .grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .card {
      border: 1px solid var(--accent);
      border-radius: .6rem;
      padding: .8rem .8rem .9rem;
      background: transparent;
    }

    .title {
      font-weight: 700;
      letter-spacing: .01em;
      margin-bottom: .25rem;
    }

    .meta {
      color: var(--muted);
      font-size: .85rem;
      display: flex;
      gap: .6rem;
      flex-wrap: wrap;
    }

    .fb svg {
      max-width: 100%;
      height: auto;
      display: block;
    }

    .fb-grid line {
      stroke: var(--rule);
      stroke-width: 1;
    }

    .fb-grid .nut {
      stroke: var(--ink);
      stroke-width: 3;
    }

    .fb-note circle {
      fill: var(--ink);
    }

    .fb-note text {
      font-size: 10px;
      font-weight: 700;
      fill: var(--paper);
    }

    .fb-grid text {
      fill: var(--muted);
    }

    html.theme-dark .fb-grid text {
      fill: var(--ink);
      opacity: .85;
    }

    html.theme-dark .fb-grid line {
      stroke: #3b3a34;
    }

    html.theme-dark .fb-note text {
      fill: var(--paper);
      font-weight: 800;
    }
  </style>
</head>

<body>
  <main>
    <div class="topbar">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="index.html" data-i18n="chords_back">← Back to index</a>
      </nav>
      <div class="row" style="gap:6px; position:relative;">
        <label class="visually-hidden" for="langSelect" data-i18n="lang_label" style="position:absolute;left:-9999px;">Language</label>
        <select id="langSelect" class="lang-select" aria-label="Language" title="Language">
          <option value="en">EN</option>
          <option value="es">ES</option>
          <option value="pt">PT</option>
        </select>
        <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme"
          title="Toggle theme">☾</button>
      </div>
    </div>

    <header>
      <h1 data-i18n="chords_heading">The Chords Book</h1>
      <div class="subtitle" data-i18n="chords_subtitle">Explore unusual visions of harmony — each one a doorway to creation.</div>
    </header>

    <details class="panel" open>
      <summary data-i18n="chords_panel_summary">Guitar setup</summary>
      <div class="panel-body">
        <div class="controls" role="group" aria-label="Controls" data-i18n="chords_controls_aria" data-i18n-attr="aria-label">
          <div class="row">
            <label for="root" data-i18n="chords_control_root">Root</label>
            <select id="root" aria-label="Root" data-i18n="chords_control_root" data-i18n-attr="aria-label"></select>
          </div>
          <div class="row">
            <label for="chord" data-i18n="chords_control_chord">Chord</label>
            <select id="chord" aria-label="Chord" data-i18n="chords_control_chord" data-i18n-attr="aria-label"></select>
          </div>
          <div class="row">
            <label for="labels" data-i18n="chords_control_labels">Labels</label>
            <select id="labels" aria-label="Labels" data-i18n="chords_control_labels" data-i18n-attr="aria-label">
              <option value="degrees" selected data-i18n="chords_label_degrees">Degrees</option>
              <option value="notes" data-i18n="chords_label_notes">Notes</option>
              <option value="off" data-i18n="chords_label_off">Hidden</option>
            </select>
          </div>
          <div class="row">
            <label for="stringCount" data-i18n="chords_control_strings">Strings (4–8)</label>
            <input id="stringCount" type="number" min="4" max="8" value="6" style="width:86px" />
            <button id="applyStrings" type="button" data-i18n="chords_apply">Apply</button>
          </div>
        </div>

        <details style="margin-top:.5rem;">
          <summary style="cursor:pointer" data-i18n="chords_tuning_summary">Tuning (optional)</summary>
          <div id="tuningPanel" class="tuning" aria-label="Tuning editor" data-i18n="chords_tuning_aria" data-i18n-attr="aria-label"></div>
        </details>
      </div>
    </details>

    <div class="bank">
      <div class="counter" id="countWrap"><span id="count">0</span> <span data-i18n="chords_positions_label">playable positions</span></div>
      <div class="counter" id="context"></div>
    </div>

    <section id="cards" class="grid" aria-live="polite"></section>
    <footer>
      <!-- Botón Buy Me a Coffee adaptado al tema (sin script externo) -->
      <a class="btn" href="https://buymeacoffee.com/Contumance" target="_blank" rel="noopener noreferrer"
         aria-label="Support this library on Buy Me a Coffee" data-i18n="chords_footer_buyme_aria" data-i18n-attr="aria-label">
        <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 8h14.5a2 2 0 0 1 0 4H18l-1 5a4 4 0 0 1-3.95 3.3H8.95A4 4 0 0 1 5 17l-1-9z"/>
          <path d="M3 8h17"/>
          <path d="M7 4h6"/>
        </svg>
        <span data-i18n="chords_buyme">Buy me a coffee</span>
      </a>

      <span class="note" data-i18n="chords_footer_note">Fuel the craft. Inspire the next page.</span>
      <span>© <span id="y"></span> Re:sonance <small class="byline">by <em>Contumance</em></small></span>
    </footer>
  </main>

  <script src="assets/i18n.js"></script>
  <script>
    const chordsMessages = {
      en: {
        doc_title: "The Chords Book — playable positions (open + 0–12)",
        doc_description: "All playable chord shapes within frets 0–12, including open strings. Supports 4–8 strings.",
        lang_label: "Language",
        chords_back: "← Back to index",
        chords_heading: "The Chords Book",
        chords_subtitle: "Explore unusual visions of harmony — each one a doorway to creation.",
        chords_panel_summary: "Guitar setup",
        chords_controls_aria: "Controls",
        chords_control_root: "Root",
        chords_control_chord: "Chord",
        chords_control_labels: "Labels",
        chords_label_degrees: "Degrees",
        chords_label_notes: "Notes",
        chords_label_off: "Hidden",
        chords_control_strings: "Strings (4–8)",
        chords_apply: "Apply",
        chords_tuning_summary: "Tuning (optional)",
        chords_tuning_aria: "Tuning editor",
        chords_positions_label: "playable positions",
        chords_context: "{root} {chord} — frets 0–12 ({count} playable positions)",
        chords_meta_frets: "frets {min}–{max}",
        chords_meta_strings: "strings {first}–{last}",
        chords_meta_position: "position ~{pos}",
        chords_buyme: "Buy me a coffee",
        chords_footer_note: "Fuel the craft. Inspire the next page.",
        chords_footer_buyme_aria: "Support this library on Buy Me a Coffee",
        chords_tuning_string_label: "String {n}",
        chords_tuning_lower: "Lower",
        chords_tuning_raise: "Raise",
        chords_tuning_set_note: "Set note for string {n}",
        chords_tuning_lower_aria: "Lower string {n}",
        chords_tuning_raise_aria: "Raise string {n}",
        theme_to_light: "Switch to light mode",
        theme_to_dark: "Switch to dark mode"
      },
      es: {
        doc_title: "The Chords Book — posiciones tocables (abiertas + 0–12)",
        doc_description: "Todas las digitaciones tocables entre los trastes 0 y 12, incluyendo cuerdas al aire. Compatible con guitarras de 4 a 8 cuerdas.",
        lang_label: "Idioma",
        chords_back: "← Volver al índice",
        chords_heading: "The Chords Book",
        chords_subtitle: "Explora visiones inusuales de la armonía — cada una es una puerta hacia la creación.",
        chords_panel_summary: "Configuración de guitarra",
        chords_controls_aria: "Controles",
        chords_control_root: "Tónica",
        chords_control_chord: "Acorde",
        chords_control_labels: "Etiquetas",
        chords_label_degrees: "Grados",
        chords_label_notes: "Notas",
        chords_label_off: "Ocultas",
        chords_control_strings: "Cuerdas (4–8)",
        chords_apply: "Aplicar",
        chords_tuning_summary: "Afinación (opcional)",
        chords_tuning_aria: "Editor de afinación",
        chords_positions_label: "posiciones tocables",
        chords_context: "{root} {chord} — trastes 0–12 ({count} posiciones tocables)",
        chords_meta_frets: "trastes {min}–{max}",
        chords_meta_strings: "cuerdas {first}–{last}",
        chords_meta_position: "posición ~{pos}",
        chords_buyme: "Invítame un café",
        chords_footer_note: "Alimenta el oficio. Inspira la siguiente página.",
        chords_footer_buyme_aria: "Apoya esta biblioteca en Buy Me a Coffee",
        chords_tuning_string_label: "Cuerda {n}",
        chords_tuning_lower: "Bajar",
        chords_tuning_raise: "Subir",
        chords_tuning_set_note: "Define la nota de la cuerda {n}",
        chords_tuning_lower_aria: "Bajar cuerda {n}",
        chords_tuning_raise_aria: "Subir cuerda {n}",
        theme_to_light: "Cambiar a modo claro",
        theme_to_dark: "Cambiar a modo oscuro"
      },
      pt: {
        doc_title: "The Chords Book — posições tocáveis (abertas + 0–12)",
        doc_description: "Todos os formatos tocáveis entre os trastes 0 e 12, incluindo cordas soltas. Compatível com guitarras de 4 a 8 cordas.",
        lang_label: "Idioma",
        chords_back: "← Voltar ao índice",
        chords_heading: "The Chords Book",
        chords_subtitle: "Explore visões incomuns da harmonia — cada uma é uma porta para a criação.",
        chords_panel_summary: "Configuração da guitarra",
        chords_controls_aria: "Controles",
        chords_control_root: "Tônica",
        chords_control_chord: "Acorde",
        chords_control_labels: "Rótulos",
        chords_label_degrees: "Graus",
        chords_label_notes: "Notas",
        chords_label_off: "Ocultos",
        chords_control_strings: "Cordas (4–8)",
        chords_apply: "Aplicar",
        chords_tuning_summary: "Afinação (opcional)",
        chords_tuning_aria: "Editor de afinação",
        chords_positions_label: "posições tocáveis",
        chords_context: "{root} {chord} — trastes 0–12 ({count} posições tocáveis)",
        chords_meta_frets: "trastes {min}–{max}",
        chords_meta_strings: "cordas {first}–{last}",
        chords_meta_position: "posição ~{pos}",
        chords_buyme: "Pague-me um café",
        chords_footer_note: "Alimente o ofício. Inspire a próxima página.",
        chords_footer_buyme_aria: "Apoie esta biblioteca no Buy Me a Coffee",
        chords_tuning_string_label: "Corda {n}",
        chords_tuning_lower: "Baixar",
        chords_tuning_raise: "Subir",
        chords_tuning_set_note: "Defina a nota da corda {n}",
        chords_tuning_lower_aria: "Baixar corda {n}",
        chords_tuning_raise_aria: "Subir corda {n}",
        theme_to_light: "Alternar para modo claro",
        theme_to_dark: "Alternar para modo escuro"
      }
    };

    window.tr = (key, fallback) => (window.ReI18n ? ReI18n.t(key, fallback) : (fallback || key));
    if (window.ReI18n) {
      ReI18n.init({
        messages: chordsMessages,
        select: document.getElementById('langSelect')
      });
    }
  </script>

  <!-- Theme toggle (same logic as Scales page) -->
  <script>
    (function () {
      const KEY = 'theme-preference';
      const root = document.documentElement;
      const btn = document.getElementById('themeToggle');
      const safeTr = (k, f) => (window.tr ? window.tr(k, f) : (f || k));

      function setIcon(mode) {
        if (!btn) return;
        btn.textContent = mode === 'dark' ? '☀︎' : '☾';
        const label = mode === 'dark'
          ? safeTr('theme_to_light', 'Switch to light mode')
          : safeTr('theme_to_dark', 'Switch to dark mode');
        btn.setAttribute('aria-label', label);
        btn.setAttribute('title', label);
      }

      function apply(mode) { root.classList.toggle('theme-dark', mode === 'dark'); setIcon(mode); }
      function getPreferred() {
        const saved = localStorage.getItem(KEY);
        if (saved === 'light' || saved === 'dark') return saved;
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      let current = getPreferred();
      apply(current);
      if (btn) {
        btn.addEventListener('click', () => {
          current = current === 'dark' ? 'light' : 'dark';
          localStorage.setItem(KEY, current);
          apply(current);
        });
      }
      if (window.ReI18n) {
        ReI18n.onChange(() => { setIcon(current); });
      }
      const y = document.getElementById('y');
      if (y) y.textContent = new Date().getFullYear();
    })();
  </script>

  <script>
    (function () {
      // --- Musical data (American notation only) ---
      const NOTES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
      const PC = Object.fromEntries(NOTES.map((n, i) => [n, i]));
      const DEG = { 0: 'R', 1: '♭2', 2: '2', 3: '♭3', 4: '3', 5: '4', 6: '♭5', 7: '5', 8: '♯5', 9: '6', 10: '♭7', 11: '7' };

      const CHORDS = {
        "Major (maj)": [0, 4, 7],
        "Minor (min)": [0, 3, 7],
        "Dominant 7 (7)": [0, 4, 7, 10],
        "Major 7 (maj7)": [0, 4, 7, 11],
        "Minor 7 (m7)": [0, 3, 7, 10],
        "Diminished (dim)": [0, 3, 6],
        "Diminished 7 (dim7)": [0, 3, 6, 9],
        "Half-dim (m7b5)": [0, 3, 6, 10],
        "Augmented (+)": [0, 4, 8],
        "Sus2": [0, 2, 7],
        "Sus4": [0, 5, 7]
      };

      const DEFAULT_TUNING_6 = ["E", "B", "G", "D", "A", "E"]; // 1st (thin) -> 6th (thick)
      const FRETS_MAX = 12; // include 0–12

      function defaultTuning(n) {
        const base6 = ["E", "B", "G", "D", "A", "E"];
        if (n <= 6) return base6.slice(0, n);
        if (n === 7) return base6.concat("B");
        if (n === 8) return base6.concat(["B", "F#"]);
        return base6;
      }

      // --- State & persistence (key aligned style) ---
      const LS_KEY = 'tcb_all_playable_v2_4to8';
      const state = { strings: 6, tuning: DEFAULT_TUNING_6.slice(), root: 'E', chordName: 'Major (maj)', labels: 'degrees' };
      try { const s = JSON.parse(localStorage.getItem(LS_KEY) || 'null'); if (s && typeof s === 'object') Object.assign(state, s); } catch (e) { }
      function save() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }

      // --- DOM ---
      const cardsEl = document.getElementById('cards');
      const countEl = document.getElementById('count');
      const ctxEl = document.getElementById('context');
      const rootSel = document.getElementById('root');
      const chordSel = document.getElementById('chord');
      const labelsSel = document.getElementById('labels');
      const tuningPanel = document.getElementById('tuningPanel');
      const stringCountInput = document.getElementById('stringCount');
      const applyBtn = document.getElementById('applyStrings');

      const t = (key, fallback) => (window.tr ? window.tr(key, fallback) : (fallback || key));
      const format = (template, values = {}) => String(template || '').replace(/\{(\w+)\}/g, (_, k) => (values[k] != null ? values[k] : ''));

      // --- Helpers ---
      const wrap = (n) => (n + 12) % 12;
      const idx = (n) => PC[n];

      function ensureTuningLen(n) {
        if (state.tuning.length < n) {
          while (state.tuning.length < n) {
            const add = (state.tuning.length === 6) ? "B" : (state.tuning.length === 7) ? "F#" : state.tuning[state.tuning.length - 1];
            state.tuning.push(add);
          }
        } else if (state.tuning.length > n) {
          state.tuning = state.tuning.slice(0, n);
        }
      }

      function fillSelect(el, arr) { el.innerHTML = arr.map(v => `<option value="${v}">${v}</option>`).join(''); }
      fillSelect(rootSel, NOTES); rootSel.value = state.root;
      fillSelect(chordSel, Object.keys(CHORDS)); chordSel.value = state.chordName;
      labelsSel.value = state.labels;
      stringCountInput.value = state.strings;

      function cycle(note, step) { let i = idx(note); if (i < 0) i = 0; return NOTES[wrap(i + step)]; }

      // --- Tuning editor ---
      function renderTuningEditor() {
        ensureTuningLen(state.strings);
        let html = '';
        for (let i = 0; i < state.tuning.length; i++) {
          const note = state.tuning[i];
          const opts = NOTES.map(n => `<option value="${n}" ${n === note ? 'selected' : ''}>${n}</option>`).join('');
          const stringNum = i + 1;
          const stringLabel = format(t('chords_tuning_string_label', 'String {n}'), { n: stringNum });
          const lowerTitle = t('chords_tuning_lower', 'Lower');
          const raiseTitle = t('chords_tuning_raise', 'Raise');
          const setNote = format(t('chords_tuning_set_note', 'Set note for string {n}'), { n: stringNum });
          const lowerAria = format(t('chords_tuning_lower_aria', 'Lower string {n}'), { n: stringNum });
          const raiseAria = format(t('chords_tuning_raise_aria', 'Raise string {n}'), { n: stringNum });
          html += `<div class="string-card">
          <div style="font-size:12px;opacity:.8;margin-bottom:6px;">${stringLabel}</div>
          <div class="row" style="gap:6px;">
            <button data-act="down" data-idx="${i}" title="${lowerTitle}" aria-label="${lowerAria}">−</button>
            <div class="open-note" style="min-width:40px;text-align:center">${note}</div>
            <button data-act="up" data-idx="${i}" title="${raiseTitle}" aria-label="${raiseAria}">+</button>
            <select data-act="set" data-idx="${i}" style="flex:1;min-width:0;" aria-label="${setNote}">${opts}</select>
          </div>
        </div>`;
        }
        tuningPanel.innerHTML = html;
        tuningPanel.querySelectorAll('button').forEach(b => b.addEventListener('click', () => {
          const i = +b.dataset.idx; const up = b.dataset.act === 'up';
          state.tuning[i] = cycle(state.tuning[i], up ? +1 : -1);
          save(); renderTuningEditor(); rerender();
        }));
        tuningPanel.querySelectorAll('select').forEach(s => s.addEventListener('change', () => {
          const i = +s.dataset.idx; state.tuning[i] = s.value; save(); rerender();
        }));
      }

      function chordDegrees() {
        const base = CHORDS[state.chordName].map(wrap);
        const uniq = []; base.forEach(x => { if (!uniq.includes(x)) uniq.push(x); });
        return uniq;
      }

      // --- Playability heuristics ---
      function playable(choice) {
        const fretted = choice.filter(n => n.fret > 0);
        if (fretted.length === 0) return false;        // avoid all-open clusters
        const minF = Math.min(...choice.map(n => n.fret));
        const maxF = Math.max(...choice.map(n => n.fret));
        const span = maxF - minF;
        if (span > 4) return false;                    // compact reach (≤4)
        for (let i = 1; i < choice.length; i++) {
          const a = choice[i - 1].fret, b = choice[i].fret;
          if (Math.abs(a - b) > 3) return false;         // adjacent finger jumps
        }
        return true;
      }

      function includesAllDegrees(choice, required) {
        const got = new Set(choice.map(c => wrap(c.rel)));
        if (!got.has(0)) return false;               // must contain the root
        for (const d of required) { if (!got.has(d)) return false; }
        return true;
      }

      // Generate closed-position voicings (3 & 4 strings), 0–12, filtered by playability + coverage
      function generateAllVoicings() {
        const chord = chordDegrees(); const rootPc = idx(state.root);
        const required = new Set(chord);
        const wantCount = chord.length; // 3 or 4
        const strings = state.strings | 0;
        const results = [];
        const sizes = [3, 4];

        for (const used of sizes) {
          for (let s0 = 0; s0 <= strings - used; s0++) {
            const s1 = s0 + used - 1;

            for (let f0 = 0; f0 <= FRETS_MAX; f0++) {
              const choice = []; let ok = true;

              for (let s = s0; s <= s1; s++) {
                const openPc = idx(state.tuning[s]);
                let found = null;
                for (let f = f0; f <= Math.min(FRETS_MAX, f0 + 4); f++) {
                  const pc = wrap(openPc + f);
                  const rel = wrap(pc - rootPc);
                  if (required.has(rel)) { found = { string: s, fret: f, pc, rel }; break; }
                }
                if (!found) { ok = false; break; }
                choice.push(found);
              }
              if (!ok) continue;

              if (!includesAllDegrees(choice, chord)) continue;

              const uniqDeg = Array.from(new Set(choice.map(c => wrap(c.rel))));
              if (uniqDeg.length < Math.min(required.size || chord.length, wantCount)) continue;

              if (!playable(choice)) continue;

              const minF = Math.min(...choice.map(n => n.fret));
              const maxF = Math.max(...choice.map(n => n.fret));
              const span = maxF - minF;
              const median = (minF + maxF) / 2;

              results.push({
                s0, s1, minF, maxF, span, median,
                notes: choice.map(c => ({ s: c.string, f: c.fret, rel: c.rel, pc: c.pc }))
              });
            }
          }
        }

        results.sort((a, b) => a.span === b.span ? a.minF - b.minF : a.span - b.span);

        const dedup = []; const seen = new Set();
        for (const v of results) {
          const k = `${v.s0}-${v.s1}-${Math.round(v.median)}-${v.span}`;
          if (seen.has(k)) continue;
          seen.add(k); dedup.push(v);
        }
        return dedup;
      }

      function stringsLabel(s0, s1) {
        return format(t('chords_meta_strings', 'strings {first}–{last}'), { first: s0 + 1, last: s1 + 1 });
      }

      function posLabel(median) {
        const near = Math.max(0, Math.min(12, Math.round(median)));
        return format(t('chords_meta_position', 'position ~{pos}'), { pos: near });
      }

      // SVG card (nut rendered at fret 1 when startF=0, coherent with Scales)
      function svgCard(voicing, labelsMode) {
        const strings = state.strings | 0;
        const frets = Math.max(3, voicing.maxF - voicing.minF + 1);
        const startF = Math.max(0, voicing.minF);
        const w = frets * 44 + 96, h = strings * 24 + 76;
        const x0 = 70, y0 = 46, dx = 44, dy = 24;
        
        const STRING_NAMES = Array.from({ length: strings }, (_, i) => {
          const name = state.tuning[i];   // 0 = 1ª cuerda (e)
          const num = i + 1;              // 1..N
          return `${num}(${name})`;
        });

        const g = [];
        g.push(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}">`);

        // grid
        g.push(`<g class="fb-grid">`);
        for (let s = 0; s < strings; s++) {
          const y = y0 + s * dy;
          g.push(`<line x1="${x0}" y1="${y}" x2="${x0 + frets * dx}" y2="${y}" />`);
          g.push(`<text x="${x0 - 15}" y="${y + 4}" font-size="10" text-anchor="end">${STRING_NAMES[s]}</text>`);
        }
        for (let f = 0; f <= frets; f++) {
          const x = x0 + f * dx;
          const isNut = (startF === 0 && f === 1); /* thick bar at first fret position */
          g.push(`<line x1="${x}" y1="${(y0 - dy / 2)}" x2="${x}" y2="${(y0 + (strings - 1) * dy + dy / 2)}" class="${isNut ? 'nut' : ''}" />`);
        }
        // fret numbers (including 0)
        for (let c = 0; c < frets; c++) {
          const x = x0 + (c + 0.5) * dx;
          const label = startF + c;
          g.push(`<text x="${x}" y="${(y0 - dy / 1.3)}" font-size="10" text-anchor="middle">${label}</text>`);
        }
        g.push(`</g>`);

        // notes
        g.push(`<g class="fb-note">`);
        voicing.notes.forEach(n => {
          const visualRow = n.s;  // 0 = fila superior
          const cx = x0 + (n.f - startF + 0.5) * dx;
          const cy = y0 + visualRow * dy;
          const label = (labelsMode === 'off') ? '' :
            (labelsMode === 'notes' ? NOTES[n.pc] : (DEG[(n.rel + 12) % 12] || '•'));
          g.push(`<circle cx="${cx}" cy="${cy}" r="10.5"/>`);
          if (label) g.push(`<text x="${cx}" y="${(cy + 3)}" text-anchor="middle">${label}</text>`);
        });
        g.push(`</g>`);
        g.push(`</svg>`);
        return g.join('');
      }

      function renderCards(list) {
        countEl.textContent = list.length;
        const root = state.root; const chordN = state.chordName;
        ctxEl.textContent = format(t('chords_context', '{root} {chord} — frets 0–12 ({count} playable positions)'), {
          root,
          chord: chordN,
          count: list.length
        });

        cardsEl.innerHTML = list.map(v => {
          const title = `${posLabel(v.median)}`;
          const meta1 = format(t('chords_meta_frets', 'frets {min}–{max}'), { min: v.minF, max: v.maxF });
          const meta2 = stringsLabel(v.s0, v.s1);
          const svg = svgCard(v, state.labels);
          return `<article class="card">
          <div class="title">${title}</div>
          <div class="meta"><span>${meta1}</span><span>•</span><span>${meta2}</span></div>
          <div class="fb">${svg}</div>
        </article>`;
        }).join('');
      }

      // Small render scheduler for smoother UI
      let raf;
      function rerender() { cancelAnimationFrame(raf); raf = requestAnimationFrame(computeAndRender); }

      function computeAndRender() {
        save();
        const all = generateAllVoicings();
        renderCards(all);
      }

      // Events
      rootSel.addEventListener('change', () => { state.root = rootSel.value; rerender(); });
      chordSel.addEventListener('change', () => { state.chordName = chordSel.value; rerender(); });
      labelsSel.addEventListener('change', () => { state.labels = labelsSel.value; rerender(); });
      applyBtn.addEventListener('click', () => {
        const n = Math.max(4, Math.min(8, parseInt(stringCountInput.value || state.strings, 10)));
        if (n !== state.strings) {
          state.strings = n;
          state.tuning = defaultTuning(n).slice(0, n);
          save(); renderTuningEditor(); rerender();
        }
      });

      // Init
      (function init() {
        renderTuningEditor();
        computeAndRender();
      })();

      if (window.ReI18n) {
        ReI18n.onChange(() => {
          renderTuningEditor();
          rerender();
        });
      }
    })();
  </script>
</body>

</html>
