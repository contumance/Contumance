<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Chords Book ‚Äî Contumance</title>
  <meta name="description" content="The Chords Book ‚Äî todas las inversiones posibles de un acorde en el diapas√≥n." />
  <style>
    /* ===== Est√©tica Kindle (claro por defecto) ===== */
    :root {
      --paper: #f5f1e8; --ink:#2f2a1e; --muted:#6b6253; --accent:#a08a63; --rule:#d8d2c2;
      --link:#2d5842; --link-visited:#514f7a; --maxw:42rem; --lh:1.6; --fs:18px;
      /* Grises para inversiones (modo claro) */
      --g0: rgba(0,0,0,.12); /* root */
      --g1: rgba(0,0,0,.18);
      --g2: rgba(0,0,0,.26);
      --g3: rgba(0,0,0,.34);
      --dot-border: rgba(0,0,0,.35);
    }
    html.theme-dark{
      --paper:#10110f; --ink:#dbd6c9; --muted:#a39c8c; --accent:#2a2b27; --rule:#2a2b27;
      --link:#a9d0b8; --link-visited:#c0b8e0;
      /* Grises para inversiones (modo oscuro) */
      --g0: rgba(255,255,255,.08);
      --g1: rgba(255,255,255,.12);
      --g2: rgba(255,255,255,.16);
      --g3: rgba(255,255,255,.20);
      --dot-border: rgba(255,255,255,.35);
    }

    html{ font-size:var(--fs); }
    body{ margin:0; color:var(--ink); background:var(--paper); line-height:var(--lh);
      font-family: ui-serif, Georgia, "Iowan Old Style", "Palatino Linotype", Palatino, serif;
      text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased; }
    body::before{ content:""; position:fixed; inset:0; pointer-events:none; opacity:.06;
      background-image: radial-gradient(circle at 25% 15%, #000 .5px, transparent .5px),
                        radial-gradient(circle at 75% 85%, #000 .5px, transparent .5px);
      background-size:3px 3px, 3px 3px; mix-blend-mode:multiply; }

    main{ max-width:var(--maxw); margin:0 auto; padding:7vh 1.25rem 4rem; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom:1rem; }
    nav.breadcrumb a{ color:var(--link); text-decoration:none; text-underline-offset:2px; }
    h1{ margin:.2rem 0 .3rem; font-weight:600; font-size:clamp(1.6rem,4vw,2.2rem); }
    .subtitle{ color:var(--muted); font-size:.95rem; margin-bottom:.8rem; }

    .theme-toggle{ border:1px solid var(--accent); background:transparent; color:var(--ink);
      border-radius:.45rem; padding:.35rem .55rem; cursor:pointer; font-size:1.1rem; line-height:1; }
    .theme-toggle:focus-visible{ outline:2px dashed var(--accent); outline-offset:2px; }

    details.panel{ border:1px solid var(--accent); border-radius:.6rem; background:rgba(255,255,255,.6); }
    html.theme-dark details.panel{ background:rgba(0,0,0,.1); }
    details.panel > summary{ cursor:pointer; list-style:none; padding:.6rem .8rem; font-size:.95rem; font-weight:600; color:var(--ink); }
    details.panel > summary::-webkit-details-marker{ display:none; }
    details.panel .panel-body{ padding:.6rem .8rem .9rem; }

    .controls{ display:grid; gap:8px; align-items:center; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; opacity:.9; }
    select, button, input[type="number"]{ appearance:none; border:1px solid var(--accent); background:transparent; color:var(--ink);
      padding:10px 12px; border-radius:.5rem; font:inherit; line-height:1; min-width:0; }
    button.primary{ background:var(--ink); color:var(--paper); border-color:var(--ink); }

    .tuning{ display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); }
    .string-card{ border:1px solid var(--accent); border-radius:.6rem; padding:8px; }

    /* ===== Diapas√≥n (sin scroll, ancho completo) ===== */
    .fretboard-wrap{ margin:10px 0 40px; }
    .fretboard{ width:100%; border:1px solid var(--accent); border-radius:.6rem; }
    .board{ display:grid; width:100%; position:relative;
      grid-auto-rows:minmax(30px,5vh);
      grid-template-columns: 44px repeat(24, 1fr); /* 0=nuez + 24 trastes */ }
    .string{ display:contents; }
    .nut,.fret{ border-right:1px solid var(--rule); position:relative; }
    .nut{ display:flex; align-items:center; justify-content:center; font-size:12px; background:rgba(0,0,0,.04); }
    html.theme-dark .nut{ background:rgba(255,255,255,.06); }
    .open-note{ font-size:12px; }
    .cell{ position:relative; display:flex; align-items:center; justify-content:center; }
    .fret-number{ position:absolute; bottom:2px; right:6px; font-size:10px; opacity:.35; }

    /* Notas */
    .marker{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
    .dot{ width:24px; height:24px; border-radius:999px; border:1.5px solid var(--dot-border); background:transparent;
      display:flex; align-items:center; justify-content:center; font-size:11px; }
    .dot.root{ background:var(--ink); color:var(--paper); border-color:var(--ink); font-weight:600; }

    /* Overlays de inversiones */
    .voicing{ border-radius:.5rem; border:1px dashed var(--accent); position:relative; }
    .inv0{ background:var(--g0);} .inv1{ background:var(--g1);} .inv2{ background:var(--g2);} .inv3{ background:var(--g3);} 
    .voicing label{ position:absolute; top:4px; left:6px; font-size:10px; color:var(--muted); }

    .legend{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:12px; color:var(--muted); margin:8px 0 0; }
    .chip{ display:inline-flex; align-items:center; gap:6px; }
    .chip i{ width:14px; height:10px; border-radius:3px; display:inline-block; }
    .chip.root i{ background:var(--g0);} .chip.inv1 i{ background:var(--g1);} .chip.inv2 i{ background:var(--g2);} .chip.inv3 i{ background:var(--g3);} 

    @media (prefers-reduced-motion:no-preference){
      a{ position:relative; background-image:linear-gradient(currentColor,currentColor); background-position:0 100%; background-repeat:no-repeat; background-size:0% 1px; transition:background-size .25s ease, color .2s ease; }
      a:hover, a:focus-visible{ background-size:100% 1px; outline:none; }
    }
  </style>
</head>
<body>
  <main>
    <div class="topbar">
      <nav class="breadcrumb"><a href="index.html">‚Üê Volver al √≠ndice</a></nav>
      <button class="theme-toggle" id="themeToggle" type="button" aria-label="Cambiar tema" title="Cambiar tema">üåì</button>
    </div>

    <header>
      <h1>The Chords Book</h1>
      <div class="subtitle">Seleccion√° t√≥nica y tipo de acorde y se muestran todas las inversiones posibles a lo largo del diapas√≥n.</div>
    </header>

    <details class="panel" open>
      <summary>Setup</summary>
      <div class="panel-body">
        <div class="controls">
          <div class="row">
            <label for="stringCount">Cuerdas</label>
            <input id="stringCount" type="number" min="3" max="10" value="6" style="width:86px" />
            <button id="applyStrings">Aplicar</button>
          </div>
          <div class="row">
            <label for="root">T√≥nica</label>
            <select id="root"></select>
          </div>
          <div class="row">
            <label for="chord">Acorde</label>
            <select id="chord"></select>
          </div>
          <div class="row">
            <label for="labels">Etiquetas</label>
            <select id="labels">
              <option value="notes">Notas</option>
              <option value="degrees">Grados</option>
              <option value="off">Ocultas</option>
            </select>
          </div>
          <div class="row">
            <label for="stringsUsed">Notas por voicing</label>
            <select id="stringsUsed">
              <option value="3">3</option>
              <option value="4" selected>4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="row">
            <label for="span">Rango de trastes (m√°x)</label>
            <select id="span">
              <option value="3">3</option>
              <option value="4" selected>4</option>
              <option value="5">5</option>
            </select>
          </div>
        </div>

        <div id="tuningPanel" class="tuning"></div>
        <div class="legend" aria-hidden="true">
          <span class="chip root"><i></i>Root pos.</span>
          <span class="chip inv1"><i></i>1¬™ inv.</span>
          <span class="chip inv2"><i></i>2¬™ inv.</span>
          <span class="chip inv3"><i></i>3¬™ inv.</span>
        </div>
      </div>
    </details>

    <section class="fretboard-wrap">
      <div class="fretboard">
        <div id="board" class="board" role="grid" aria-label="Fretboard"></div>
      </div>
    </section>

    <footer>
      <a class="btn" href="YOUR_CAFECITO_URL" target="_blank" rel="noopener" style="border:1px solid var(--accent); padding:.5rem .8rem; border-radius:.35rem; text-decoration:none; color:var(--link);">Invitame un cafecito</a>
    </footer>
  </main>

  <script>
    // ===== Switch de tema =====
    (function(){
      const KEY='theme-preference'; const root=document.documentElement; const btn=document.getElementById('themeToggle');
      function setIcon(mode){ btn.textContent = mode==='dark' ? '‚òÄÔ∏è':'üåô'; btn.title = mode==='dark'?'Cambiar a modo claro':'Cambiar a modo oscuro'; }
      function apply(mode){ root.classList.toggle('theme-dark', mode==='dark'); setIcon(mode); }
      function get(){ const s=localStorage.getItem(KEY); if(s==='light'||s==='dark') return s; return matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'; }
      let mode=get(); apply(mode); btn.addEventListener('click',()=>{ mode = mode==='dark'?'light':'dark'; localStorage.setItem(KEY,mode); apply(mode); });
    })();
  </script>

  <script>
  // ===== L√≥gica de acordes =====
  (function(){
    const NOTES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const CHORDS={
      "Major (maj)":        [0,4,7],
      "Minor (min)":        [0,3,7],
      "Dominant 7 (7)":     [0,4,7,10],
      "Major 7 (maj7)":     [0,4,7,11],
      "Minor 7 (m7)":       [0,3,7,10],
      "Diminished (dim)":   [0,3,6],
      "Diminished 7 (dim7)":[0,3,6,9],
      "Half‚Äëdim (m7b5)":    [0,3,6,10],
      "Augmented (+)":      [0,4,8],
      "Sus2":               [0,2,7],
      "Sus4":               [0,5,7]
    };
    const DEG={0:'R',1:'b2',2:'2',3:'b3',4:'3',5:'4',6:'b5',7:'5',8:'#5/6b',9:'6',10:'b7',11:'7'};
    const DEFAULT_TUNING_6=["E","B","G","D","A","E"]; // 1¬™ aguda arriba
    const FRETS=24;

    const state={ strings:6, tuning:DEFAULT_TUNING_6.slice(), root:'C', chordName:'Major (maj)', labels:'notes', stringsUsed:4, span:4 };
    try{ const s=JSON.parse(localStorage.getItem('the_chords_book_state_v2')||'null'); if(s) Object.assign(state,s);}catch(e){}
    function save(){ localStorage.setItem('the_chords_book_state_v2', JSON.stringify(state)); }

    // DOM refs
    const board=document.getElementById('board');
    const rootSel=document.getElementById('root');
    const chordSel=document.getElementById('chord');
    const labelsSel=document.getElementById('labels');
    const stringsUsedSel=document.getElementById('stringsUsed');
    const spanSel=document.getElementById('span');
    const stringCountInput=document.getElementById('stringCount');
    const applyBtn=document.getElementById('applyStrings');
    const tuningPanel=document.getElementById('tuningPanel');

    // Helpers
    const idx = n => NOTES.indexOf(n);
    const wrap = n => (n+12)%12;
    function ensureTuningLen(n){
      if(state.tuning.length<n){ let last=state.tuning[state.tuning.length-1]||'E'; while(state.tuning.length<n) state.tuning.push(last); }
      else if(state.tuning.length>n){ state.tuning=state.tuning.slice(0,n); }
    }

    function fillSelect(el, arr){ el.innerHTML=arr.map(v=>`<option value="${v}">${v}</option>`).join(''); }
    fillSelect(rootSel, NOTES); rootSel.value=state.root;
    fillSelect(chordSel, Object.keys(CHORDS)); chordSel.value=state.chordName;
    labelsSel.value=state.labels; stringsUsedSel.value=String(state.stringsUsed); spanSel.value=String(state.span);
    stringCountInput.value=state.strings;

    // Editor de afinaci√≥n
    function cycle(note, step){ let i=idx(note); if(i<0) i=0; return NOTES[wrap(i+step)]; }
    function renderTuningEditor(){
      ensureTuningLen(state.strings);
      let html='';
      for(let i=0;i<state.tuning.length;i++){
        const note=state.tuning[i];
        const opts=NOTES.map(n=>`<option value="${n}" ${n===note?'selected':''}>${n}</option>`).join('');
        html+=`<div class="string-card">
          <div style="font-size:12px;opacity:.8;margin-bottom:6px;">String ${i+1}</div>
          <div class="row" style="gap:6px;">
            <button data-act="down" data-idx="${i}" title="Bajar">‚àí</button>
            <div class="open-note" style="min-width:40px;text-align:center">${note}</div>
            <button data-act="up" data-idx="${i}" title="Subir">+</button>
            <select data-act="set" data-idx="${i}" style="flex:1;min-width:0;">${opts}</select>
          </div>
        </div>`;
      }
      tuningPanel.innerHTML=html;
      tuningPanel.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>{
        const i=+b.dataset.idx; const up=b.dataset.act==='up'; state.tuning[i]=cycle(state.tuning[i], up?+1:-1); save(); renderTuningEditor(); renderAll();
      }));
      tuningPanel.querySelectorAll('select').forEach(s=>s.addEventListener('change',()=>{
        const i=+s.dataset.idx; state.tuning[i]=s.value; save(); renderAll();
      }));
    }

    // Render base del diapas√≥n con notas del acorde
    function renderBoardNotes(){
      board.innerHTML='';
      const chord=CHORDS[state.chordName];
      const rootIdx=idx(state.root);
      const chordSet=new Set(chord.map(wrap));

      for(let s=0;s<state.strings;s++){
        const openIdx=idx(state.tuning[s]);
        const row=document.createElement('div'); row.className='string';
        const nut=document.createElement('div'); nut.className='nut cell'; if(s>0) nut.style.borderTop='1px solid var(--rule)';
        nut.innerHTML=`<span>${state.tuning[s]}</span>`; row.appendChild(nut);
        for(let f=1; f<=FRETS; f++){
          const cell=document.createElement('div'); cell.className='fret cell'; if(s>0) cell.style.borderTop='1px solid var(--rule)';
          const pc=wrap(openIdx+f);
          const rel=wrap(pc-rootIdx);
          if(chordSet.has(rel)){
            const m=document.createElement('div'); m.className='marker'; const d=document.createElement('div'); d.className='dot';
            if(rel===0) d.classList.add('root');
            let lbl='';
            if(state.labels==='notes') lbl=NOTES[pc]; else if(state.labels==='degrees') lbl=DEG[rel]||'';
            d.textContent=lbl; m.appendChild(d); cell.appendChild(m);
          }
          if(s===state.strings-1){ const num=document.createElement('div'); num.className='fret-number'; num.textContent=f; cell.appendChild(num); }
          row.appendChild(cell);
        }
        board.appendChild(row);
      }
    }

    // Buscar voicings (grupos contiguos de cuerdas dentro de una ventana de trastes)
    function findVoicings(){
      const chord=CHORDS[state.chordName];
      const rootIdx=idx(state.root);
      const chordSet=new Set(chord.map(wrap));
      const used=state.stringsUsed|0; const span=state.span|0;
      const results=[];

      for(let s0=0; s0<=state.strings-used; s0++){
        const s1=s0+used-1; // inclusive
        for(let f0=1; f0<=FRETS-span; f0++){
          const chosen=[]; // {s,f,pc,rel}
          let ok=true;
          for(let s=s0; s<=s1; s++){
            const openIdx=idx(state.tuning[s]);
            let found=null;
            for(let f=f0; f<=f0+span; f++){
              const pc=wrap(openIdx+f); const rel=wrap(pc-rootIdx);
              if(chordSet.has(rel)){ found={s,f,pc,rel}; break; }
            }
            if(!found){ ok=false; break; }
            chosen.push(found);
          }
          if(!ok) continue;
          // Debe tener al menos 3 grados distintos
          const uniq=new Set(chosen.map(c=>c.rel));
          if(uniq.size < Math.min(3, chordSet.size)) continue;
          // Inversi√≥n por bajo (cuerda m√°s grave => √≠ndice mayor)
          const bass = chosen.reduce((a,b)=> a.s>b.s?a:b);
          const invIdx = chord.findIndex(iv => wrap(iv)===bass.rel); // 0 root pos, 1=1¬™ inv...
          results.push({s0,s1,f0,f1:f0+span, inv:Math.max(0,Math.min(invIdx,3))});
        }
      }
      return results;
    }

    function renderVoicings(vxs){
      vxs.forEach(v=>{
        const el=document.createElement('div'); el.className='voicing inv'+v.inv;
        // grid lines: column 1 es la nuez; filas comienzan en 1 tambi√©n
        el.style.gridColumn = (v.f0) + 1 + ' / ' + (v.f1 + 2); // +1 por nuez, +1 porque CSS grid end es exclusivo
        el.style.gridRow = (v.s0+1) + ' / ' + (v.s1+2);
        const label=document.createElement('label'); label.textContent = v.inv===0?'Root': (v.inv===1?'1¬™ inv.': (v.inv===2?'2¬™ inv.':'3¬™ inv.'));
        el.appendChild(label);
        board.appendChild(el);
      });
    }

    function renderAll(){
      renderBoardNotes();
      renderVoicings(findVoicings());
      save();
    }

    // Eventos
    rootSel.addEventListener('change',()=>{ state.root=rootSel.value; renderAll(); });
    chordSel.addEventListener('change',()=>{ state.chordName=chordSel.value; renderAll(); });
    labelsSel.addEventListener('change',()=>{ state.labels=labelsSel.value; renderAll(); });
    stringsUsedSel.addEventListener('change',()=>{ state.stringsUsed=+stringsUsedSel.value; renderAll(); });
    spanSel.addEventListener('change',()=>{ state.span=+spanSel.value; renderAll(); });
    applyBtn.addEventListener('click',()=>{ const n=Math.max(3,Math.min(10,parseInt(stringCountInput.value||6,10))); state.strings=n; ensureTuningLen(n); renderTuningEditor(); renderAll(); });

    // Init
    renderTuningEditor();
    renderAll();
  })();
  </script>
</body>
</html>