<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Chords Book — posiciones tocables (open + 0–12)</title>
  <meta name="description" content="Todas las formas tocables por acorde dentro de 0–12, incluyendo cuerdas al aire. Soporta 4–8 cuerdas." />
  <style>
    :root{
      --paper:#f5f1e8; --ink:#2f2a1e; --muted:#6b6253; --accent:#a08a63; --rule:#d8d2c2;
      --link:#2d5842; --maxw:46rem; --lh:1.6;
    }
    html.theme-dark{ --paper:#10110f; --ink:#dbd6c9; --muted:#a39c8c; --accent:#2a2b27; --rule:#2a2b27; --link:#a9d0b8; }
    html{ font-size:18px }
    body{ margin:0; color:var(--ink); background:var(--paper); line-height:var(--lh);
      font-family: ui-serif, Georgia, "Iowan Old Style", Palatino, serif; -webkit-font-smoothing:antialiased; }
    main{ max-width:var(--maxw); margin:0 auto; padding:7vh 1.25rem 4rem; }
    h1{ margin:.2rem 0 .3rem; font-weight:600; font-size:clamp(1.6rem,4vw,2.1rem); }
    .subtitle{ color:var(--muted); font-size:.95rem; margin-bottom:1rem; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
    .theme-toggle{ border:1px solid var(--accent); background:transparent; color:var(--ink); border-radius:.45rem; padding:.35rem .55rem; cursor:pointer; font-size:1.05rem; }

    details.panel{ border:1px solid var(--accent); border-radius:.6rem; }
    details.panel>summary{ cursor:pointer; list-style:none; padding:.6rem .8rem; font-weight:700; }
    details.panel>summary::-webkit-details-marker{ display:none; }
    .panel-body{ padding:.5rem .8rem .8rem; }
    .controls{ display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(170px,1fr)); align-items:center; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; opacity:.9; }
    select, button, input[type="number"]{ appearance:none; border:1px solid var(--accent); background:transparent; color:var(--ink);
      padding:10px 12px; border-radius:.5rem; font:inherit; line-height:1; min-width:0; }
    .tuning{ display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); margin-top:.5rem; }
    .string-card{ border:1px solid var(--accent); border-radius:.6rem; padding:8px; }

    .bank{ margin:12px 0 6px; display:flex; justify-content:space-between; align-items:center; }
    .counter{ color:var(--muted); font-size:.9rem; }
    .grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); }
    .card{ border:1px solid var(--accent); border-radius:.6rem; padding:.8rem .8rem .9rem; background:transparent; }
    .title{ font-weight:700; letter-spacing:.01em; margin-bottom:.25rem; }
    .meta{ color:var(--muted); font-size:.85rem; display:flex; gap:.6rem; flex-wrap:wrap; }

    /* Diapasón mini */
    .fb svg{ max-width:100%; height:auto; display:block; }
    .fb-grid line{ stroke:var(--rule); stroke-width:1; }
    .fb-grid .nut{ stroke:var(--ink); stroke-width:3; }
    .fb-note circle{ fill:var(--ink); }
    .fb-note text{ font-size:10px; font-weight:700; fill:var(--paper); }
  </style>
</head>
<body>
  <main>
          <div class="topbar">
            <h1>The Chords Book</h1>
            <nav class="breadcrumb" aria-label="Miga de pan">
                <a href="index.html">← Volver al índice</a>
            </nav>
            <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme"
                title="Toggle theme">☾</button>
        </div>
    <div class="subtitle">subtitulo ... </div>

    <details class="panel" open>
      <summary>Setup</summary>
      <div class="panel-body">
        <div class="controls">
          <div class="row">
            <label for="root">Root</label>
            <select id="root"></select>
          </div>
          <div class="row">
            <label for="chord">Chord</label>
            <select id="chord"></select>
          </div>
          <div class="row">
            <label for="labels">Labels</label>
            <select id="labels">
              <option value="degrees" selected>Degrees</option>
              <option value="notes">Notes</option>
              <option value="off">Hidden</option>
            </select>
          </div>
          <div class="row">
            <label for="stringCount">Strings (4–8)</label>
            <input id="stringCount" type="number" min="4" max="8" value="6" style="width:86px" />
            <button id="applyStrings" type="button">Apply</button>
          </div>
        </div>

        <details style="margin-top:.5rem;">
          <summary style="cursor:pointer">Tuning (opcional)</summary>
          <div id="tuningPanel" class="tuning"></div>
        </details>
      </div>
    </details>

    <div class="bank">
      <div class="counter"><span id="count">0</span> posiciones</div>
      <div class="counter" id="context"></div>
    </div>

    <section id="cards" class="grid" aria-live="polite"></section>
  </main>

  <script>
    // Tema
    (function(){
      const KEY='tcb_theme'; const root=document.documentElement; const btn=document.getElementById('themeToggle');
      function setIcon(mode){ btn.textContent = mode==='dark' ? '☀︎' : '☾'; btn.title = mode==='dark'?'light mode':'dark mode'; }
      function apply(mode){ root.classList.toggle('theme-dark', mode==='dark'); setIcon(mode); }
      let mode=localStorage.getItem(KEY)|| (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
      apply(mode); btn.addEventListener('click',()=>{ mode = mode==='dark'?'light':'dark'; localStorage.setItem(KEY,mode); apply(mode); });
    })();
  </script>

  <script>
  (function(){
    const NOTES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const PC = Object.fromEntries(NOTES.map((n,i)=>[n,i]));
    const DEG={0:'R',1:'♭2',2:'2',3:'♭3',4:'3',5:'4',6:'♭5',7:'5',8:'♯5',9:'6',10:'♭7',11:'7'};

    // American notation only
    const CHORDS={
      "Major (maj)":        [0,4,7],
      "Minor (min)":        [0,3,7],
      "Dominant 7 (7)":     [0,4,7,10],
      "Major 7 (maj7)":     [0,4,7,11],
      "Minor 7 (m7)":       [0,3,7,10],
      "Diminished (dim)":   [0,3,6],
      "Diminished 7 (dim7)":[0,3,6,9],
      "Half-dim (m7b5)":    [0,3,6,10],
      "Augmented (+)":      [0,4,8],
      "Sus2":               [0,2,7],
      "Sus4":               [0,5,7]
    };

    const DEFAULT_TUNING_6=["E","B","G","D","A","E"]; // 1ª (aguda) -> 6ª (grave)
    const FRETS_MAX=12; // incluir 0–12

    function defaultTuning(n){
      // Derivado de 6 cuerdas estándar, añadiendo graves al final
      const base6=["E","B","G","D","A","E"];
      if(n<=6) return base6.slice(0,n);
      if(n===7) return base6.concat("B");
      if(n===8) return base6.concat(["B","F#"]);
      return base6;
    }

    const state={
      strings:6, tuning:DEFAULT_TUNING_6.slice(), root:'E', chordName:'Major (maj)', labels:'degrees'
    };
    try{ const s=JSON.parse(localStorage.getItem('tcb_all_playable_v2_4to8')||'null'); if(s) Object.assign(state,s);}catch(e){}
    function save(){ localStorage.setItem('tcb_all_playable_v2_4to8', JSON.stringify(state)); }

    // DOM
    const cardsEl=document.getElementById('cards');
    const countEl=document.getElementById('count');
    const ctxEl=document.getElementById('context');
    const rootSel=document.getElementById('root');
    const chordSel=document.getElementById('chord');
    const labelsSel=document.getElementById('labels');
    const tuningPanel=document.getElementById('tuningPanel');
    const stringCountInput=document.getElementById('stringCount');
    const applyBtn=document.getElementById('applyStrings');

    function wrap(n){ return (n+12)%12; }
    function idx(n){ return PC[n]; }

    function ensureTuningLen(n){
      if(state.tuning.length<n){
        while(state.tuning.length<n){
          const add = (state.tuning.length===6) ? "B" : (state.tuning.length===7) ? "F#" : state.tuning[state.tuning.length-1];
          state.tuning.push(add);
        }
      } else if(state.tuning.length>n){
        state.tuning=state.tuning.slice(0,n);
      }
    }

    function fillSelect(el, arr){ el.innerHTML=arr.map(v=>`<option value="${v}">${v}</option>`).join(''); }
    rootSel.innerHTML = NOTES.map(n=>`<option value="${n}">${n}</option>`).join('');
    rootSel.value=state.root;
    chordSel.innerHTML = Object.keys(CHORDS).map(n=>`<option value="${n}">${n}</option>`).join('');
    chordSel.value=state.chordName;
    labelsSel.value=state.labels;
    stringCountInput.value=state.strings;

    function cycle(note, step){ let i=idx(note); if(i<0) i=0; return NOTES[wrap(i+step)]; }
    function renderTuningEditor(){
      ensureTuningLen(state.strings);
      let html='';
      for(let i=0;i<state.tuning.length;i++){
        const note=state.tuning[i];
        const opts=NOTES.map(n=>`<option value="${n}" ${n===note?'selected':''}>${n}</option>`).join('');
        html+=`<div class="string-card">
          <div style="font-size:12px;opacity:.8;margin-bottom:6px;">String ${i+1}</div>
          <div class="row" style="gap:6px;">
            <button data-act="down" data-idx="${i}" title="Down">−</button>
            <div class="open-note" style="min-width:40px;text-align:center">${note}</div>
            <button data-act="up" data-idx="${i}" title="Up">+</button>
            <select data-act="set" data-idx="${i}" style="flex:1;min-width:0;">${opts}</select>
          </div>
        </div>`;
      }
      tuningPanel.innerHTML=html;
      tuningPanel.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>{
        const i=+b.dataset.idx; const up=b.dataset.act==='up'; state.tuning[i]=cycle(state.tuning[i], up?+1:-1); save(); renderTuningEditor(); computeAndRender();
      }));
      tuningPanel.querySelectorAll('select').forEach(s=>s.addEventListener('change',()=>{
        const i=+s.dataset.idx; state.tuning[i]=s.value; save(); computeAndRender();
      }));
    }

    function chordDegrees(){
      const base = CHORDS[state.chordName].map(wrap);
      const uniq=[]; base.forEach(x=>{ if(!uniq.includes(x)) uniq.push(x); });
      return uniq;
    }

    // === Heurísticas de tocabilidad ===
    function playable(choice){
      // choice: [{string, fret, rel, pc}, ...] con cuerdas contiguas
      const fretted = choice.filter(n=>n.fret>0);
      if(fretted.length===0) return false;            // evitar todas al aire
      const minF = Math.min(...choice.map(n=>n.fret));
      const maxF = Math.max(...choice.map(n=>n.fret));
      const span = maxF - minF;
      if(span>4) return false;                        // apertura razonable (≤4)
      // diferencia entre adyacentes (evita dedos exagerados)
      for(let i=1;i<choice.length;i++){
        const a=choice[i-1].fret, b=choice[i].fret;
        if(Math.abs(a-b)>3) return false;
      }
      return true;
    }

    function includesAllDegrees(choice, required){
      const got = new Set(choice.map(c=>wrap(c.rel)));
      // exigir la raíz siempre
      if(!got.has(0)) return false;
      // si el acorde es de 4 notas, deben estar las 4; si es triada, las 3.
      for(const d of required){ if(!got.has(d)) return false; }
      return true;
    }

    // Genera voicings cerrados 3 y 4 cuerdas, 0–12, y filtra por tocabilidad y cobertura (R incluida)
    function generateAllVoicings(){
      const chord = chordDegrees(); const rootPc = idx(state.root);
      const set = new Set(chord);
      const wantCount = chord.length; // 3 o 4
      const strings = state.strings|0;
      const results=[];
      const sizes=[3,4];

      for(const used of sizes){
        for(let s0=0; s0<=strings-used; s0++){
          const s1 = s0 + used - 1;

          for(let f0=0; f0<=FRETS_MAX; f0++){
            const choice=[]; let ok=true;

            for(let s=s0; s<=s1; s++){
              const openPc = idx(state.tuning[s]);
              let found=null;
              for(let f=f0; f<=Math.min(FRETS_MAX, f0+4); f++){
                const pc = wrap(openPc + f);
                const rel = wrap(pc - rootPc);
                if(set.has(rel)){ found = { string:s, fret:f, pc, rel }; break; }
              }
              if(!found){ ok=false; break; }
              choice.push(found);
            }
            if(!ok) continue;

            // Cobertura exacta del acorde (triada o cuatríada) — siempre con R
            const uniqDeg = Array.from(new Set(choice.map(c=>wrap(c.rel))));
            if(!includesAllDegrees(choice, chord)) continue;
            if(uniqDeg.length < Math.min(chord.size||chord.length, wantCount)) continue;

            // Tocabilidad
            if(!playable(choice)) continue;

            const minF = Math.min(...choice.map(n=>n.fret));
            const maxF = Math.max(...choice.map(n=>n.fret));
            const span = maxF - minF;
            const median = (minF + maxF)/2;

            results.push({
              s0,s1,minF,maxF, span, median,
              notes: choice.map(c=>({s:c.string, f:c.fret, rel:c.rel, pc:c.pc}))
            });
          }
        }
      }

      // Orden: más compacto y más abajo primero
      results.sort((a,b)=> a.span===b.span ? a.minF-b.minF : a.span-b.span);

      // Deduplicación suave: mismo bloque y centro similar
      const dedup=[]; const seen=new Set();
      for(const v of results){
        const k = `${v.s0}-${v.s1}-${Math.round(v.median)}-${v.span}`;
        if(seen.has(k)) continue;
        seen.add(k); dedup.push(v);
      }
      return dedup;
    }

    function stringsLabel(s0,s1,total){
      const hi = total - s1; // 6–4, etc.
      const lo = total - s0;
      return `cuerdas ${lo}–${hi}`;
    }
    function posLabel(median){
      const near = Math.max(0, Math.min(12, Math.round(median)));
      return `posición ~${near}ª`;
    }

    function svgCard(voicing, labelsMode){
      const strings = state.strings|0;
      const frets = Math.max(3, voicing.maxF - voicing.minF + 1);
      const startF = Math.max(0, voicing.minF);
      const w = frets*44 + 96, h = strings*24 + 76;
      const x0 = 70, y0 = 46, dx = 44, dy = 24;

      const STRING_NAMES = Array.from({length:strings}, (_,i)=>{
        const idxStr = strings-1-i;
        const name = state.tuning[idxStr];
        const num = strings-i;
        return `${num}(${name})`;
      });

      const g=[];
      g.push(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}">`);

      // grid (líneas de traste)
      g.push(`<g class="fb-grid">`);
      for(let s=0; s<strings; s++){
        const y = y0 + s*dy;
        g.push(`<line x1="${x0}" y1="${y}" x2="${x0 + frets*dx}" y2="${y}" />`);
        g.push(`<text x="${x0-15}" y="${y+4}" font-size="10" text-anchor="end">${STRING_NAMES[s]}</text>`);
      }
      for(let f=0; f<=frets; f++){
        const x = x0 + f*dx;
        const isNut = (startF===0 && f===1);
        g.push(`<line x1="${x}" y1="${(y0 - dy/2)}" x2="${x}" y2="${(y0 + (strings-1)*dy + dy/2)}" class="${isNut?'nut':''}" />`);
      }
      // etiquetas centradas por espacio (incluye 0)
      for(let c=0; c<frets; c++){
        const x = x0 + (c+0.5)*dx;
        const label = startF + c;
        g.push(`<text x="${x}" y="${(y0 - dy/1.3)}" font-size="10" text-anchor="middle">${label}</text>`);
      }
      g.push(`</g>`);

      // notas
      g.push(`<g class="fb-note">`);
      voicing.notes.forEach(n=>{
        const visualRow = (strings-1) - n.s;
        const cx = x0 + (n.f - startF + 0.5)*dx;
        const cy = y0 + visualRow*dy;
        const label = (labelsMode==='off') ? '' :
                      (labelsMode==='notes' ? NOTES[n.pc] : (DEG[(n.rel+12)%12]||'•'));
        g.push(`<circle cx="${cx}" cy="${cy}" r="10.5"/>`);
        if(label) g.push(`<text x="${cx}" y="${(cy+3)}" text-anchor="middle">${label}</text>`);
      });
      g.push(`</g>`);
      g.push(`</svg>`);
      return g.join('');
    }

    function renderCards(list){
      countEl.textContent = list.length;
      const root = state.root; const chordN = state.chordName;
      ctxEl.textContent = `${root} ${chordN} — 0–12 fr. (${list.length} posiciones tocables)`;

      cardsEl.innerHTML = list.map(v=>{
        const title = `${posLabel(v.median)}`;
        const meta1 = `trastes ${v.minF}–${v.maxF}`;
        const meta2 = stringsLabel(v.s0, v.s1, state.strings);
        const svg = svgCard(v, state.labels);
        return `<article class="card">
          <div class="title">${title}</div>
          <div class="meta"><span>${meta1}</span><span>•</span><span>${meta2}</span></div>
          <div class="fb">${svg}</div>
        </article>`;
      }).join('');
    }

    function computeAndRender(){
      save();
      const all = generateAllVoicings();
      renderCards(all);
    }

    // Eventos
    rootSel.addEventListener('change',()=>{ state.root=rootSel.value; computeAndRender(); });
    chordSel.addEventListener('change',()=>{ state.chordName=chordSel.value; computeAndRender(); });
    labelsSel.addEventListener('change',()=>{ state.labels=labelsSel.value; computeAndRender(); });
    applyBtn.addEventListener('click',()=>{
      const n = Math.max(4, Math.min(8, parseInt(stringCountInput.value||state.strings,10)));
      state.strings = n;
      // si el tamaño cambió mucho, regenerar una afinación base sensata
      state.tuning = defaultTuning(n).slice(0,n);
      save(); renderTuningEditor(); computeAndRender();
    });

    // Init
    (function init(){
      renderTuningEditor();
      computeAndRender();
    })();
  })();
  </script>
</body>
</html>