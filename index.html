<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Re:sonance — A quiet selection for curious hands.</title>
  <meta name="description" content="Re:sonance — An experimental library of sound, color, and quiet motion. Paths of vibration that awaken new forms of listening." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>☰</text></svg>">

  <style>
    :root{
      --paper:#f5f1e8; --ink:#2f2a1e; --muted:#6b6253; --link:#2d5842;
      --link-visited:#514f7a; --accent:#a08a63; --maxw:42rem; --lh:1.6; --fs-base:18px;
    }
    html.theme-dark{
      --paper:#0e0f0e; --ink:#dbd6c9; --muted:#9b9689; --link:#a9d0b8;
      --link-visited:#c0b8e0; --accent:#242523;
    }
    html{font-size:var(--fs-base)}
    body{
      margin:0; color:var(--ink); background:var(--paper);
      font-family:ui-serif, Georgia, "Iowan Old Style","Palatino Linotype", Palatino, serif;
      line-height:var(--lh); text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased;
    }

    /* textura sutil tipo papel */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.06;
      background-image:
        radial-gradient(circle at 25% 15%, #000 .5px, transparent .5px),
        radial-gradient(circle at 75% 85%, #000 .5px, transparent .5px);
      background-size:3px 3px, 3px 3px; mix-blend-mode:multiply;
    }

    main{max-width:var(--maxw); margin:0 auto; padding:9vh 1.25rem 4rem}

    header.header{display:flex; align-items:flex-start; justify-content:space-between; gap:1rem}
    header h1{font-weight:600; margin:0 0 .25rem 0; font-size:clamp(1.8rem,4vw,2.4rem); letter-spacing:.2px}
    header p.desc{margin:0 0 2rem 0; color:var(--muted); font-style:italic}

    .theme-toggle{
      border:1px solid var(--accent); background:transparent; color:var(--ink);
      border-radius:.45rem; padding:.35rem .55rem; cursor:pointer; font-size:1.15rem; line-height:1
    }
    .theme-toggle:focus-visible{outline:2px dashed var(--accent); outline-offset:2px}

    hr{border:none; border-top:1px solid var(--accent); margin:1.5rem 0; opacity:.5}

    nav h2{
      font-size:1rem; font-weight:600; text-transform:uppercase; color:var(--muted);
      margin:0 0 .5rem 0; letter-spacing:.08em
    }
    ul.index{list-style:none; padding:0; margin:0}
    ul.index li{padding:0}
    ul.index li+li{border-top:1px dotted var(--accent)}

    a{color:var(--link); text-decoration:none; text-underline-offset:2px}
    a:visited{color:var(--link-visited)}

    .item{
      display:grid;
      grid-template-columns: 1.6rem 1fr;
      grid-template-areas:
        "icon title"
        "icon meta";
      column-gap:.75rem;
      row-gap:.2rem;
      align-items:center;
      padding:.85rem 0;
      width:100%;
    }
    .item:focus-visible{outline:2px dashed var(--accent); outline-offset:2px}
    .item:hover .title,
    .item:focus-visible .title{text-decoration:underline}

    .icon{grid-area:icon; width:1.15rem; height:1.15rem; margin:0; color:currentColor; opacity:.9}
    .title{grid-area:title; line-height:1.25}
    .meta{grid-area:meta; color:var(--muted); font-size:.95rem; margin-top:.1rem}

    footer{
      margin-top:2.5rem; font-size:.95rem; color:var(--muted);
      display:flex; gap:.75rem; align-items:center; flex-wrap:wrap
    }

    /* Fallback minimal por si el script no carga */
    .bmc-fallback{
      border:1px solid var(--accent);
      padding:.55rem .85rem;
      border-radius:.4rem;
      text-decoration:none;
      color:var(--ink);
      background:transparent;
      display:inline-flex; align-items:center; gap:.5rem;
      line-height:1;
    }
    .bmc-fallback:hover, .bmc-fallback:focus-visible{
      outline:2px dashed var(--accent); outline-offset:2px;
      text-decoration:none;
    }

    .note{width:100%; color:var(--muted); font-style:italic; margin-top:.35rem}

    @media (prefers-reduced-motion:no-preference){
      a{position:relative; background-image:linear-gradient(currentColor, currentColor);
        background-position:0 100%; background-repeat:no-repeat; background-size:0% 1px;
        transition:background-size .25s ease, color .2s ease}
      a:hover, a:focus-visible{background-size:100% 1px; outline:none}
      ul.index li{transition:transform .12s ease}
      ul.index li:hover{transform:translateX(2px)}
    }
  </style>
</head>

<body>
  <main>
    <header class="header">
      <div>
        <h1>Re:sonance</h1>
        <p class="desc">A quiet selection for curious hands.</p>
      </div>
      <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme" title="Toggle theme">☾</button>
    </header>

    <hr>

    <nav aria-label="Library">
      <h2>Collection</h2>
      <ul class="index">

        <!-- SCALES -->
        <li>
          <a class="item" href="the-scales-book.html">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
              <circle cx="5" cy="16" r="1.6"></circle>
              <circle cx="9.5" cy="13.2" r="1.6"></circle>
              <circle cx="14" cy="10.6" r="1.6"></circle>
              <circle cx="18.5" cy="8" r="1.6"></circle>
            </svg>
            <span class="title">The Scales Book</span>
            <span class="meta">Paths that guide the hand toward unseen colors.</span>
          </a>
        </li>

        <!-- CHORDS -->
        <li>
          <a class="item" href="the-chords-book.html">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="6" cy="17" r="2.4"></circle>
              <circle cx="18" cy="17" r="2.4"></circle>
              <circle cx="12" cy="7" r="2.4"></circle>
              <path d="M7.9 16.2 L10.4 8.8 M16.1 16.2 L13.6 8.8" />
            </svg>
            <span class="title">The Chords Book</span>
            <span class="meta">Forms of resonance across the strings.</span>
          </a>
        </li>

        <!-- DAILY CHORD / APP -->
        <li>
          <a class="item" href="the-daily-chord.html">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3.5" y="6" width="17" height="13" rx="1.8"></rect>
              <path d="M7 4 v3 M17 4 v3 M3.5 9 h17" />
              <path d="M12 13.1 v-1.7 M12 13.1 l1.15 1.15 M12 13.1 l-1.15 1.15 M12 13.1 v1.7" />
            </svg>
            <span class="title">The Daily Chord</span>
            <span class="meta">Each day, a chord — seen anew, to awaken inspiration.</span>
          </a>
        </li>

      </ul>
    </nav>

    <footer>
      <div id="bmc-wrapper" aria-live="polite" aria-label="Buy Me a Coffee button area"></div>
      <span class="note">Echoes fuel the next vibration.</span>
      <span>© <span id="y"></span> Re:sonance</span>
    </footer>
  </main>

  <script>
  (function(){
    const KEY='theme-preference';
    const root=document.documentElement;
    const btn=document.getElementById('themeToggle');

    function setIcon(mode){
      btn.textContent = mode==='dark' ? '☀︎' : '☾';
      btn.setAttribute('aria-label', mode==='dark' ? 'Switch to light mode' : 'Switch to dark mode');
      btn.setAttribute('title', mode==='dark' ? 'Switch to light mode' : 'Switch to dark mode');
    }
    function apply(mode){ root.classList.toggle('theme-dark', mode==='dark'); setIcon(mode); }

    function getPreferred(){
      const saved=localStorage.getItem(KEY);
      if(saved==='light' || saved==='dark') return saved;
      return (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
    }

    /* ---------------- BMC: integración robusta ---------------- */
    const BMC_SLUG = 'contumance'; // asegúrate que coincida con tu slug real (en minúsculas)
    const BMC_SRC  = 'https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js';

    function cssVar(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }
    function toHex(color){
      if(!color) return '#000000';
      if(color.startsWith('#')) return color;
      const m = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
      if(!m) return '#000000';
      const [r,g,b] = m.slice(1,4).map(n=>Math.max(0,Math.min(255,parseInt(n,10))));
      return '#' + [r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
    }

    function makeScript({paper, ink, accent, link}){
      const s = document.createElement('script');
      s.type = 'text/javascript';
      s.src  = BMC_SRC;
      s.dataset.name = 'bmc-button';
      s.dataset.slug = BMC_SLUG;
      s.dataset.emoji = '';              // conserva el ícono oficial
      s.dataset.font  = 'Cookie';
      s.dataset.text  = 'Buy me a coffee';
      s.dataset.color = paper;           // fondo
      s.dataset.outlineColor = accent;   // borde
      s.dataset.fontColor    = ink;      // texto/ícono
      s.dataset.coffeeColor  = link;     // detalle del vasito
      return s;
    }

    function currentThemeColors(){
      return {
        paper: toHex(cssVar('--paper')),
        ink:   toHex(cssVar('--ink')),
        accent:toHex(cssVar('--accent')),
        link:  toHex(cssVar('--link'))
      };
    }

    function ensureWrapper(){
      let wrap = document.getElementById('bmc-wrapper');
      if(!wrap){
        wrap = document.createElement('div');
        wrap.id='bmc-wrapper';
        document.body.appendChild(wrap);
      }
      return wrap;
    }

    function hasRendered(wrap){
      // El widget oficial inyecta un <a> con clase "bmc-button"
      return !!wrap.querySelector('a.bmc-button, a[href*="buymeacoffee.com/'+BMC_SLUG+'"]');
    }

    let retryCount = 0;
    function renderBmcButton(){
      const wrap = ensureWrapper();
      wrap.innerHTML = ''; // limpia
      const script = makeScript(currentThemeColors());
      wrap.appendChild(script);

      // Observa si aparece el botón
      const start = performance.now();
      const obs = new MutationObserver(()=>{
        if(hasRendered(wrap)){
          obs.disconnect();
        }
      });
      obs.observe(wrap, {childList:true, subtree:true});

      // Timeout + reintento exponencial
      window.setTimeout(()=>{
        if(!hasRendered(wrap)){
          retryCount++;
          if(retryCount <= 3){
            // reintenta con backoff
            renderBmcButton();
          }else{
            // fallback mínimo para no perder CTA
            wrap.innerHTML = '';
            const a = document.createElement('a');
            a.className = 'bmc-fallback';
            a.href = 'https://www.buymeacoffee.com/'+BMC_SLUG;
            a.target = '_blank'; a.rel='noopener noreferrer';
            a.textContent = 'Buy me a coffee';
            wrap.appendChild(a);
          }
        }
      }, Math.min(1600 * Math.pow(1.5, retryCount), 5000));
    }
    /* ----------------------------------------------------------- */

    // Inicialización tema + BMC
    let current=getPreferred();
    apply(current);
    renderBmcButton();

    // Cambia tema + re-render del botón
    btn.addEventListener('click', ()=>{
      current = current==='dark' ? 'light' : 'dark';
      localStorage.setItem(KEY,current);
      apply(current);
      renderBmcButton();
    });

    // Año en footer
    document.getElementById('y').textContent = new Date().getFullYear();
  })();
  </script>
</body>
</html>