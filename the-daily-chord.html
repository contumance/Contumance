<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Daily Chord ‚Äî Contumance</title>
  <meta name="description" content="One chord each day as creative inspiration. Minimal e-ink-style UI, dark mode, and an inline fretboard preview." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚ô™</text></svg>">

  <style>
    /* ---- Shared palette & rhythm (matches Scales/Chords) ---- */
    :root{
      --paper:#f5f1e8; --ink:#2f2a1e; --muted:#6b6253;
      --link:#2d5842; --link-visited:#514f7a;
      --accent:#a08a63; --rule:#d8d2c2; --accent-soft:#999;
      --maxw:42rem; --radius:14px; --lh:1.6; --fs-base:18px;
    }
    html.theme-dark{
      --paper:#10110f; --ink:#dbd6c9; --muted:#a39c8c;
      --link:#a9d0b8; --link-visited:#c0b8e0;
      --accent:#2a2b27; --rule:#2a2b27; --accent-soft:#7f7a6b;
    }
    html{ font-size:var(--fs-base); }
    body{
      margin:0; padding:0; color:var(--ink); background:var(--paper); line-height:var(--lh);
      font-family: ui-serif, Georgia, "Iowan Old Style", "Palatino Linotype", Palatino, serif;
      text-rendering: optimizeLegibility; -webkit-font-smoothing: antialiased;
    }
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.06;
      background-image:
        radial-gradient(circle at 25% 15%, #000 0.5px, transparent 0.5px),
        radial-gradient(circle at 75% 85%, #000 0.5px, transparent 0.5px);
      background-size:3px 3px, 3px 3px; mix-blend-mode:multiply;
    }
    main{ max-width:var(--maxw); margin:0 auto; padding:7vh 1.25rem 4rem; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem; }
    nav.breadcrumb{ font-size:.95rem; }
    nav.breadcrumb a{ color:var(--link); text-decoration:none; text-underline-offset:2px; }
    h1{ margin:.2rem 0 .3rem 0; font-weight:600; font-size:clamp(1.6rem,4vw,2.2rem); }
    .subtitle{ color:var(--muted); font-size:.95rem; margin-bottom:.8rem; }
    .theme-toggle{
      border:1px solid var(--accent); background:transparent; color:var(--ink);
      border-radius:.45rem; padding:.35rem .55rem; cursor:pointer; font-size:1.15rem; line-height:1;
    }
    .theme-toggle:focus-visible{ outline:2px dashed var(--accent); outline-offset:2px; }
    hr{ border:none; border-top:1px solid var(--accent); margin:1.25rem 0; opacity:.5; }

    details.panel{ border:1px solid var(--accent); border-radius:.6rem; background: rgba(255,255,255,0.6); }
    html.theme-dark details.panel{ background: rgba(0,0,0,0.1); }
    details.panel>summary{ cursor:pointer; list-style:none; padding:.6rem .8rem; font-size:.95rem; font-weight:600; color:var(--ink); }
    details.panel>summary::-webkit-details-marker{ display:none; }
    details.panel .panel-body{ padding:.6rem .8rem .9rem; }

    .controls{ display:grid; gap:8px; align-items:center; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); margin-bottom:8px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; opacity:.9; }
    button, input[type="date"]{
      appearance:none; border:1px solid var(--accent); background:transparent; color:var(--ink);
      padding:10px 12px; border-radius:.5rem; font-family:inherit; font-size:14px; line-height:1; min-width:0; outline:none;
    }
    button.primary{ background:var(--ink); color:var(--paper); border-color:var(--ink); }
    button:focus-visible, input[type="date"]:focus-visible{ outline:2px dashed var(--accent); outline-offset:2px; }

    .result{ border:1px solid var(--accent); border-radius:.6rem; padding:.9rem .9rem 1rem; background:transparent; margin-top:12px; }
    .kicker{ font-size:.78rem; letter-spacing:.08em; text-transform:uppercase; color:var(--muted); }
    .big{ font-weight:700; letter-spacing:.02em; font-size:clamp(2.2rem,6vw,3rem); line-height:1.08; margin:.2rem 0 .1rem; }
    .meta{ display:flex; gap:.5rem; flex-wrap:wrap; margin:.35rem 0; }
    .tag{ border:1px solid var(--accent); border-radius:999px; padding:.2rem .55rem; font-size:.8rem; color:var(--muted); }
    .mood{ color:var(--muted); font-size:.95rem; margin-top:.2rem; }

    /* ---- Inline support note (in-flow) ---- */
    .support-note{
      display:none; /* visible via JS si corresponde */
      border:1px solid var(--accent);
      border-radius:.6rem;
      padding:.8rem .9rem;
      margin-top:12px;
      font-size:.95rem;
      background: color-mix(in oklab, var(--paper) 88%, var(--accent) 12%);
      color: var(--ink);
    }
    html.theme-dark .support-note{
      background: color-mix(in oklab, var(--ink) 70%, var(--accent) 30%);
      color: var(--paper);
    }
    .support-note .actions{
      display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-top:.45rem;
    }
    .support-note .btn{
      display:inline-flex; align-items:center; gap:.45rem; text-decoration:none;
      border:1px solid var(--accent); border-radius:999px; padding:.4rem .85rem; font-weight:600;
      transition:transform .08s ease, background-color .2s ease, color .2s ease;
    }
    .support-note .btn:active{ transform:scale(.98); }
    .support-note .btn svg{ width:1.05rem; height:1.05rem; stroke:currentColor; }
    html:not(.theme-dark) .support-note .btn{
      background: color-mix(in oklab, var(--paper) 85%, var(--accent) 15%); color: var(--ink);
    }
    html.theme-dark .support-note .btn{
      background: color-mix(in oklab, var(--ink) 55%, var(--accent) 45%); color: var(--paper);
    }
    .support-note .dismiss{
      appearance:none; background:none; border:none; padding:.25rem .4rem; cursor:pointer;
      color:inherit; opacity:.75; text-decoration:underline; text-underline-offset:2px; font-size:.9rem;
    }

    .fretcard{ border:1px solid var(--accent); border-radius:.6rem; padding:.9rem; background:transparent; margin-top:12px; }
    #fretboard{ overflow:auto; text-align:center; }
    .fret svg{ max-width:100%; height:auto; display:block; }
    .legend{ color:var(--muted); font-size:.8rem; margin-top:.5rem; text-align:center; }

    .fb-grid line{ stroke:var(--rule); stroke-width:1; }
    .fb-grid .nut{ stroke:var(--ink); stroke-width:3; }
    .fb-grid text { fill: var(--muted); }
    html.theme-dark .fb-grid text { fill: var(--ink); opacity: .85; }
    html.theme-dark .fb-grid line { stroke:#3b3a34; }
    .fb-note circle{ fill:var(--ink); cursor:pointer; transition:opacity .15s ease, transform .05s ease; }
    .fb-note circle.playing{ opacity:.85; transform:scale(0.98); }
    .fb-note text{ font-size:10px; font-weight:700; fill:var(--paper); }

    /* Footer base */
    footer{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:.25rem;
      font-size:.9rem;
      opacity:.9;
      padding:1.5rem 0;
    }
    /* Bot√≥n Buy Me a Coffee adaptado al tema */
    footer .btn{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      text-decoration:none;
      border:1px solid var(--accent);
      border-radius:999px;
      padding:.45rem .95rem;
      font-size:.9rem;
      font-weight:500;
      transition:background-color .25s ease, color .25s ease, transform .1s ease, filter .2s ease;
    }
    /* Modo claro */
    html:not(.theme-dark) footer .btn{
      background:color-mix(in oklab, var(--accent) 10%, var(--paper) 90%);
      color:var(--ink);
    }
    html:not(.theme-dark) footer .btn:hover{
      background:color-mix(in oklab, var(--accent) 20%, var(--paper) 80%);
    }
    /* Modo oscuro */
    html.theme-dark footer .btn{
      background:color-mix(in oklab, var(--accent) 40%, var(--ink) 60%);
      color:var(--paper);
    }
    html.theme-dark footer .btn:hover{
      background:color-mix(in oklab, var(--accent) 55%, var(--ink) 45%);
    }
    /* √çcono coherente con el color del texto */
    footer .btn .btn-icon{
      width:1.2rem;
      height:1.2rem;
      stroke:currentColor;
    }
    /* Texto complementario */
    footer .note{font-size:.85rem;color:var(--muted)}
    footer .byline{font-size:.75rem;opacity:.7}
    footer .byline em{font-style:italic;letter-spacing:.02em}

    @media (prefers-reduced-motion:no-preference){
      a{ position:relative; background-image:linear-gradient(currentColor,currentColor); background-position:0 100%; background-repeat:no-repeat; background-size:0% 1px; transition:background-size .25s ease, color .2s ease; }
      a:hover, a:focus-visible{ background-size:100% 1px; outline:none; }
    }
  </style>
</head>
<body>
  <main>
    <div class="topbar">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="index.html">‚Üê Back to index</a>
      </nav>
      <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme" title="Toggle theme">üåì</button>
    </div>

    <header>
      <h1>The Daily Chord</h1>
      <div class="subtitle">One chord each day as creative inspiration.</div>
    </header>

    <details class="panel" open>
      <summary>Controls</summary>
      <div class="panel-body">
        <div class="controls" role="group" aria-label="Daily chord controls">
          <div class="row">
            <button id="btnToday" class="primary" type="button">Today</button>
            <button id="btnRandom" type="button">Random</button>
            <button id="btnShare" type="button">Share / Copy</button>
          </div>
          <div class="row">
            <label for="pickDate">Pick a date:</label>
            <input type="date" id="pickDate" />
            <button id="btnGo" type="button">Show</button>
          </div>
        </div>
      </div>
    </details>

    <section class="result" aria-live="polite">
      <div class="kicker" id="dateLabel">Today</div>
      <div class="big" id="chordText">‚Äî</div>
      <div class="meta" id="metaTags"></div>
      <p class="mood" id="moodLine">‚Äî</p>
    </section>

    <!-- Inline Support Note (flujo natural de lectura) -->
    <section class="support-note" id="supportInline" aria-label="Support this project">
      <p style="margin:0">
        Did this chord spark something? If you want to keep <strong>Re:sonance</strong> brewing,
        you can <a href="https://buymeacoffee.com/Contumance" target="_blank" rel="noopener noreferrer">buy me a coffee</a>.
        It helps me carve time to build the next tools. Thank you ‚ú®
      </p>
      <div class="actions">
        <a class="btn" href="https://buymeacoffee.com/Contumance" target="_blank" rel="noopener noreferrer" aria-label="Buy me a coffee">
          <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 8h14.5a2 2 0 0 1 0 4H18l-1 5a4 4 0 0 1-3.95 3.3H8.95A4 4 0 0 1 5 17l-1-9z"/>
            <path d="M3 8h17"/><path d="M7 4h6"/>
          </svg>
          <span>Buy me a coffee</span>
        </a>
        <button class="dismiss" type="button" id="dismissSupport">Not now</button>
      </div>
    </section>

    <section class="fretcard" aria-label="Fretboard for this chord">
      <div class="kicker">Fretboard</div>
      <div id="fretboard"></div>
      <div class="legend" id="fbLegend" aria-hidden="true">Tip: tap circles to hear each note.</div>
    </section>

    <footer>
      <!-- Bot√≥n Buy Me a Coffee adaptado al tema (sin script externo) -->
      <a class="btn" href="https://buymeacoffee.com/Contumance" target="_blank" rel="noopener noreferrer"
         aria-label="Support this library on Buy Me a Coffee">
        <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 8h14.5a2 2 0 0 1 0 4H18l-1 5a4 4 0 0 1-3.95 3.3H8.95A4 4 0 0 1 5 17l-1-9z"/>
          <path d="M3 8h17"/>
          <path d="M7 4h6"/>
        </svg>
        <span>Buy me a coffee</span>
      </a>

      <span class="note">Fuel the craft. Inspire the next page.</span>
      <span>¬© <span id="y"></span> Re:sonance <small class="byline">by <em>Contumance</em></small></span>
    </footer>
  </main>

  <!-- Theme toggle -->
  <script>
    (function () {
      const KEY = 'theme-preference';
      const root = document.documentElement;
      const btn = document.getElementById('themeToggle');
      function setIcon(mode){ btn.textContent = '‚óë'; }
      function apply(mode){ root.classList.toggle('theme-dark', mode === 'dark'); setIcon(mode); }
      function getPreferred(){
        const saved = localStorage.getItem(KEY);
        if (saved === 'light' || saved === 'dark') return saved;
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      let current = getPreferred(); apply(current);
      btn.addEventListener('click', () => {
        current = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem(KEY, current); apply(current);
      });
      document.getElementById('y').textContent = new Date().getFullYear();
    })();
  </script>

  <!-- Oracle logic + fretboard + per-note audio -->
  <script>
    /* ========= Fecha normalizada (determinismo diario) ========= */
    function normalizeLocal(d){
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }
    function dayOfYear(d){
      const d0 = normalizeLocal(d);
      const s = new Date(d0.getFullYear(),0,1);
      return Math.floor((d0 - s)/86400000) + 1;
    }
    function isoWeek(d){
      const d0 = normalizeLocal(d);
      const dt = new Date(Date.UTC(d0.getFullYear(), d0.getMonth(), d0.getDate()));
      const dayNum = dt.getUTCDay() || 7;
      dt.setUTCDate(dt.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(dt.getUTCFullYear(),0,1));
      return Math.ceil((((dt - yearStart) / 86400000) + 1) / 7);
    }
    // Fase lunar fijada a 12:00 UTC de la fecha ‚Üí estable por d√≠a
    function moonPhaseDateOnly(d){
      const d0 = normalizeLocal(d);
      const msPerDay = 86400000;
      const ms = Date.UTC(d0.getFullYear(), d0.getMonth(), d0.getDate(), 12, 0, 0); // 12:00 UTC
      const jdn = ms/msPerDay + 2440587.5;
      const synodic = 29.530588853;
      const age = (jdn - 2451550.1) / synodic;
      return age - Math.floor(age);
    }

    /* ========= Etiquetas universales ========= */
    function moonPhaseName(frac){
      const names = [
        'üåë New', 'üåí Waxing crescent', 'üåì First quarter', 'üåî Waxing gibbous',
        'üåï Full', 'üåñ Waning gibbous', 'üåó Last quarter', 'üåò Waning crescent'
      ];
      const idx = Math.floor(((frac + 1/16) % 1) * 8);
      return names[idx];
    }
    function zodiacForDate(d){
      const m = d.getMonth()+1, day = d.getDate();
      const md = m*100 + day;
      const table = [
        {name:'Capricorn', sym:'‚ôëÔ∏é', start:1222}, {name:'Aquarius', sym:'‚ôíÔ∏é', start:120},
        {name:'Pisces',   sym:'‚ôìÔ∏é', start:219},  {name:'Aries',    sym:'‚ôàÔ∏é', start:321},
        {name:'Taurus',   sym:'‚ôâÔ∏é', start:420},  {name:'Gemini',   sym:'‚ôäÔ∏é', start:521},
        {name:'Cancer',   sym:'‚ôãÔ∏é', start:621},  {name:'Leo',      sym:'‚ôåÔ∏é', start:723},
        {name:'Virgo',    sym:'‚ôçÔ∏é', start:823},  {name:'Libra',    sym:'‚ôéÔ∏é', start:923},
        {name:'Scorpio',  sym:'‚ôèÔ∏é', start:1023}, {name:'Sagittarius', sym:'‚ôêÔ∏é', start:1122},
        {name:'Capricorn', sym:'‚ôëÔ∏é', start:1222}
      ];
      let pick = table[0];
      for(let i=0;i<table.length-1;i++){
        const cur = table[i], next = table[i+1];
        const inRange = (md >= cur.start && md < next.start) ||
                        (cur.start>next.start && (md >= cur.start || md < next.start));
        if(inRange){ pick = cur; break; }
      }
      return pick;
    }

    /* ========= PRNG ========= */
    function hash32(str){
      let h = 2166136261 >>> 0;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
        h ^= h >>> 13; h = (h ^ h << 7) >>> 0;
      }
      h ^= h >>> 16; h = Math.imul(h, 2246822507);
      h ^= h >>> 13; h = Math.imul(h, 3266489909);
      h ^= h >>> 16;
      return h >>> 0;
    }
    function mulberry32(a) {
      return function() {
        a |= 0; a = a + 0x6D2B79F5 | 0;
        let t = Math.imul(a ^ a >>> 15, 1 | a);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }
    function pickWeighted(rng, pairs){
      const sum = pairs.reduce((s,p)=>s+p.w,0);
      let t = rng()*sum;
      for(const p of pairs){ if((t-=p.w) <= 0) return p.v; }
      return pairs[pairs.length-1].v;
    }

    /* ========= Datos musicales ========= */
    const NOTE_PC = { "C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11 };
    const PC_TO_NAME = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const STD_TUNING = [40,45,50,55,59,64]; // E2 A2 D3 G3 B3 E4
    const STRING_NAMES = ['1(e)','2(B)','3(G)','4(D)','5(A)','6(E)'];
    const DEG_LABELS = {0:'R',1:'‚ô≠2',2:'2',3:'‚ô≠3',4:'3',5:'4',6:'‚ô≠5',7:'5',8:'‚ôØ5',9:'6',10:'‚ô≠7',11:'7'};

    const QUALITIES = {
      'major':    { intervals:[0,4,7],        symbol:'' },
      'minor':    { intervals:[0,3,7],        symbol:'m' },
      'diminished':{ intervals:[0,3,6],       symbol:'dim' },
      'dom7':     { intervals:[0,4,7,10],     symbol:'7' },
      'maj7':     { intervals:[0,4,7,11],     symbol:'maj7' },
      'm7':       { intervals:[0,3,7,10],     symbol:'m7' },
      'm7b5':     { intervals:[0,3,6,10],     symbol:'m7‚ô≠5' },
      'aug':      { intervals:[0,4,8],        symbol:'aug' },
      'sus2':     { intervals:[0,2,7],        symbol:'sus2' },
      'sus4':     { intervals:[0,5,7],        symbol:'sus4' },
      'add9':     { intervals:[0,4,7,14],     symbol:'add9' },
      'six':      { intervals:[0,4,7,9],      symbol:'6' },
      'sixNine':  { intervals:[0,4,7,9,14],   symbol:'6/9' }
    };

    function qualityForDate(rng, month){
      const isWinter = (month===12 || month<=2);
      const isSpring = (month>=3 && month<=5);
      const isSummer = (month>=6 && month<=8);
      const isAutumn = (month>=9 && month<=11);
      const base = [
        {v:'major', w: 1.2}, {v:'minor', w: 1.2}, {v:'dom7', w:1.0}, {v:'maj7', w:0.8}, {v:'m7', w:0.9},
        {v:'m7b5', w:0.4}, {v:'diminished', w:0.4}, {v:'aug', w:0.35},
        {v:'sus2', w:0.5}, {v:'sus4', w:0.5}, {v:'add9', w:0.6}, {v:'six', w:0.6}, {v:'sixNine', w:0.55}
      ];
      if(isWinter){ base.find(p=>p.v==='maj7').w += .25; base.find(p=>p.v==='m7b5').w += .15; }
      if(isSpring){ base.find(p=>p.v==='add9').w += .25; base.find(p=>p.v==='sixNine').w += .2; }
      if(isSummer){ base.find(p=>p.v==='dom7').w += .25; base.find(p=>p.v==='aug').w += .2; }
      if(isAutumn){ base.find(p=>p.v==='minor').w += .25; base.find(p=>p.v==='sus4').w += .2; }
      return pickWeighted(rng, base);
    }

    /* ========= Audio (Web Audio) ========= */
    let _ac = null, _master = null;
    function getAC(){
      if(!_ac){
        _ac = new (window.AudioContext || window.webkitAudioContext)();
        _master = _ac.createGain();
        _master.gain.value = 0.2;
        _master.connect(_ac.destination);
      }
      if(_ac.state === 'suspended') _ac.resume();
      return _ac;
    }
    function midiToFreq(m){ return 440 * Math.pow(2, (m - 69)/12); }
    function pcName(m){ return PC_TO_NAME[(m%12+12)%12]; }
    function octaveNum(m){ return Math.floor(m/12) - 1; }

    function playNote(midi, opts={}){
      const ac = getAC();
      const t0 = ac.currentTime;
      const dur = opts.duration ?? 0.6;
      const vel = Math.max(0, Math.min(1, opts.velocity ?? 0.9));
      const a = 0.005, d = 0.06, s = 0.7, r = 0.15;

      const osc = ac.createOscillator();
      const g = ac.createGain();
      osc.type = 'triangle';
      osc.frequency.value = midiToFreq(midi);

      g.gain.setValueAtTime(0, t0);
      g.gain.linearRampToValueAtTime(vel, t0 + a);
      g.gain.linearRampToValueAtTime(vel*s, t0 + a + d);
      const tend = t0 + Math.max(0.05, dur);
      g.gain.setValueAtTime(vel*s, tend);
      g.gain.linearRampToValueAtTime(0, tend + r);

      osc.connect(g).connect(_master || getAC().destination);
      osc.start(t0);
      osc.stop(tend + r + 0.02);
    }

    function bindNoteInteractivity(){
      const circles = document.querySelectorAll('#fretboard .fb-note circle');
      circles.forEach(c=>{
        c.setAttribute('tabindex', '0');
        const midi = Number(c.getAttribute('data-midi'));
        const note = c.getAttribute('data-note');
        const oct = c.getAttribute('data-oct');
        const label = c.getAttribute('data-label') || '';
        c.setAttribute('role','button');
        c.setAttribute('aria-label', `${note}${oct} ${label ? '('+label+')' : ''}`);
        const onDown = (e)=>{
          c.classList.add('playing');
          playNote(midi, { duration: (e.shiftKey? 1.2 : 0.6), velocity: 0.9 });
        };
        const onUp = ()=> c.classList.remove('playing');
        c.addEventListener('click', onDown);
        c.addEventListener('pointerdown', onDown);
        c.addEventListener('pointerup', onUp);
        c.addEventListener('pointerleave', onUp);
        c.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' || e.key===' '){
            e.preventDefault();
            onDown(e);
            setTimeout(onUp, 120);
          }
        });
      });

      const resumeOnce = ()=>{
        try{ getAC(); }catch(e){}
        window.removeEventListener('pointerdown', resumeOnce, {capture:true});
        window.removeEventListener('keydown', resumeOnce, {capture:true});
      };
      window.addEventListener('pointerdown', resumeOnce, {capture:true, once:true});
      window.addEventListener('keydown', resumeOnce, {capture:true, once:true});
    }

    /* ========= Voicing / Fretboard ========= */
    function pickVoicing(pcRoot, intervals, windowStart, inversionBias){
      const win = 5, out = [];
      const ints = intervals.slice();
      if (inversionBias && ints.length > 1){
        const rot = Math.floor(inversionBias * ints.length) % ints.length;
        for(let i=0;i<rot;i++){ ints.push(ints.shift()); }
      }
      for(let s=0; s<STD_TUNING.length; s++){
        const midiOpen = STD_TUNING[s];
        let chosen = null, deg = null;
        for(let f=windowStart; f<windowStart+win && f<=20; f++){
          const pc = (midiOpen + f) % 12;
          for(let k=0; k<ints.length; k++){
            if (pc === (pcRoot + (ints[k]%12) + 12) % 12){
              chosen = { string:s, fret:f, midi:(midiOpen+f) }; deg = (ints[k]%12); break;
            }
          }
          if(chosen) break;
        }
        out.push(chosen ? { string:s, fret:chosen.fret, deg:deg, midi:chosen.midi } : null);
      }
      return out;
    }

    function renderFretboard(rootName, qualityKey, seedMix){
      const pcRoot = NOTE_PC[rootName] || 0;
      const intervals = QUALITIES[qualityKey].intervals;
      const start = 2 + Math.floor(seedMix * 13);
      const inversionBias = (seedMix * 1.618) % 1;
      const voicing = pickVoicing(pcRoot, intervals, start, inversionBias);

      const frets = 5, startFret = start, strings = 6, w = frets*44 + 100, h = strings*26 + 70;
      const x0 = 70, y0 = 40, dx = 44, dy = 26;
      const g = [];
      g.push(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}" class="fret">`);
      g.push(`<g class="fb-grid">`);
      for(let s=0; s<strings; s++){
        const y = y0 + s*dy;
        g.push(`<line x1="${x0}" y1="${y}" x2="${x0 + frets*dx}" y2="${y}" />`);
        g.push(`<text x="${x0-15}" y="${y+4}" font-size="10" text-anchor="end">${STRING_NAMES[s]}</text>`);
      }
      for(let f=0; f<=frets; f++){
        const x = x0 + f*dx;
        const isNut = (startFret===0 && f===1);
        g.push(`<line x1="${x}" y1="${(y0 - dy/2)}" x2="${x}" y2="${(y0 + (strings-1)*dy + dy/2)}" class="${isNut?'nut':''}" />`);
      }
      for(let c=0; c<frets; c++){
        const x = x0 + (c+0.5)*dx;
        const label = startFret + c;
        g.push(`<text x="${x}" y="${(y0 - dy/1.3)}" font-size="10" text-anchor="middle">${label}</text>`);
      }
      g.push(`</g>`);
      g.push(`<g class="fb-note">`);
      voicing.forEach((v, idx) => {
        if(!v) return;
        const cx = x0 + (v.fret - startFret + .5)*dx;
        const visualRow = (strings - 1) - idx;
        const cy = y0 + visualRow*dy;
        const label = DEG_LABELS[(v.deg+12)%12] || '‚Ä¢';
        const name = pcName(v.midi);
        const oct = octaveNum(v.midi);
        g.push(`<circle cx="${cx}" cy="${cy}" r="11" data-midi="${v.midi}" data-note="${name}" data-oct="${oct}" data-label="${label}" tabindex="0"></circle>`);
        g.push(`<text x="${cx}" y="${(cy+3)}" text-anchor="middle">${label}</text>`);
      });
      g.push(`</g></svg>`);
      document.getElementById('fretboard').innerHTML = g.join('');

      bindNoteInteractivity();
    }

    /* ========= Or√°culo (determinista por d√≠a local) ========= */
    const $ = s => document.querySelector(s);
    const dateLabel = $('#dateLabel'), chordText = $('#chordText'), metaTags = $('#metaTags'), moodLine = $('#moodLine'), inputDate = $('#pickDate');

    function tagsRender(items){
      metaTags.innerHTML = '';
      items.forEach(t => {
        const el = document.createElement('span');
        el.className = 'tag';
        el.textContent = t;
        metaTags.appendChild(el);
      });
    }
    function formatDateLong(d){
      return normalizeLocal(d).toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    }
    function seedForDate(d){
      const d0 = normalizeLocal(d);
      const n = dayOfYear(d0);
      const wk = isoWeek(d0);
      const moon = moonPhaseDateOnly(d0);
      const tz = -d0.getTimezoneOffset();
      const key = `${d0.getFullYear()}-${d0.getMonth()+1}-${d0.getDate()}|doy=${n}|wk=${wk}|moon=${moon.toFixed(5)}|tz=${tz}`;
      return hash32(key);
    }

    function computeForDate(d){
      const d0 = normalizeLocal(d);
      const seed = seedForDate(d0);
      const rng = mulberry32(seed);

      const basePc = Math.floor(rng()*12);
      const moonShift = Math.floor(moonPhaseDateOnly(d0)*12) % 12;
      const pcRoot = (basePc + moonShift) % 12;
      const root = PC_TO_NAME[pcRoot];

      const qualKey = qualityForDate(rng, d0.getMonth()+1);
      const qual = QUALITIES[qualKey];
      const symbol = root + qual.symbol;

      const energy = (rng()*0.5 + moonPhaseDateOnly(d0)*0.5);
      const mood = (function(){
        if(qualKey==='diminished' || qualKey==='m7b5') return 'Veins of tension, a door half-open.';
        if(qualKey==='aug') return 'Edges sharpened, horizons bending.';
        if(qualKey==='maj7') return 'Clear air, long light, quiet breadth.';
        if(qualKey==='m7') return 'Urban dusk‚Äîglow, grain, gravity.';
        if(qualKey==='dom7') return 'Kinetic pull: orbit stable, burn inside.';
        if(qualKey==='sixNine' || qualKey==='add9') return 'Open windows, moving lines, present future.';
        if(qualKey==='sus2' || qualKey==='sus4') return 'Suspended thought, breath before the word.';
        if(qualKey==='six') return 'Warm tilt toward motion.';
        if(qualKey==='minor') return 'Inner frame, focused shadow.';
        if(qualKey==='major') return 'Contour defined, space unfolding.';
        return energy>0.5 ? 'Friction as compass.' : 'Silence is voltage.';
      })();

      const doy = dayOfYear(d0);
      const invIndex = Math.floor(rng()*4);
      const windowSeed = rng();

      dateLabel.textContent = formatDateLong(d0);
      chordText.textContent = symbol;

      const z = zodiacForDate(d0);
      const moonFrac = moonPhaseDateOnly(d0);
      const moonLabel = moonPhaseName(moonFrac);
      const quarter = 'Q' + (Math.floor(d0.getMonth()/3)+1);

      const famLabel = qualKey.replace('sixNine','6/9').replace('six','6');
      tagsRender([
        `Day ${doy}`,
        `Quality: ${famLabel}`,
        `Inv: ${['R','1st','2nd','3rd'][invIndex] || 'R'}`,
        `Zodiac: ${z.sym} ${z.name}`,
        `Moon: ${moonLabel}`,
        quarter
      ]);
      moodLine.textContent = mood;

      renderFretboard(root, qualKey, windowSeed);

      window.dispatchEvent(new CustomEvent('oracle-chord', { detail:{
        date: d0.toISOString().slice(0,10),
        dayOfYear: doy, root, quality: qualKey, symbol
      }}));
    }

    /* ========= Controles ========= */
    document.getElementById('btnToday').addEventListener('click', () => {
      computeForDate(new Date());
    });
    document.getElementById('btnRandom').addEventListener('click', () => {
      const y = (new Date()).getFullYear();
      const start = new Date(y,0,1);
      const rnd = Math.floor(Math.random()*365);
      const d = new Date(start.getTime() + rnd*86400000);
      const dn = normalizeLocal(d);
      inputDate.value = dn.toISOString().slice(0,10);
      computeForDate(dn);
    });
    document.getElementById('btnGo').addEventListener('click', () => {
      const v = inputDate.value;
      if(!v){ alert('Pick a date.'); return; }
      const parts = v.split('-').map(Number);
      const d = new Date(parts[0], parts[1]-1, parts[2]);
      computeForDate(d);
    });
    document.getElementById('btnShare').addEventListener('click', () => {
      const title = 'The Daily Chord';
      const text = document.getElementById('chordText').textContent + ' ¬∑ ' + document.getElementById('dateLabel').textContent;
      if(navigator.share){
        navigator.share({ title, text }).catch(() => {});
      }else{
        (navigator.clipboard ? navigator.clipboard.writeText(title + '\n' + text) : Promise.reject())
          .then(() => { alert('Copied to clipboard.'); })
          .catch(() => { alert(text); });
      }
    });

    // Inline support note show/hide (14 d√≠as)
    (function supportInlineLogic(){
      const el = document.getElementById('supportInline');
      const btn = document.getElementById('dismissSupport');
      if(!el || !btn) return;
      const KEY = 'support-note:v1:dismissedUntil';
      const now = Date.now();
      const until = Number(localStorage.getItem(KEY) || 0);
      if (now < until) { el.style.display = 'none'; return; }
      el.style.display = 'block';
      btn.addEventListener('click', ()=>{
        const someDays = 2*24*60*60*1000;
        localStorage.setItem(KEY, String(Date.now() + someDays));
        el.style.display = 'none';
      });
    })();

    // Init
    (function init(){
      try{
        const t = normalizeLocal(new Date());
        document.getElementById('pickDate').value = t.toISOString().slice(0,10);
        computeForDate(t);
      }catch(err){
        document.getElementById('chordText').textContent = '‚ö†Ô∏è Initialization error';
        console.error(err);
      }
    })();
  </script>
</body>
</html>