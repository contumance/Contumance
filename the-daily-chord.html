<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>The Daily Chord</title>
    <meta name="description"
        content="Un acorde por d√≠a como inspiraci√≥n creativa" />
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚ô™</text></svg>">
    <style>
        /* Paleta/estilo compartido con Scales */
        :root {
            --paper: #f5f1e8;
            --ink: #2f2a1e;
            --muted: #6b6253;
            --link: #2d5842;
            --accent: #a08a63;
            --rule: #d8d2c2;
            --maxw: 42rem;
            --lh: 1.6;
        }

        html {
            font-size: 18px
        }

        body {
            margin: 0;
            background: var(--paper);
            color: var(--ink);
            font-family: ui-serif, Georgia, serif;
            line-height: var(--lh)
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            opacity: .06;
            background-image: radial-gradient(circle at 25% 15%, #000 .5px, transparent .5px),
                radial-gradient(circle at 75% 85%, #000 .5px, transparent .5px);
            background-size: 3px 3px, 3px 3px;
            mix-blend-mode: multiply
        }

        main {
            max-width: var(--maxw);
            margin: 0 auto;
            padding: 7vh 1.25rem 4rem
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem
        }

        nav.breadcrumb a {
            color: var(--link);
            text-decoration: none
        }

        .theme-toggle {
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--ink);
            border-radius: .45rem;
            padding: .35rem .55rem;
            cursor: pointer
        }

        h1 {
            margin: .2rem 0 .3rem 0;
            font-weight: 600;
            font-size: clamp(1.6rem, 4vw, 2.2rem)
        }

        .subtitle {
            color: var(--muted);
            font-size: .95rem;
            margin-bottom: .8rem
        }

        details.panel {
            border: 1px solid var(--accent);
            border-radius: .6rem;
            background: rgba(255, 255, 255, .6)
        }

        details.panel>summary {
            cursor: pointer;
            list-style: none;
            padding: .6rem .8rem;
            font-weight: 700
        }

        details.panel>summary::-webkit-details-marker {
            display: none
        }

        .panel-body {
            padding: .6rem .8rem .9rem
        }

        .controls {
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr))
        }

        .row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center
        }

        button,
        input[type="date"] {
            appearance: none;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--ink);
            padding: 10px 12px;
            border-radius: .5rem;
            font-size: 14px
        }

        button.primary {
            background: var(--ink);
            color: var(--paper);
            border-color: var(--ink)
        }

        .result {
            border: 1px solid var(--accent);
            border-radius: .6rem;
            padding: .9rem .9rem 1rem;
            background: transparent;
            margin-top: 12px
        }

        .kicker {
            font-size: .78rem;
            letter-spacing: .08em;
            text-transform: uppercase;
            color: var(--muted)
        }

        .big {
            font-weight: 700;
            letter-spacing: .02em;
            font-size: clamp(2.2rem, 6vw, 3rem);
            line-height: 1.08;
            margin: .2rem 0 .1rem
        }

        .meta {
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
            margin: .35rem 0
        }

        .tag {
            border: 1px solid var(--accent);
            border-radius: 999px;
            padding: .2rem .55rem;
            font-size: .8rem;
            color: var(--muted)
        }

        .mood {
            color: var(--muted);
            font-size: .95rem;
            margin-top: .2rem
        }

        /* Diapas√≥n compacto */
        .fretcard {
            border: 1px solid var(--accent);
            border-radius: .6rem;
            padding: .9rem;
            background: transparent;
            margin-top: 12px
        }

        #fretboard {
            overflow: auto;
            text-align: center
        }

        .fret svg {
            max-width: 100%;
            height: auto;
            display: block
        }

        .legend {
            color: var(--muted);
            font-size: .8rem;
            margin-top: .5rem;
            text-align: center
        }

        .fb-grid line {
            stroke: var(--rule);
            stroke-width: 1
        }

        .fb-grid .nut {
            stroke: var(--ink);
            stroke-width: 3
        }

        .fb-note circle {
            fill: var(--ink)
        }

        .fb-note text {
            font-size: 10px;
            font-weight: 700;
            fill: var(--paper)
        }

        .foot {
            margin: 30px 0 60px;
            font-size: 12px;
            color: var(--muted)
        }
    </style>
</head>

<body>
    <main>
        <div class="topbar">
            <nav class="breadcrumb" aria-label="Miga de pan"><a href="index.html">‚Üê Volver al √≠ndice</a></nav>
            <button class="theme-toggle" id="themeToggle" type="button" title="Cambiar tema">üåì</button>
        </div>

        <header>
            <h1>The Daily Chord</h1>
            <div class="subtitle">Un acorde por d√≠a</div>
        </header>

        <details class="panel" open>
            <summary>Controles</summary>
            <div class="panel-body">
                <div class="controls" role="group" aria-label="Controles del or√°culo">
                    <div class="row">
                        <button id="btnToday" class="primary" type="button">Hoy</button>
                        <button id="btnRandom" type="button">Aleatorio</button>
                        <button id="btnShare" type="button">Compartir / Copiar</button>
                    </div>
                    <div class="row">
                        <label for="pickDate">Otra fecha:</label>
                        <input type="date" id="pickDate" />
                        <button id="btnGo" type="button">Ver</button>
                    </div>
                </div>
            </div>
        </details>

        <section class="result" aria-live="polite">
            <div class="kicker" id="dateLabel">Hoy</div>
            <div class="big" id="chordText">‚Äî</div>
            <div class="meta" id="metaTags"></div>
            <p class="mood" id="moodLine">‚Äî</p>
        </section>

        <section class="fretcard" aria-label="Diapas√≥n con el acorde">
            <div class="kicker">Diapas√≥n</div>
            <div id="fretboard"></div>
            <!--<div class="legend">Strings (6‚Üí1) a la izquierda ¬∑ Frets indicados arriba. R = root ¬∑ 3/b3 ¬∑ 5 ¬∑ 7/b7.</div>-->
        </section>

        <p class="foot">¬© Contumance</p>
    </main>

    <!-- Toggle de tema -->
    <script>
        (function () {
            var KEY = 'theme-preference';
            var root = document.documentElement; var btn = document.getElementById('themeToggle');
            function apply(mode) { root.classList.toggle('theme-dark', mode === 'dark'); btn.textContent = '‚óë'; }
            function preferred() {
                var s = localStorage.getItem(KEY); if (s === 'light' || s === 'dark') return s;
                return (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
            }
            var current = preferred(); apply(current);
            btn.addEventListener('click', function () {
                current = current === 'dark' ? 'light' : 'dark';
                localStorage.setItem(KEY, current); apply(current);
            });
        })();
    </script>

    <!-- L√≥gica del or√°culo + diapas√≥n (cifrado americano y ra√≠z robusta) -->
    <script>
        // D√≠a del a√±o
        function dayOfYear(d) { var s = new Date(d.getFullYear(), 0, 1); return Math.floor((d - s) / 86400000) + 1; }

        // Familia por mes
        function monthFamily(m) {
            if (m >= 1 && m <= 3) return 'major'; if (m >= 4 && m <= 6) return 'minor';
            if (m >= 7 && m <= 9) return 'diminished'; return 'dominant';
        }

        // Ra√≠z por d√≠a de semana (0=Domingo..6=S√°bado) ‚Äî evita problemas de locale
        const ROOTS_BY_DAY = ["C", "D", "E", "F", "G", "A", "B"];

        // Notas y grados
        const NOTE_PC = { "C": 0, "C#": 1, "D": 2, "D#": 3, "E": 4, "F": 5, "F#": 6, "G": 7, "G#": 8, "A": 9, "A#": 10, "B": 11 };
        const STD_TUNING = [40, 45, 50, 55, 59, 64]; // E2 A2 D3 G3 B3 E4
        const STRING_NAMES = ['6(E)', '5(A)', '4(D)', '3(G)', '2(B)', '1(e)'];
        const DEG_LABELS = { 0: 'R', 1: '‚ô≠2', 2: '2', 3: '‚ô≠3', 4: '3', 5: '4', 6: '‚ô≠5', 7: '5', 8: '‚ôØ5', 9: '6', 10: '‚ô≠7', 11: '7' };

        // Intervalos b√°sicos seg√∫n familia (simple y legible)
        function qualityToIntervals(family) {
            if (family === 'major') return [0, 4, 7];
            if (family === 'minor') return [0, 3, 7];
            if (family === 'diminished') return [0, 3, 6];
            return [0, 4, 7, 10]; // dominant -> 7
        }
        function familyToSymbolSuffix(family) {
            if (family === 'major') return '';         // triada mayor
            if (family === 'minor') return 'm';        // triada menor
            if (family === 'diminished') return 'dim'; // disminuido
            return '7';                             // dominante
        }

        // Selecci√≥n de voicing simple (1 nota por cuerda en ventana de 5 trastes)
        function pickVoicing(pcRoot, intervals, windowStart) {
            var win = 5, out = [];
            for (var s = 0; s < STD_TUNING.length; s++) {
                var midiOpen = STD_TUNING[s], chosen = null, deg = null;
                for (var f = windowStart; f < windowStart + win && f <= 20; f++) {
                    var pc = (midiOpen + f) % 12;
                    for (var k = 0; k < intervals.length; k++) {
                        if (pc === (pcRoot + (intervals[k] % 12) + 12) % 12) { chosen = { string: s, fret: f }; deg = (intervals[k] % 12); break; }
                    }
                    if (chosen) break;
                }
                out.push(chosen ? { string: s, fret: chosen.fret, deg: deg } : null);
            }
            return out;
        }

        // Render del diapas√≥n
        function renderFretboard(rootName, family, nDay) {
            var pcRoot = NOTE_PC[rootName] || 0;
            var intervals = qualityToIntervals(family);
            var start = (nDay % 12) + 1; // desplaza la ventana por d√≠a
            var voicing = pickVoicing(pcRoot, intervals, start);

            var frets = 5, startFret = start, strings = 6, w = frets * 44 + 100, h = strings * 26 + 70;
            var x0 = 70, y0 = 40, dx = 44, dy = 26;
            var svg = ['<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ' + w + ' ' + h + '">'];

            // encabezados
            //svg.push('<text x="' + (x0 + (frets * dx) / 2) + '" y="' + (y0 - 18) + '" font-size="10">Frets ' + startFret + '-' + (startFret + frets - 1) + '</text>');
            //svg.push('<text x="' + (x0 - 55) + '" y="' + (y0 + (strings - 1) * dy / 2) + '" font-size="10" transform="rotate(-90 ' + (x0 - 55) + ',' + (y0 + (strings - 1) * dy / 2) + ')">Strings (6‚Üí1)</text>');

            // grid
            svg.push('<g class="fb-grid">');
            for (var s = 0; s < strings; s++) {
                var y = y0 + s * dy;
                svg.push('<line x1="' + x0 + '" y1="' + y + '" x2="' + (x0 + frets * dx) + '" y2="' + y + '"/>');
                svg.push('<text x="' + (x0 - 15) + '" y="' + (y + 4) + '" font-size="10" text-anchor="end">' + STRING_NAMES[s] + '</text>');
            }
            for (var f = 0; f <= frets; f++) {
                var x = x0 + f * dx; var cls = (startFret + f === 0 ? 'nut' : '');
                svg.push('<line x1="' + x + '" y1="' + (y0 - dy / 2) + '" x2="' + x + '" y2="' + (y0 + (strings - 1) * dy + dy / 2) + '" class="' + cls + '"/>');
                if (f > 0) svg.push('<text x="' + (x - dx / 2) + '" y="' + (y0 - dy / 1.3) + '" font-size="10">' + (startFret + f - 1) + '</text>');
            }
            svg.push('</g>');

            // notas
            svg.push('<g class="fb-note">');
            voicing.forEach(function (v, idx) {
                if (!v) return;
                var cx = x0 + (v.fret - startFret + .5) * dx, cy = y0 + idx * dy, label = DEG_LABELS[(v.deg + 12) % 12] || '‚Ä¢';
                svg.push('<circle cx="' + cx + '" cy="' + cy + '" r="11"/>');
                svg.push('<text x="' + cx + '" y="' + (cy + 3) + '" text-anchor="middle">' + label + '</text>');
            });
            svg.push('</g></svg>');

            document.getElementById('fretboard').innerHTML = svg.join('');
        }

        // UI refs y helpers
        var $ = function (s) { return document.querySelector(s) };
        var dateLabel = $('#dateLabel'), chordText = $('#chordText'), metaTags = $('#metaTags'), moodLine = $('#moodLine'), inputDate = $('#pickDate');
        function tagsRender(items) { metaTags.innerHTML = ''; items.forEach(function (t) { var el = document.createElement('span'); el.className = 'tag'; el.textContent = t; metaTags.appendChild(el); }); }
        function formatDateLong(d) { return d.toLocaleDateString('es-UY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }

        function computeForDate(d) {
            var n = dayOfYear(d);
            var root = ROOTS_BY_DAY[d.getDay()];         // ‚Üê robusto a locale
            var fam = monthFamily(d.getMonth() + 1);     // major / minor / diminished / dominant
            var symbol = root + familyToSymbolSuffix(fam);

            // pintar UI
            dateLabel.textContent = formatDateLong(d);
            chordText.textContent = symbol;
            tagsRender(['D√≠a ' + n, 'Familia: ' + ({ major: 'mayor', minor: 'menor', diminished: 'disminuido', dominant: 'dominante' }[fam])]);
            moodLine.textContent = ({ major: 'Claridad y expansi√≥n.', minor: 'Introspecci√≥n y movimiento interno.', diminished: 'Misterio y tensi√≥n.', dominant: 'Decisi√≥n y empuje. Tensi√≥n lista para resolver.' }[fam]);

            // diapas√≥n
            renderFretboard(root, fam, n);

            // evento externo por si hay integraci√≥n con otra vista
            window.dispatchEvent(new CustomEvent('oracle-chord', { detail: { date: d.toISOString().slice(0, 10), dayOfYear: n, root: root, family: fam, symbol: symbol } }));
        }

        // Controles
        document.getElementById('btnToday').addEventListener('click', function () { computeForDate(new Date()); });
        document.getElementById('btnRandom').addEventListener('click', function () {
            var y = (new Date()).getFullYear(); var start = new Date(y, 0, 1); var rnd = Math.floor(Math.random() * 365);
            var d = new Date(start.getTime() + rnd * 86400000); inputDate.value = d.toISOString().slice(0, 10); computeForDate(d);
        });
        document.getElementById('btnGo').addEventListener('click', function () {
            var v = inputDate.value; if (!v) { alert('Eleg√≠ una fecha.'); return; } var d = new Date(v + 'T12:00:00'); computeForDate(d);
        });
        document.getElementById('btnShare').addEventListener('click', function () {
            var title = 'El Acorde del D√≠a'; var text = chordText.textContent + ' ¬∑ ' + dateLabel.textContent;
            if (navigator.share) { navigator.share({ title: title, text: text }).catch(function () { }); }
            else {
                (navigator.clipboard ? navigator.clipboard.writeText(title + '\n' + text) : Promise.reject())
                .then(function () { alert('Copiado al portapapeles.'); })
                .catch(function () { alert(text); });
            }
        });

        // Init
        (function init() {
            try { var t = new Date(); inputDate.value = t.toISOString().slice(0, 10); computeForDate(t); }
            catch (err) { chordText.textContent = '‚ö†Ô∏è Error de inicializaci√≥n'; console.error(err); }
        })();
    </script>
</body>
</html>
