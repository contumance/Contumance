<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Daily Chord ‚Äî Contumance</title>
  <meta name="description" content="One chord per day as creative inspiration. Minimal e-ink-style UI, dark mode, and an inline fretboard preview." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚ô™</text></svg>">

  <style>
    /* ---- Shared palette & rhythm (matches Scales/Chords) ---- */
    :root{
      --paper:#f5f1e8;      /* paper bg */
      --ink:#2f2a1e;        /* main text */
      --muted:#6b6253;      /* secondary text */
      --link:#2d5842;       /* links */
      --link-visited:#514f7a;
      --accent:#a08a63;     /* borders */
      --rule:#d8d2c2;       /* inner lines */
      --accent-soft:#999;   /* soft markers */
      --maxw:42rem;         /* reading width */
      --radius:14px;
      --lh:1.6;
      --fs-base:18px;
    }
    html.theme-dark{
      --paper:#10110f;
      --ink:#dbd6c9;
      --muted:#a39c8c;
      --link:#a9d0b8;
      --link-visited:#c0b8e0;
      --accent:#2a2b27;
      --rule:#2a2b27;
      --accent-soft:#7f7a6b;
    }

    html{ font-size:var(--fs-base); }
    body{
      margin:0; padding:0;
      color:var(--ink); background:var(--paper);
      line-height:var(--lh);
      font-family: ui-serif, Georgia, "Iowan Old Style", "Palatino Linotype", Palatino, serif;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
    }

    /* subtle paper texture */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.06;
      background-image:
        radial-gradient(circle at 25% 15%, #000 0.5px, transparent 0.5px),
        radial-gradient(circle at 75% 85%, #000 0.5px, transparent 0.5px);
      background-size:3px 3px, 3px 3px;
      mix-blend-mode:multiply;
    }

    main{ max-width:var(--maxw); margin:0 auto; padding:7vh 1.25rem 4rem; }

    /* topbar + breadcrumb matches Scales/Chords */
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem; }
    nav.breadcrumb{ font-size:.95rem; }
    nav.breadcrumb a{
      color:var(--link); text-decoration:none; text-underline-offset:2px;
    }

    h1{ margin:.2rem 0 .3rem 0; font-weight:600; font-size:clamp(1.6rem,4vw,2.2rem); }
    .subtitle{ color:var(--muted); font-size:.95rem; margin-bottom:.8rem; }

    .theme-toggle{
      border:1px solid var(--accent); background:transparent; color:var(--ink);
      border-radius:.45rem; padding:.35rem .55rem; cursor:pointer; font-size:1.15rem; line-height:1;
    }
    .theme-toggle:focus-visible{
      outline:2px dashed var(--accent); outline-offset:2px;
    }

    hr{ border:none; border-top:1px solid var(--accent); margin:1.25rem 0; opacity:.5; }

    /* panel styling */
    details.panel{
      border:1px solid var(--accent);
      border-radius:.6rem;
      background: rgba(255,255,255,0.6);
    }
    html.theme-dark details.panel{ background: rgba(0,0,0,0.1); }
    details.panel>summary{
      cursor:pointer; list-style:none; padding:.6rem .8rem; font-size:.95rem; font-weight:600; color:var(--ink);
    }
    details.panel>summary::-webkit-details-marker{ display:none; }
    details.panel .panel-body{ padding:.6rem .8rem .9rem; }

    /* compact controls (same grid as other pages) */
    .controls{
      display:grid; gap:8px; align-items:center;
      grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
      margin-bottom:8px;
    }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; opacity:.9; }
    button, input[type="date"]{
      appearance:none; border:1px solid var(--accent); background:transparent; color:var(--ink);
      padding:10px 12px; border-radius:.5rem; font-family:inherit; font-size:14px; line-height:1; min-width:0;
      outline:none;
    }
    button.primary{ background:var(--ink); color:var(--paper); border-color:var(--ink); }
    button:focus-visible, input[type="date"]:focus-visible{
      outline:2px dashed var(--accent); outline-offset:2px;
    }

    /* result block */
    .result{
      border:1px solid var(--accent); border-radius:.6rem; padding:.9rem .9rem 1rem; background:transparent; margin-top:12px;
    }
    .kicker{ font-size:.78rem; letter-spacing:.08em; text-transform:uppercase; color:var(--muted); }
    .big{
      font-weight:700; letter-spacing:.02em;
      font-size:clamp(2.2rem,6vw,3rem); line-height:1.08; margin:.2rem 0 .1rem;
    }
    .meta{ display:flex; gap:.5rem; flex-wrap:wrap; margin:.35rem 0; }
    .tag{ border:1px solid var(--accent); border-radius:999px; padding:.2rem .55rem; font-size:.8rem; color:var(--muted); }
    .mood{ color:var(--muted); font-size:.95rem; margin-top:.2rem; }

    /* fretboard card */
    .fretcard{ border:1px solid var(--accent); border-radius:.6rem; padding:.9rem; background:transparent; margin-top:12px; }
    #fretboard{ overflow:auto; text-align:center; }
    .fret svg{ max-width:100%; height:auto; display:block; }

    .legend{ color:var(--muted); font-size:.8rem; margin-top:.5rem; text-align:center; }

    /* mini SVG palette coherence (same fixes used in Chords) */
    .fb-grid line{ stroke:var(--rule); stroke-width:1; }
    .fb-grid .nut{ stroke:var(--ink); stroke-width:3; }
    .fb-grid text { fill: var(--muted); }
    html.theme-dark .fb-grid text { fill: var(--ink); opacity: .85; }
    html.theme-dark .fb-grid line { stroke:#3b3a34; }
    .fb-note circle{ fill:var(--ink); }
    .fb-note text{ font-size:10px; font-weight:700; fill:var(--paper); }

    footer{
      margin-top:2.5rem; font-size:.95rem; color:var(--muted);
      display:flex; gap:.75rem; align-items:center; flex-wrap:wrap
    }
    .btn{border:1px solid var(--accent); padding:.5rem .8rem; border-radius:.35rem; text-decoration:none}
    .note{width:100%; color:var(--muted); font-style:italic; margin-top:.35rem}

    /* Hover underline animation (like index/Scales) */
    @media (prefers-reduced-motion:no-preference){
      a{
        position:relative;
        background-image:linear-gradient(currentColor,currentColor);
        background-position:0 100%;
        background-repeat:no-repeat;
        background-size:0% 1px;
        transition:background-size .25s ease, color .2s ease;
      }
      a:hover, a:focus-visible{ background-size:100% 1px; outline:none; }
    }
  </style>
</head>
<body>
  <main>
    <div class="topbar">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="index.html">‚Üê Back to index</a>
      </nav>
      <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme" title="Toggle theme">üåì</button>
    </div>

    <header>
      <h1>The Daily Chord</h1>
      <div class="subtitle">One chord per day.</div>
    </header>

    <details class="panel" open>
      <summary>Controls</summary>
      <div class="panel-body">
        <div class="controls" role="group" aria-label="Daily chord controls">
          <div class="row">
            <button id="btnToday" class="primary" type="button">Today</button>
            <button id="btnRandom" type="button">Random</button>
            <button id="btnShare" type="button">Share / Copy</button>
          </div>
          <div class="row">
            <label for="pickDate">Pick a date:</label>
            <input type="date" id="pickDate" />
            <button id="btnGo" type="button">Show</button>
          </div>
        </div>
      </div>
    </details>

    <section class="result" aria-live="polite">
      <div class="kicker" id="dateLabel">Today</div>
      <div class="big" id="chordText">‚Äî</div>
      <div class="meta" id="metaTags"></div>
      <p class="mood" id="moodLine">‚Äî</p>
    </section>

    <section class="fretcard" aria-label="Fretboard for this chord">
      <div class="kicker">Fretboard</div>
      <div id="fretboard"></div>
      <!-- <div class="legend">Strings (6‚Üí1) on the left ¬∑ Fret numbers above. R = root ¬∑ 3/b3 ¬∑ 5 ¬∑ 7/b7.</div> -->
    </section>

    <footer>
      <a class="btn" href="YOUR_CAFECITO_URL" target="_blank" rel="noopener">Invite me a coffee ‚òï</a>
      <span class="note">Fuel the craft. Inspire the next page.</span>
      <span>¬© <span id="y"></span> Contumance</span>
    </footer>
  </main>

  <!-- Theme toggle (same logic as other pages) -->
  <script>
    (function () {
      const KEY = 'theme-preference';
      const root = document.documentElement;
      const btn = document.getElementById('themeToggle');
      function setIcon(mode){ btn.textContent = '‚óë'; }
      function apply(mode){ root.classList.toggle('theme-dark', mode === 'dark'); setIcon(mode); }
      function getPreferred(){
        const saved = localStorage.getItem(KEY);
        if (saved === 'light' || saved === 'dark') return saved;
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      let current = getPreferred(); apply(current);
      btn.addEventListener('click', () => {
        current = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem(KEY, current); apply(current);
      });
    })();
  </script>

  <!-- Oracle logic + fretboard (American notation, robust root, dark-friendly SVG) -->
  <script>
    // Day-of-year
    function dayOfYear(d){ const s = new Date(d.getFullYear(),0,1); return Math.floor((d - s)/86400000) + 1; }

    // Family by month
    function monthFamily(m){
      if (m>=1 && m<=3) return 'major';
      if (m>=4 && m<=6) return 'minor';
      if (m>=7 && m<=9) return 'diminished';
      return 'dominant';
    }

    // Root by weekday (0=Sun..6=Sat) ‚Äî locale-agnostic
    const ROOTS_BY_DAY = ["C","D","E","F","G","A","B"];

    // Pitch classes & helpers
    const NOTE_PC = { "C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11 };
    const STD_TUNING = [40,45,50,55,59,64]; // E2 A2 D3 G3 B3 E4 (low‚Üíhigh)
    const STRING_NAMES = ['6(E)','5(A)','4(D)','3(G)','2(B)','1(e)'];
    const DEG_LABELS = {0:'R',1:'‚ô≠2',2:'2',3:'‚ô≠3',4:'3',5:'4',6:'‚ô≠5',7:'5',8:'‚ôØ5',9:'6',10:'‚ô≠7',11:'7'};

    function qualityToIntervals(f){
      if(f==='major') return [0,4,7];
      if(f==='minor') return [0,3,7];
      if(f==='diminished') return [0,3,6];
      return [0,4,7,10]; // dominant -> 7
    }
    function familyToSymbolSuffix(f){
      if(f==='major') return '';
      if(f==='minor') return 'm';
      if(f==='diminished') return 'dim';
      return '7';
    }

    // Simple closed-position pick (1 note per string within 5-fret window)
    function pickVoicing(pcRoot, intervals, windowStart){
      const win = 5, out = [];
      for(let s=0; s<STD_TUNING.length; s++){
        const midiOpen = STD_TUNING[s];
        let chosen = null, deg = null;
        for(let f=windowStart; f<windowStart+win && f<=20; f++){
          const pc = (midiOpen + f) % 12;
          for(let k=0; k<intervals.length; k++){
            if (pc === (pcRoot + (intervals[k]%12) + 12) % 12){
              chosen = { string:s, fret:f }; deg = (intervals[k]%12); break;
            }
          }
          if(chosen) break;
        }
        out.push(chosen ? { string:s, fret:chosen.fret, deg:deg } : null);
      }
      return out;
    }

    // Fretboard render (dark-mode friendly)
    function renderFretboard(rootName, family, nDay){
      const pcRoot = NOTE_PC[rootName] || 0;
      const intervals = qualityToIntervals(family);
      const start = (nDay % 12) + 1;  // slide window by day
      const voicing = pickVoicing(pcRoot, intervals, start);

      const frets = 5, startFret = start, strings = 6, w = frets*44 + 100, h = strings*26 + 70;
      const x0 = 70, y0 = 40, dx = 44, dy = 26;
      const g = [];
      g.push(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}">`);

      // grid
      g.push(`<g class="fb-grid">`);
      for(let s=0; s<strings; s++){
        const y = y0 + s*dy;
        g.push(`<line x1="${x0}" y1="${y}" x2="${x0 + frets*dx}" y2="${y}" />`);
        g.push(`<text x="${x0-15}" y="${y+4}" font-size="10" text-anchor="end">${STRING_NAMES[s]}</text>`);
      }
      for(let f=0; f<=frets; f++){
        const x = x0 + f*dx;
        const isNut = (startFret===0 && f===1);
        g.push(`<line x1="${x}" y1="${(y0 - dy/2)}" x2="${x}" y2="${(y0 + (strings-1)*dy + dy/2)}" class="${isNut?'nut':''}" />`);
      }
      // fret numbers
      for(let c=0; c<frets; c++){
        const x = x0 + (c+0.5)*dx;
        const label = startFret + c;
        g.push(`<text x="${x}" y="${(y0 - dy/1.3)}" font-size="10" text-anchor="middle">${label}</text>`);
      }
      g.push(`</g>`);

      // notes
      g.push(`<g class="fb-note">`);
      voicing.forEach((v, idx) => {
        if(!v) return;
        const cx = x0 + (v.fret - startFret + .5)*dx;
        const cy = y0 + idx*dy;
        const label = DEG_LABELS[(v.deg+12)%12] || '‚Ä¢';
        g.push(`<circle cx="${cx}" cy="${cy}" r="11"></circle>`);
        g.push(`<text x="${cx}" y="${(cy+3)}" text-anchor="middle">${label}</text>`);
      });
      g.push(`</g></svg>`);

      document.getElementById('fretboard').innerHTML = g.join('');
    }

    // UI refs
    const $ = s => document.querySelector(s);
    const dateLabel = $('#dateLabel'), chordText = $('#chordText'), metaTags = $('#metaTags'), moodLine = $('#moodLine'), inputDate = $('#pickDate');

    function tagsRender(items){
      metaTags.innerHTML = '';
      items.forEach(t => {
        const el = document.createElement('span');
        el.className = 'tag';
        el.textContent = t;
        metaTags.appendChild(el);
      });
    }
    function formatDateLong(d){
      // English long date; adjusts to user's locale time zone automatically
      return d.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    }

    function computeForDate(d){
      const n = dayOfYear(d);
      const root = ROOTS_BY_DAY[d.getDay()];
      const fam = monthFamily(d.getMonth()+1);
      const symbol = root + familyToSymbolSuffix(fam);

      // paint UI
      dateLabel.textContent = formatDateLong(d);
      chordText.textContent = symbol;
      const famLabel = ({major:'major', minor:'minor', diminished:'diminished', dominant:'dominant'}[fam]);
      tagsRender([`Day ${n}`, `Family: ${famLabel}`]);
      moodLine.textContent = ({
        major:'Clarity and expansion.',
        minor:'Introspection and inner movement.',
        diminished:'Mystery and tension.',
        dominant:'Decision and drive. Tension ready to resolve.'
      }[fam]);

      // fretboard
      renderFretboard(root, fam, n);

      // external event hook (if needed)
      window.dispatchEvent(new CustomEvent('oracle-chord', { detail:{
        date: d.toISOString().slice(0,10), dayOfYear: n, root, family: fam, symbol
      }}));
    }

    // Controls
    document.getElementById('btnToday').addEventListener('click', () => computeForDate(new Date()));
    document.getElementById('btnRandom').addEventListener('click', () => {
      const y = (new Date()).getFullYear();
      const start = new Date(y,0,1);
      const rnd = Math.floor(Math.random()*365);
      const d = new Date(start.getTime() + rnd*86400000);
      inputDate.value = d.toISOString().slice(0,10);
      computeForDate(d);
    });
    document.getElementById('btnGo').addEventListener('click', () => {
      const v = inputDate.value;
      if(!v){ alert('Pick a date.'); return; }
      const d = new Date(v + 'T12:00:00');
      computeForDate(d);
    });
    document.getElementById('btnShare').addEventListener('click', () => {
      const title = 'The Daily Chord';
      const text = chordText.textContent + ' ¬∑ ' + dateLabel.textContent;
      if(navigator.share){
        navigator.share({ title, text }).catch(() => {});
      }else{
        (navigator.clipboard ? navigator.clipboard.writeText(title + '\n' + text) : Promise.reject())
          .then(() => { alert('Copied to clipboard.'); })
          .catch(() => { alert(text); });
      }
    });

    // Init
    (function init(){
      try{
        const t = new Date();
        inputDate.value = t.toISOString().slice(0,10);
        computeForDate(t);
      }catch(err){
        chordText.textContent = '‚ö†Ô∏è Initialization error';
        console.error(err);
      }
    })();
  </script>
</body>
</html>